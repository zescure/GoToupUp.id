<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Zestore – Top Up Saldo (Duitku Sandbox)</title>
<style>
  :root { --bg:#0f1115; --card:#161a22; --muted:#9aa3b2; --text:#e8edf3; --acc:#4da3ff; --ok:#20c997; --warn:#ffb020; --err:#ff6b6b; }
  * { box-sizing:border-box; }
  body { margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial, "Apple Color Emoji","Segoe UI Emoji"; background:linear-gradient(180deg,#0d1117 0%, #0f1115 100%); color:var(--text);}
  .wrap { max-width:860px; margin:40px auto; padding:20px; }
  .card { background:var(--card); border:1px solid #222736; border-radius:14px; padding:22px; box-shadow: 0 10px 30px rgba(0,0,0,.25); }
  h1 { font-size:22px; margin:0 0 10px; }
  p.lead { color:var(--muted); margin:0 0 14px; }
  form { display:grid; grid-template-columns:1fr 1fr; gap:14px; margin-top:14px; }
  label { font-size:13px; color:#b9c2d0; }
  input, select { width:100%; padding:12px 12px; background:#0e121a; color:var(--text); border:1px solid #232a3a; border-radius:10px; outline:none; }
  input::placeholder{color:#6b768a;}
  .row-1 { grid-column:1/-1; }
  .btn { cursor:pointer; border:0; padding:12px 16px; border-radius:10px; font-weight:600; }
  .btn-primary { background:var(--acc); color:#0b1220; }
  .btn-ghost { background:transparent; border:1px solid #2b3346; color:#cdd5e3; }
  .btn + .btn { margin-left:10px; }
  .actions { display:flex; align-items:center; gap:10px; margin-top:6px; }
  .status { margin-top:16px; padding:12px 14px; border-radius:10px; background:#0e141d; border:1px dashed #2b3346; color:#cdd5e3; font-size:14px; }
  .grid { display:grid; grid-template-columns: 2fr 1fr; gap:16px; margin-top:16px; }
  .panel { background:#0e121a; border:1px solid #20283a; border-radius:12px; padding:14px; }
  .panel h3 { margin:0 0 10px; font-size:16px; }
  .qrbox { display:flex; align-items:center; justify-content:center; min-height:280px; border:1px dashed #2b3346; border-radius:12px; }
  .muted { color:var(--muted); font-size:13px; }
  code { background:#0b0f16; border:1px solid #1c2434; padding:2px 6px; border-radius:6px; }
  .pill { display:inline-block; padding:6px 10px; border-radius:999px; font-size:12px; border:1px solid #2b3346; color:#cdd5e3; }
  .ok{ color:var(--ok); } .warn{ color:var(--warn);} .err{ color:var(--err);}
  footer { margin-top:18px; color:#7f8aa3; font-size:12px; text-align:center; }
  @media (max-width:820px){ .grid{grid-template-columns:1fr;} form{grid-template-columns:1fr;} }
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>Top Up Saldo Zestore (QRIS – Duitku Sandbox)</h1>
    <p class="lead">Nominal dan order akan otomatis dibuat jadi <b>QRIS dinamis</b>. Setelah bayar, <span class="pill">Duitku → Callback</span> ke <code>/.netlify/functions/callback</code> buat update status.</p>

    <form id="payForm">
      <div>
        <label>Nominal (Rp)</label>
        <input id="amount" type="number" value="32500" min="1000" step="500" required />
      </div>

      <div>
        <label>Email Pelanggan</label>
        <input id="email" type="email" placeholder="nama@email.com" required />
      </div>

      <div class="row-1">
        <label>Deskripsi Produk</label>
        <input id="product" type="text" value="Top Up MLBB 28 DM" />
      </div>

      <div class="row-1 actions">
        <button class="btn btn-primary" type="submit">Buat QRIS (Sandbox)</button>
        <button class="btn btn-ghost" id="btnStatus" type="button" disabled>Cek Status</button>
        <span id="orderInfo" class="muted"></span>
      </div>
    </form>

    <div class="grid">
      <div class="panel">
        <h3>QRIS / Link Pembayaran</h3>
        <div id="qrWrap" class="qrbox">
          <div class="muted">QRIS akan tampil di sini setelah inquiry sukses.</div>
        </div>
        <div id="payAlt" style="margin-top:10px;"></div>
      </div>

      <div class="panel">
        <h3>Status</h3>
        <div id="statusBox" class="status">Belum ada transaksi.</div>

        <h3 style="margin-top:14px;">Info Teknis</h3>
        <div class="status muted" id="techBox">
          Merchant Code: <code>DS24540</code><br />
          Endpoint Inquiry: <code>https://sandbox.duitku.com/webapi/api/merchant/v2/inquiry</code><br />
          Endpoint Status: <code>https://sandbox.duitku.com/webapi/api/merchant/transactionStatus</code><br />
          Callback: <code>https://zestore.netlify.app/.netlify/functions/callback</code>
        </div>
      </div>
    </div>

    <footer>⚠️ Demo Sandbox. Jangan pakai API key ini di production.</footer>
  </div>
</div>

<script>
/* ========= MD5 (mini implementation for browser) ========= */
/* Source: Public-domain style compact MD5 implementation */
function md5cycle(x, k) {
  let [a,b,c,d]=x;
  a=ff(a,b,c,d,k[0],7,-680876936); d=ff(d,a,b,c,k[1],12,-389564586);
  c=ff(c,d,a,b,k[2],17,606105819);  b=ff(b,c,d,a,k[3],22,-1044525330);
  a=ff(a,b,c,d,k[4],7,-176418897);  d=ff(d,a,b,c,k[5],12,1200080426);
  c=ff(c,d,a,b,k[6],17,-1473231341);b=ff(b,c,d,a,k[7],22,-45705983);
  a=ff(a,b,c,d,k[8],7,1770035416);  d=ff(d,a,b,c,k[9],12,-1958414417);
  c=ff(c,d,a,b,k[10],17,-42063);    b=ff(b,c,d,a,k[11],22,-1990404162);
  a=ff(a,b,c,d,k[12],7,1804603682); d=ff(d,a,b,c,k[13],12,-40341101);
  c=ff(c,d,a,b,k[14],17,-1502002290);b=ff(b,c,d,a,k[15],22,1236535329);

  a=gg(a,b,c,d,k[1],5,-165796510);  d=gg(d,a,b,c,k[6],9,-1069501632);
  c=gg(c,d,a,b,k[11],14,643717713); b=gg(b,c,d,a,k[0],20,-373897302);
  a=gg(a,b,c,d,k[5],5,-701558691);  d=gg(d,a,b,c,k[10],9,38016083);
  c=gg(c,d,a,b,k[15],14,-660478335);b=gg(b,c,d,a,k[4],20,-405537848);
  a=gg(a,b,c,d,k[9],5,568446438);   d=gg(d,a,b,c,k[14],9,-1019803690);
  c=gg(c,d,a,b,k[3],14,-187363961); b=gg(b,c,d,a,k[8],20,1163531501);
  a=gg(a,b,c,d,k[13],5,-1444681467);d=gg(d,a,b,c,k[2],9,-51403784);
  c=gg(c,d,a,b,k[7],14,1735328473); b=gg(b,c,d,a,k[12],20,-1926607734);

  a=hh(a,b,c,d,k[5],4,-378558);     d=hh(d,a,b,c,k[8],11,-2022574463);
  c=hh(c,d,a,b,k[11],16,1839030562);b=hh(b,c,d,a,k[14],23,-35309556);
  a=hh(a,b,c,d,k[1],4,-1530992060); d=hh(d,a,b,c,k[4],11,1272893353);
  c=hh(c,d,a,b,k[7],16,-155497632); b=hh(b,c,d,a,k[10],23,-1094730640);
  a=hh(a,b,c,d,k[13],4,681279174);  d=hh(d,a,b,c,k[0],11,-358537222);
  c=hh(c,d,a,b,k[3],16,-722521979); b=hh(b,c,d,a,k[6],23,76029189);
  a=ii(a,b,c,d,k[0],6,-198630844);  d=ii(d,a,b,c,k[7],10,1126891415);
  c=ii(c,d,a,b,k[14],15,-1416354905);b=ii(b,c,d,a,k[5],21,-57434055);
  a=ii(a,b,c,d,k[12],6,1700485571); d=ii(d,a,b,c,k[3],10,-1894986606);
  c=ii(c,d,a,b,k[10],15,-1051523);  b=ii(b,c,d,a,k[1],21,-2054922799);
  a=ii(a,b,c,d,k[8],6,1873313359);  d=ii(d,a,b,c,k[15],10,-30611744);
  c=ii(c,d,a,b,k[6],15,-1560198380);b=ii(b,c,d,a,k[13],21,1309151649);

  x[0]=add32(a,x[0]); x[1]=add32(b,x[1]); x[2]=add32(c,x[2]); x[3]=add32(d,x[3]);
}
function cmn(q,a,b,x,s,t){a=add32(add32(a,q),add32(x,t));return add32((a<<s)|(a>>>(32-s)),b)}
function ff(a,b,c,d,x,s,t){return cmn((b&c)|((~b)&d),a,b,x,s,t)}
function gg(a,b,c,d,x,s,t){return cmn((b&d)|(c&(~d)),a,b,x,s,t)}
function hh(a,b,c,d,x,s,t){return cmn(b^c^d,a,b,x,s,t)}
function ii(a,b,c,d,x,s,t){return cmn(c^(b|(~d)),a,b,x,s,t)}
function md51(s){txt='';const n=s.length;const state=[1732584193,-271733879,-1732584194,271733878];let i;
  for(i=64;i<=n;i+=64){md5cycle(state, md5blk(s.substring(i-64,i)))} s=s.substring(i-64); const tail=new Array(16).fill(0);
  for(i=0;i<s.length;i++) tail[i>>2]|=s.charCodeAt(i)<<((i%4)<<3); tail[i>>2]|=0x80<<((i%4)<<3);
  if(i>55){ md5cycle(state, tail); for(i=0;i<16;i++) tail[i]=0; }
  tail[14]=n*8; md5cycle(state, tail); return state;
}
function md5blk(s){const md5blks=[]; for(let i=0;i<64;i+=4){md5blks[i>>2]=s.charCodeAt(i)+(s.charCodeAt(i+1)<<8)+(s.charCodeAt(i+2)<<16)+(s.charCodeAt(i+3)<<24)} return md5blks}
function rhex(n){let s='', j; for(j=0;j<4;j++) s+=((n>>>(j*8+4))&0x0F).toString(16)+((n>>>(j*8))&0x0F).toString(16); return s}
function hex(x){for(let i=0;i<x.length;i++) x[i]=rhex(x[i]); return x.join('')}
function md5(s){return hex(md51(s))}
function add32(a,b){return (a+b)&0xFFFFFFFF}
/* ========= end MD5 ========= */

const DUITKU = {
  baseInquiry: "https://sandbox.duitku.com/webapi/api/merchant/v2/inquiry",
  baseStatus:  "https://sandbox.duitku.com/webapi/api/merchant/transactionStatus",
  merchantCode: "DS24540", // merchant code lu
  apiKey: "YOUR_API_KEY_DUITKU", // GANTI dengan sandbox API key lu
  callbackUrl: "https://zestore.netlify.app/.netlify/functions/callback",
  returnUrl: "https://zestore.netlify.app/home"
};

const el = {
  form: document.getElementById('payForm'),
  amount: document.getElementById('amount'),
  email: document.getElementById('email'),
  product: document.getElementById('product'),
  status: document.getElementById('statusBox'),
  qrWrap: document.getElementById('qrWrap'),
  payAlt: document.getElementById('payAlt'),
  btnStatus: document.getElementById('btnStatus'),
  orderInfo: document.getElementById('orderInfo')
};

let lastOrderId = null;
let lastAmount = null;

el.form.addEventListener('submit', async (e) => {
  e.preventDefault();
  el.status.innerHTML = 'Membuat QRIS…';
  el.qrWrap.innerHTML = '<div class="muted">Memuat…</div>';
  el.payAlt.innerHTML = '';

  const paymentAmount = Number(el.amount.value);
  const email = el.email.value.trim() || 'customer@test.com';
  const productDetails = el.product.value.trim() || 'Top Up Zestore';
  const merchantOrderId = 'INV-' + Date.now();

  // signature: md5(merchantCode + merchantOrderId + amount + apiKey)
  const signature = md5(DUITKU.merchantCode + merchantOrderId + paymentAmount + DUITKU.apiKey);

  const payload = {
    merchantCode: DUITKU.merchantCode,
    paymentAmount,
    merchantOrderId,
    productDetails,
    email,
    callbackUrl: DUITKU.callbackUrl,
    returnUrl: DUITKU.returnUrl,
    signature
  };

  try {
    const res = await fetch(DUITKU.baseInquiry, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    const data = await res.json();
    console.log('Inquiry result:', data);

    // tampilkan info order
    el.orderInfo.textContent = `Order: ${merchantOrderId} • Rp${paymentAmount.toLocaleString('id-ID')}`;
    lastOrderId = merchantOrderId;
    lastAmount = paymentAmount;
    el.btnStatus.disabled = false;

    // Beberapa kemungkinan field dari Duitku:
    // - data.qrString (base64 png)
    // - data.qrUrl atau data.paymentUrl
    // Tampilkan yang tersedia
    let shown = false;

    if (data.qrString) {
      const img = new Image();
      img.alt = 'QRIS';
      img.style.maxWidth = '100%';
      img.style.borderRadius = '12px';
      img.src = 'data:image/png;base64,' + data.qrString;
      el.qrWrap.innerHTML = '';
      el.qrWrap.appendChild(img);
      shown = true;
      el.status.innerHTML = 'QRIS dibuat. Silakan scan & bayar. <span class="warn">Menunggu pembayaran…</span>';
    }

    if (!shown && (data.qrUrl || data.paymentUrl)) {
      const url = data.qrUrl || data.paymentUrl;
      el.qrWrap.innerHTML = '<div class="muted">QR base64 tidak tersedia. Gunakan tombol di bawah.</div>';
      const a = document.createElement('a');
      a.href = url;
      a.target = '_blank';
      a.rel = 'noopener';
      a.className = 'btn btn-primary';
      a.textContent = 'Buka Link Pembayaran';
      el.payAlt.appendChild(a);
      el.status.innerHTML = 'Link pembayaran tersedia. <span class="warn">Menunggu pembayaran…</span>';
      shown = true;
    }

    if (!shown) {
      el.qrWrap.innerHTML = '<div class="muted">Gagal mendapatkan QR/Link dari sandbox. Cek console log.</div>';
      el.status.innerHTML = '<span class="err">Gagal membuat QRIS</span>';
    }
  } catch (err) {
    console.error(err);
    el.status.innerHTML = '<span class="err">Error membuat pembayaran. Coba lagi.</span>';
    el.qrWrap.innerHTML = '<div class="muted">—</div>';
  }
});

// Cek Status (manual polling – opsional, selain nunggu callback)
el.btnStatus.addEventListener('click', async () => {
  if (!lastOrderId) return;
  el.status.innerHTML = 'Cek status transaksi…';

  // signature status: md5(merchantCode + merchantOrderId + apiKey) — (format status bisa berbeda per versi API)
  const sigStatus = md5(DUITKU.merchantCode + lastOrderId + DUITKU.apiKey);

  const payload = {
    merchantCode: DUITKU.merchantCode,
    merchantOrderId: lastOrderId,
    signature: sigStatus
  };

  try {
    const res = await fetch(DUITKU.baseStatus, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    const data = await res.json();
    console.log('Status result:', data);

    // Contoh interpretasi
    // resultCode "00" = sukses, lainnya pending/gagal
    if (data.resultCode === "00" || data.status === "SUCCESS") {
      el.status.innerHTML = '<span class="ok">Pembayaran berhasil.</span> Referensi: ' + (data.reference || '-');
    } else if (data.resultCode === "01" || data.status === "PENDING") {
      el.status.innerHTML = '<span class="warn">Masih menunggu pembayaran…</span>';
    } else {
      el.status.innerHTML = '<span class="err">Gagal / Kadaluarsa.</span>';
    }
  } catch (err) {
    console.error(err);
    el.status.innerHTML = '<span class="err">Gagal cek status (sandbox).</span>';
  }
});
</script>
</body>
</html>
