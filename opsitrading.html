<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>RazozBill Trade ‚Äî Candlestick (USD) + CoinGecko</title>

<!-- style: gunakan style dari versi sebelumnya (dipadatkan sedikit) -->
<style>
  :root{
    --bg:#0f1720; --panel:#0b1220; --muted:#9199a6; --accent:#2dd4bf; --green:#22c55e; --red:#fb7185;
    --card:#07101a; --glass: rgba(255,255,255,0.03);
  }
  *{box-sizing:border-box;font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;color:inherit}
  html,body{height:100%;margin:0;background:linear-gradient(180deg,#07121a 0%, #071628 100%);color:#e6eef6;overflow-x:hidden;-webkit-font-smoothing:antialiased}
  .topbar{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;background:transparent;gap:12px;max-width:1200px;margin:0 auto;}
  .left-top{display:flex;align-items:center;gap:12px;min-width:0}
  .badge-live{background:#064e3b;color:var(--accent);padding:6px 10px;border-radius:8px;font-weight:700;display:flex;align-items:center;gap:8px;white-space:nowrap; cursor:pointer}
  .badge-live.demo{background:#334155;color:#fff;}
  .balance-pill{background:var(--panel);padding:8px 12px;border-radius:10px;font-weight:700;display:flex;gap:8px;align-items:center;white-space:nowrap}
  .deposit-btn{background:linear-gradient(90deg,#10b981,#059669);border:none;padding:10px 14px;border-radius:10px;color:#fff;font-weight:700;cursor:pointer;white-space:nowrap}
  .container{max-width:1200px;margin:12px auto;padding:12px;display:grid;grid-template-columns: 1fr 360px;gap:12px;width:100%;}
  .main-card{background:var(--card);border-radius:12px;padding:12px;box-shadow:0 6px 24px rgba(2,6,23,0.6);min-height:420px;overflow:hidden;}
  .side-card{background:var(--card);border-radius:12px;padding:12px;box-shadow:0 6px 24px rgba(2,6,23,0.6);min-height:420px;overflow:auto}
  .chart-top{display:flex;justify-content:space-between;align-items:center;gap:8px;margin-bottom:8px;flex-wrap:wrap}
  .pair-info{display:flex;gap:12px;align-items:center;min-width:0}
  .pair-title{font-weight:800;font-size:18px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .payout-pill{background:rgba(255,255,255,0.03);padding:6px 10px;border-radius:8px;font-weight:700;color:#fff;white-space:nowrap}
  #chartContainer{height:320px;border-radius:8px;background:linear-gradient(180deg,#07101a,#081627);padding:8px}
  .chart-footer{display:flex;justify-content:space-between;align-items:center;margin-top:8px;gap:8px;flex-wrap:wrap}
  .time-select{background:var(--glass);border:1px solid rgba(255,255,255,0.04);padding:6px;border-radius:8px;color:var(--muted);min-width:80px}
  .big-controls{display:flex;gap:12px;align-items:flex-start;margin-top:12px;flex-wrap:wrap}
  .big-left{flex:1;display:flex;flex-direction:column;gap:8px;min-width:220px}
  .big-right{flex-basis:320px;display:flex;flex-direction:column;gap:8px;transition:transform 220ms ease, box-shadow 220ms ease;}
  .input-box{background:#06101a;border:1px solid rgba(255,255,255,0.03);padding:10px;border-radius:8px;color:var(--muted);width:100%}
  .price-row{display:flex;justify-content:space-between;align-items:center;}
  .btn-down{flex:1;padding:14px;border-radius:10px;background:linear-gradient(180deg,#ff7b7b,#ff6b6b);border:none;color:#fff;font-weight:800;font-size:18px;cursor:pointer;min-width:120px}
  .btn-up{flex:1;padding:14px;border-radius:10px;background:linear-gradient(180deg,#22c55e,#16a34a);border:none;color:#05201a;font-weight:800;font-size:18px;cursor:pointer;min-width:120px}
  .muted-small{color:var(--muted);font-size:13px;white-space:nowrap}
  .tabs{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap}
  .tab{padding:8px 12px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.03);cursor:pointer;color:var(--muted);}
  .tab.active{background:linear-gradient(90deg,#0f1724,#06202a);border:1px solid rgba(255,255,255,0.06);color:#fff;}
  .history-list{margin-top:10px;max-height:220px;overflow:auto;padding-right:6px}
  .history-item{display:flex;justify-content:space-between;padding:8px;border-bottom:1px solid rgba(255,255,255,0.02);font-size:13px}
  .status-badge{padding:4px 8px;border-radius:6px;font-weight:700;font-size:12px}
  .status-pending{background:rgba(255,193,7,0.12);color:#ffb020}
  .status-confirmed{background:rgba(34,197,94,0.12);color:var(--green)}
  .status-rejected{background:rgba(239,68,68,0.08);color:var(--red)}
  .admin-controls{margin-top:12px;padding:8px;background:rgba(255,255,255,0.02);border-radius:8px;}
  .market-edit{display:flex;gap:8px;align-items:center;margin-top:8px;flex-wrap:wrap}
  .market-edit input{padding:6px;border-radius:6px;background:#06101a;border:1px solid rgba(255,255,255,0.03);color:#fff}
  .save-btn{padding:6px 10px;border-radius:8px;background:#0ea5a4;border:none;color:#012;cursor:pointer}
  .chart-meta{display:flex;gap:12px;align-items:center;color:var(--muted);font-size:13px}
  @media (max-width:1000px){
    .container{grid-template-columns:1fr;}
    .big-right{flex-basis:100%}
    .side-card{order:2}
    .main-card{order:1}
    .pair-title{font-size:16px}
  }
</style>
</head>
<body>
  <div class="topbar">
    <div class="left-top">
      <div class="badge-live" id="badgeLive">LIVE</div>
      <div style="color:var(--muted);font-size:13px">UTC+7 ‚Ä¢ <span id="clock">--:--:--</span></div>
      <span id="balanceTop" style="display:none">0.00</span>
    </div>
    <div style="display:flex;gap:12px;align-items:center">
      <button class="deposit-btn" id="openDeposit">+</button>
      <div class="balance-pill">Saldo: <span id="balance" style="margin-left:8px">0.00</span></div>
    </div>
  </div>

  <div class="container">
    <div class="main-card">
      <div class="chart-top">
        <div class="pair-info">
          <div style="width:48px;height:48px;border-radius:8px;background:linear-gradient(180deg,#0b1220,#06101a);display:flex;align-items:center;justify-content:center;font-weight:800">üïØÔ∏è</div>
          <div style="min-width:0">
            <div class="pair-title" id="pairTitle">Memuat market...</div>
            <div class="muted-small" id="pairSub">‚Äî <span id="lockedLabel"></span></div>
          </div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <div class="payout-pill" id="payoutLabel">‚Äî%</div>
          <select id="symbolSelectTop" class="time-select"></select>
          <div style="width:160px;text-align:right;">
            <div style="font-size:12px;color:var(--muted)">Harga sekarang</div>
            <div style="font-weight:800;font-size:18px" id="currentPriceLarge">-</div>
            <div class="chart-meta"><span id="priceChange">‚Äî</span><span id="priceSmallHint">USD</span></div>
          </div>
        </div>
      </div>

      <div id="chartContainer"></div>

      <div class="chart-footer">
        <div style="display:flex;gap:8px;align-items:center;">
          <select id="daysSelect" class="time-select">
            <option value="1">1d</option>
            <option value="7">7d</option>
            <option value="14">14d</option>
            <option value="30">30d</option>
          </select>
          <div class="muted-small">Durasi trade: <span id="currDur">60</span>s</div>
        </div>
        <div class="muted-small">Perdagangan opsi ‚Äî data real crypto (CoinGecko) ‚Ä¢ USD.</div>
      </div>

      <!-- controls (sama fungsi trading sebelumnya) -->
      <div class="big-controls">
        <div class="big-left">
          <div style="display:flex;gap:8px;flex-wrap:wrap;">
            <div style="flex:1;min-width:150px">
              <div class="muted-small">Waktu kedaluwarsa</div>
              <input id="durationInput" class="input-box" type="text" value="00:01:00">
            </div>
            <div style="width:180px;min-width:120px">
              <div class="muted-small">Nominal (Rp)</div>
              <input id="betAmount" class="input-box" type="number" min="14900" value="14000">
            </div>
          </div>

          <div style="display:flex;gap:12px;align-items:center;margin-top:10px;">
            <div class="muted-small">Pembayaran:</div>
            <div id="paymentLabel" style="font-weight:800">‚Äî Rp</div>
            <div style="margin-left:12px;color:var(--muted);font-size:13px" id="payoutInfo">Keuntungan ‚Äî</div>
          </div>

          <div class="tabs">
            <div class="tab active" id="tabOpenTrades">Trade Terbuka</div>
            <div class="tab" id="tabTradeHistory">Trade History</div>
            <div class="tab" id="tabRequests">Withdraw</div>
          </div>

          <div class="history-list" id="listOpenTrades"></div>
          <div class="history-list" id="listTrades" style="display:none"></div>
          <div class="history-list" id="listRequests" style="display:none"></div>

        </div>

        <div class="big-right" id="bigRight">
          <div style="display:flex;flex-direction:column;gap:10px;">
            <div style="display:flex;gap:8px;align-items:center;">
              <button class="btn-down" id="btnDown">TURUN</button>
              <button class="btn-up" id="btnUp">NAIK</button>
            </div>

            <div style="background:transparent;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);">
              <div style="display:flex;justify-content:space-between;align-items:center;">
                <div style="font-weight:800">Ringkasan Transaksi</div>
                <div style="font-size:12px;color:var(--muted)">Minimal Rp 15.000</div>
              </div>
              <div style="margin-top:8px;display:flex;flex-direction:column;gap:6px">
                <div class="price-row"><div class="muted-small">Nominal Trade</div><div id="summaryBet">Rp 14,000</div></div>
                <div class="price-row"><div class="muted-small">Probabilitas / Payout</div><div id="summaryPayout">‚Äî%</div></div>
                <div class="price-row"><div class="muted-small">Potensi Keuntungan</div><div id="summaryPotential">‚Äî Rp</div></div>
                <div class="price-row"><div class="muted-small">Saldo Terakhir</div><div id="summaryBalance">Rp 0</div></div>
              </div>
            </div>

            <div style="background:transparent;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);">
              <div style="display:flex;justify-content:space-between;align-items:center;">
                <div style="font-weight:800">Deposit / Withdraw</div>
                <button id="openDeposit2" class="deposit-btn" style="padding:6px 10px;font-size:13px">Deposit</button>
              </div>
              <div style="margin-top:8px;color:var(--muted);font-size:13px">Ganti Ke Akun Demo Klik Pnel Hijau DiKiri Atas</div>
              <div style="margin-top:8px" id="miniRequests"></div>
            </div>

            <div id="adminInline" style="display:none;">
              <div class="admin-controls">
                <div style="font-weight:800">Admin ‚Äî Edit Market</div>
                <div id="adminMarketsContainer"></div>
              </div>
            </div>

          </div>
        </div>
      </div>

    </div>

    <div class="side-card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div style="font-weight:800">Akun</div>
        <div style="color:var(--muted)">UID: <span id="uidLabel">-</span></div>
      </div>

      <div style="background:rgba(255,255,255,0.02);padding:12px;border-radius:8px;margin-bottom:12px;">
        <div style="font-size:13px;color:var(--muted)">Saldo Real</div>
        <div style="font-weight:800;font-size:20px;margin-top:6px">Rp <span id="balanceMain">0.00</span></div>
        <div style="margin-top:8px;color:var(--muted)">Riwayat deposit & withdraw </div>
      </div>

      <div style="font-weight:800;margin-bottom:8px">Deposit / Withdraw Requests</div>
      <div id="sideRequestsList" style="max-height:200px;overflow:auto"></div>

      <div style="margin-top:12px;font-weight:800">Trade History (Ringkas)</div>
      <div id="sideTradeList" style="max-height:200px;overflow:auto;margin-top:8px"></div>

      <div id="adminPanel" style="margin-top:12px;display:none;">
        <h3 style="margin:0 0 8px 0">Admin Panel ‚Äî Requests</h3>
        <div id="requestsList"></div>
      </div>

    </div>
  </div>

  <!-- libs -->
  <!-- Lightweight Charts (standalone) -->
  <script src="https://unpkg.com/lightweight-charts@4.0.0/dist/lightweight-charts.standalone.production.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

<script>
/* ================= CONFIG ================= */
const firebaseConfig = {
  apiKey: "AIzaSyDVUEZ3ZVmH4ld7LVnEq_L368wEJpEs-l8",
  authDomain: "zeepaylater-93a94.firebaseapp.com",
  projectId: "zeepaylater-93a94",
  storageBucket: "zeepaylater-93a94.appspot.com",
  messagingSenderId: "358065954807",
  appId: "1:358065954807:web:66619211fea82a4b2518f2"
};
const ADMIN_UID = 'viCOsJo4wHVFmhtpmMx1Wd4sDF52';
const DEPOSIT_URL = 'https://zestore.netlify.app/depositop1';
/* ========================================== */

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

/* ====== GLOBAL STATE & UI EL ====== */
let currentUser = null;
let isAdmin = false;
let markets = {};            // key: SYMBOL/ID => { cgId, symbol, name, ... }
let currentMarketId = null;

const COINGECKO_BASE = 'https://api.coingecko.com/api/v3';
let CG_VS_CURRENCY = 'usd'; // user wanted USD
const PRICE_POLL_INTERVAL = 5000; // 5s
const HISTORY_MINUTES = 60; // show last 60 minutes candlesticks by default

/* UI elements */
const pairTitle = document.getElementById('pairTitle');
const pairSub = document.getElementById('pairSub');
const payoutLabel = document.getElementById('payoutLabel');
const currentPriceLarge = document.getElementById('currentPriceLarge');
const priceChangeEl = document.getElementById('priceChange');
const priceSmallHint = document.getElementById('priceSmallHint');
const symbolSelectTop = document.getElementById('symbolSelectTop');
const daysSelect = document.getElementById('daysSelect');

const btnUp = document.getElementById('btnUp');
const btnDown = document.getElementById('btnDown');
const betAmountInput = document.getElementById('betAmount');
const durationInput = document.getElementById('durationInput');

/* Trading / persistence elements (keperluan tetap) */
const tabOpenTrades = document.getElementById('tabOpenTrades');
const tabTradeHistory = document.getElementById('tabTradeHistory');
const tabRequests = document.getElementById('tabRequests');
const listOpenTrades = document.getElementById('listOpenTrades');
const listTrades = document.getElementById('listTrades');
const listRequests = document.getElementById('listRequests');
const balanceEl = document.getElementById('balance');
const balanceMain = document.getElementById('balanceMain');
const uidLabel = document.getElementById('uidLabel');
const summaryBet = document.getElementById('summaryBet');
const summaryPayout = document.getElementById('summaryPayout');
const summaryPotential = document.getElementById('summaryPotential');
const summaryBalance = document.getElementById('summaryBalance');
const payoutInfo = document.getElementById('payoutInfo');

/* lightweight-charts objects */
let chart = null;
let candleSeries = null;
let volumeSeries = null;
let chartCandles = []; // local array of candles (time in seconds)
let lastPrice = null;
let lastPriceTs = 0;

/* Price cache & poll */
let lastPriceMap = {}; // cgId -> { price, change24h, ts }

/* ===== helpers: price formatting (USD) ===== */
function formatPrice(v){
  if(typeof v !== 'number' || !isFinite(v)) return '-';
  return new Intl.NumberFormat('en-US', { style:'currency', currency:'USD', maximumFractionDigits: v >= 1 ? 2 : 6 }).format(v);
}

/* ================= CoinGecko: top10 & polling ================= */
async function fetchTop10CoinGeckoMarkets(){
  try{
    const url = `${COINGECKO_BASE}/coins/markets?vs_currency=${CG_VS_CURRENCY}&order=market_cap_desc&per_page=10&page=1&sparkline=false&price_change_percentage=24h`;
    const res = await fetch(url);
    if(!res.ok) throw new Error('cg top10 failed ' + res.status);
    const data = await res.json();
    markets = {};
    data.forEach(coin=>{
      const key = (coin.symbol||'').toUpperCase() + '/' + coin.id;
      markets[key] = {
        cgId: coin.id,
        symbol: (coin.symbol||'').toUpperCase(),
        name: coin.name || coin.id,
        price: coin.current_price || 0,
        payoutPercent: 70,
        locked: false
      };
      lastPriceMap[coin.id] = { price: coin.current_price || 0, change24h: coin.price_change_percentage_24h_in_currency || 0, ts: Date.now() };
    });
    renderSymbolSelect();
    // choose first market
    currentMarketId = Object.keys(markets)[0];
    updateMarketUI();
    await loadCandlesForCurrentMarket(); // initial chart
    startPricePolling();
  }catch(e){
    console.error('fetchTop10CoinGeckoMarkets err', e);
  }
}

function renderSymbolSelect(){
  symbolSelectTop.innerHTML = '';
  Object.keys(markets).forEach(k=>{
    const m = markets[k];
    const opt = document.createElement('option');
    opt.value = k;
    opt.text = `${m.symbol} ‚Äî ${m.name}`;
    symbolSelectTop.appendChild(opt);
  });
  if(currentMarketId) symbolSelectTop.value = currentMarketId;
}

/* poll simple price for quick updates */
let pricePollTimer = null;
async function pollSimplePrices(){
  if(pricePollTimer) clearTimeout(pricePollTimer);
  const ids = Object.values(markets).map(m => m.cgId).filter(Boolean);
  if(ids.length === 0){
    pricePollTimer = setTimeout(pollSimplePrices, PRICE_POLL_INTERVAL);
    return;
  }
  try{
    const url = `${COINGECKO_BASE}/simple/price?ids=${encodeURIComponent(ids.join(','))}&vs_currencies=${CG_VS_CURRENCY}&include_24hr_change=true`;
    const res = await fetch(url);
    if(res.ok){
      const j = await res.json();
      Object.keys(j).forEach(id=>{
        const entry = j[id];
        if(entry && typeof entry[CG_VS_CURRENCY] !== 'undefined'){
          lastPriceMap[id] = { price: Number(entry[CG_VS_CURRENCY]), change24h: Number(entry[CG_VS_CURRENCY + '_24h_change'] || 0), ts: Date.now() };
        }
      });
      // reflect current market price on UI
      updateDisplayedPrice();
      // update chart last candle using latest price
      applyRealtimePriceToChart();
    }
  }catch(e){
    console.warn('pollSimplePrices err', e);
  } finally {
    pricePollTimer = setTimeout(pollSimplePrices, PRICE_POLL_INTERVAL);
  }
}

function startPricePolling(){
  if(pricePollTimer) clearTimeout(pricePollTimer);
  pollSimplePrices();
}

/* ================= Fetch historical points and aggregate to 1-min candles =================
   Strategy:
   - Use /coins/{id}/market_chart?vs_currency=usd&days={days} which returns prices array [[ts, price], ...]
   - Aggregate by minute (Math.floor(ts/60000)) -> open/high/low/close for each minute
   - Feed candles (time in seconds) to lightweight-charts
   Note: CoinGecko returns multiple points; we aggregate locally to get per-minute candles (realtime friendly).
   (CoinGecko docs: use /coins/{id}/market_chart for historical price arrays).  [oai_citation:1‚Ä°CoinGecko](https://www.coingecko.com/en/api?utm_source=chatgpt.com)
*/
async function fetchMarketChartPrices(cgId, days){
  try{
    const url = `${COINGECKO_BASE}/coins/${encodeURIComponent(cgId)}/market_chart?vs_currency=${CG_VS_CURRENCY}&days=${encodeURIComponent(days)}&interval=minute`;
    const res = await fetch(url);
    if(!res.ok) throw new Error('market_chart failed ' + res.status);
    const j = await res.json();
    // j.prices: [ [ts, price], ... ] ts in ms
    return j.prices || [];
  }catch(e){
    console.warn('fetchMarketChartPrices err', e);
    return [];
  }
}

function aggregatePricesToMinuteCandles(pricesArray, maxMinutes = HISTORY_MINUTES){
  // pricesArray: [ [ts_ms, price], ... ] (chronological ascending)
  const map = new Map(); // minuteBucket -> { open, high, low, close, tsMs }
  for(const p of pricesArray){
    const ts = Number(p[0]);
    const price = Number(p[1]);
    const bucket = Math.floor(ts / 60000); // per-minute bucket number
    const existing = map.get(bucket);
    if(!existing){
      map.set(bucket, { open: price, high: price, low: price, close: price, tsMs: bucket * 60000 });
    } else {
      existing.high = Math.max(existing.high, price);
      existing.low = Math.min(existing.low, price);
      existing.close = price;
    }
  }
  // convert to sorted array (ascending)
  const buckets = Array.from(map.keys()).sort((a,b)=>a-b);
  const result = [];
  // only return last maxMinutes
  const startIdx = Math.max(0, buckets.length - maxMinutes);
  for(let i = startIdx; i < buckets.length; i++){
    const b = buckets[i];
    const v = map.get(b);
    result.push({
      time: Math.floor(v.tsMs / 1000), // seconds
      open: v.open,
      high: v.high,
      low: v.low,
      close: v.close
    });
  }
  return result;
}

/* ===== Chart creation (lightweight-charts) ===== */
function createOrResetChart(){
  const container = document.getElementById('chartContainer');
  container.innerHTML = ''; // clear
  chart = LightweightCharts.createChart(container, {
    layout: {
      backgroundColor: '#07121a',
      textColor: '#e6eef6',
    },
    rightPriceScale: { borderColor: 'rgba(255,255,255,0.06)' },
    timeScale: { borderColor: 'rgba(255,255,255,0.06)', timeVisible: true, secondsVisible: false },
    grid: { vertLines: { color: 'rgba(255,255,255,0.02)' }, horzLines: { color: 'rgba(255,255,255,0.02)' } },
    localization: { dateFormat: 'yyyy-MM-dd' },
  });
  candleSeries = chart.addCandlestickSeries({
    upColor: '#22c55e',
    downColor: '#ff6b6b',
    borderVisible: true,
    wickUpColor: '#22c55e',
    wickDownColor: '#ff6b6b'
  });
}

/* load candles for selected market & days */
async function loadCandlesForCurrentMarket(){
  if(!currentMarketId) return;
  const m = markets[currentMarketId];
  if(!m) return;
  const days = Number(daysSelect.value || 1);
  createOrResetChart();
  // fetch market_chart and aggregate to minute candles
  const pricePoints = await fetchMarketChartPrices(m.cgId, days);
  const candles = aggregatePricesToMinuteCandles(pricePoints, HISTORY_MINUTES);
  if(candles.length === 0){
    // fallback deterministic: create synthetic candles
    const now = Math.floor(Date.now() / 60000) * 60;
    const seed = m.price || 100;
    const arr = [];
    for(let i = HISTORY_MINUTES - 1; i >= 0; i--){
      const t = now - i * 60;
      const p = seed * (1 + (Math.sin(i*0.5)/100) + ((Math.random()-0.5)/200));
      arr.push({ time: t, open: p*0.999, high: p*1.001, low: p*0.998, close: p });
    }
    chartCandles = arr;
  } else {
    chartCandles = candles;
  }
  candleSeries.setData(chartCandles);
  // set lastPrice
  const last = chartCandles[chartCandles.length - 1];
  if(last){ lastPrice = last.close; lastPriceTs = last.time; }
  updateDisplayedPrice();
}

/* Apply realtime last price to chart as updating last candle or appending new 1-min candle */
function applyRealtimePriceToChart(){
  if(!currentMarketId || !candleSeries) return;
  const m = markets[currentMarketId];
  if(!m) return;
  const cg = m.cgId;
  const lp = lastPriceMap[cg];
  if(!lp || typeof lp.price === 'undefined') return;
  const price = Number(lp.price);
  const minuteBucket = Math.floor(Date.now() / 60000); // bucket number
  const bucketSec = minuteBucket * 60;
  const lastCandle = chartCandles[chartCandles.length - 1];
  if(!lastCandle || lastCandle.time < bucketSec){
    // new minute -> push candle with open = prev close (if any)
    const open = lastCandle ? lastCandle.close : price;
    const newCandle = { time: bucketSec, open: open, high: Math.max(open, price), low: Math.min(open, price), close: price };
    chartCandles.push(newCandle);
    // keep length
    if(chartCandles.length > HISTORY_MINUTES) chartCandles.shift();
    candleSeries.update(newCandle); // sets last candle (if library accepts update for new)
    // sometimes update isn't append ‚Äî safer to setData when pattern diverges:
    candleSeries.setData(chartCandles);
  } else {
    // update existing last candle (mutate and update)
    lastCandle.high = Math.max(lastCandle.high, price);
    lastCandle.low = Math.min(lastCandle.low, price);
    lastCandle.close = price;
    candleSeries.update({ time: lastCandle.time, open: lastCandle.open, high: lastCandle.high, low: lastCandle.low, close: lastCandle.close });
  }
  lastPrice = price;
  lastPriceTs = Date.now();
  updateDisplayedPrice();
}

/* update UI price & 24h change */
function updateDisplayedPrice(){
  if(!currentMarketId) return;
  const m = markets[currentMarketId];
  if(!m) return;
  const cg = m.cgId;
  const lp = lastPriceMap[cg];
  if(lp && typeof lp.price !== 'undefined'){
    currentPriceLarge.textContent = formatPrice(lp.price);
    const ch = Number(lp.change24h || 0);
    const sign = ch >= 0 ? '+' : '';
    priceChangeEl.textContent = `${sign}${ch.toFixed(2)}%`;
    priceChangeEl.style.color = ch >= 0 ? 'var(--green)' : 'var(--red)';
  } else if(lastPrice !== null){
    currentPriceLarge.textContent = formatPrice(lastPrice);
    priceChangeEl.textContent = '-';
  } else {
    currentPriceLarge.textContent = '-';
    priceChangeEl.textContent = '-';
  }
  priceSmallHint.textContent = CG_VS_CURRENCY.toUpperCase();
}

/* =========== Trading UI glue (reuse logic from your original code) =========== */
/* (For brevity I keep the trading functions similar to your original working code) */
let accountMode = 'live';
let demoBalance = 100000;
let balance = 0;
function getActiveBalance(){ return accountMode === 'demo' ? demoBalance : balance; }
function updateBalanceDisplays(){
  const val = getActiveBalance();
  balanceEl.textContent = Number(val).toFixed(2);
  balanceMain.textContent = Number(val).toFixed(2);
  summaryBalance.innerText = `Rp ${Number(val).toLocaleString('id-ID')}`;
  if(accountMode === 'demo'){
    document.getElementById('openDeposit').textContent = 'Refresh';
    document.getElementById('openDeposit2').textContent = 'Refresh';
    document.getElementById('badgeLive').classList.add('demo');
    document.getElementById('badgeLive').textContent = 'DEMO';
  } else {
    document.getElementById('openDeposit').textContent = 'Deposit';
    document.getElementById('openDeposit2').textContent = 'Deposit';
    document.getElementById('badgeLive').classList.remove('demo');
    document.getElementById('badgeLive').textContent = 'LIVE';
  }
}
function updateSummary(){
  const bet = Number(betAmountInput.value || 0);
  summaryBet.innerText = `Rp ${Number(bet).toLocaleString('id-ID')}`;
  summaryBalance.innerText = `Rp ${Number(getActiveBalance()).toLocaleString('id-ID')}`;
  const m = markets[currentMarketId];
  const payout = (m && m.payoutPercent) ? Number(m.payoutPercent) : 70;
  summaryPayout.innerText = `${payout}%`;
  const potential = Math.round(bet * (payout/100) + bet);
  summaryPotential.innerText = `Rp ${potential.toLocaleString('id-ID')}`;
  payoutInfo.innerText = `untung ${payout}% dari taruhan`;
}

/* simplified open trade UI element handling (same as previous) */
let openTrades = [];
function createOpenTradeElement(tr){
  const wrapper = document.createElement('div');
  wrapper.className = 'open-trade';
  wrapper.id = 'open_' + tr.id;
  const entryFormatted = formatPrice(Number(tr.entryPrice));
  const expectedExitFormatted = formatPrice(Number(getLatestPriceSafe(tr.market)));
  const remainingMs = Math.max(0, tr.expiryTs - Date.now());
  const remainingSec = Math.ceil(remainingMs / 1000);
  wrapper.innerHTML = `
    <div class="left">
      <div style="font-weight:800;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${tr.market} ‚Ä¢ ${tr.side}</div>
      <div class="meta entry-exit">Entry: <strong class="entryPrice">${entryFormatted}</strong> ‚Ä¢ Rata": <strong class="exitPrice">${expectedExitFormatted}</strong></div>
      <div class="meta">Investasi: Rp ${Number(tr.amount).toLocaleString()}</div>
    </div>
    <div style="display:flex;flex-direction:column;align-items:flex-end;gap:6px">
      <div class="countdown" data-expiry="${tr.expiryTs}">${formatSecondsMMSS(remainingSec)}</div>
      <div class="meta" style="color:var(--muted);font-size:12px">ID: ${tr.id}</div>
    </div>
  `;
  return wrapper;
}
function addOpenTradeUI(tr){
  if(document.getElementById('open_' + tr.id)) return;
  const el = createOpenTradeElement(tr);
  listOpenTrades.prepend(el);
  const countdownEl = el.querySelector('.countdown');
  const exitPriceEl = el.querySelector('.exitPrice');
  tr._uiInterval = setInterval(()=>{
    const now = Date.now();
    const remainingMs = Math.max(0, tr.expiryTs - now);
    const sec = Math.ceil(remainingMs/1000);
    countdownEl.textContent = formatSecondsMMSS(sec);
    const expectedExit = getLatestPriceSafe(tr.market);
    exitPriceEl.textContent = formatPrice(Number(expectedExit));
    if(remainingMs <= 0) clearInterval(tr._uiInterval);
  }, 500);
}
function formatSecondsMMSS(s){
  if(typeof s !== 'number' || s < 0) s = 0;
  const mm = Math.floor(s/60); const ss = s % 60;
  return String(mm).padStart(2,'0') + ':' + String(ss).padStart(2,'0');
}
function getLatestPriceSafe(marketKey){
  const m = markets[marketKey];
  if(!m) return lastPrice || 0;
  const p = lastPriceMap[m.cgId];
  if(p && typeof p.price !== 'undefined') return p.price;
  return m.price || lastPrice || 0;
}

/* trade execution (demo & live handling kept simple) */
function executeTrade(side){
  const bet = Number(betAmountInput.value || 0);
  if(!bet || bet < 15000) return alert('Minimal transaksi Rp 15.000');
  const m = markets[currentMarketId];
  if(m && m.locked){ alert('Market tutup ‚Äî perdagangan gagal.'); return; }
  const activeBal = getActiveBalance();
  if(bet > activeBal) return alert('Saldo tidak cukup');
  if(!currentUser) return alert('Belum login');
  const entryPrice = getLatestPriceSafe(currentMarketId);
  const dur = parseDurationToSeconds(durationInput.value || '00:01:00');
  const expiryTs = Date.now() + (dur*1000);
  const payoutPercent = (m && m.payoutPercent) ? Number(m.payoutPercent) : 70;
  const tradeId = 't_' + Date.now() + '_' + Math.floor(Math.random()*9999);
  const tr = { id: tradeId, uid: currentUser ? currentUser.uid : null, market: currentMarketId, side, amount: bet, entryPrice, expiryTs, payoutPercent };

  if(accountMode === 'demo'){
    demoBalance = Math.max(0, demoBalance - bet);
    tr._mode = 'demo';
    openTrades.push(tr);
    addOpenTradeUI(tr);
    scheduleDemoResolution(tr);
    saveDemoOpenTrades();
    updateBalanceDisplays();
  } else {
    // live: create openTrades doc in transaction and deduct stake
    db.runTransaction(async (t)=>{
      const uref = db.collection('users').doc(currentUser.uid);
      const ud = await t.get(uref);
      if(!ud.exists) throw 'no user';
      const prev = (ud.data().balance) ? Number(ud.data().balance) : 0;
      if(prev < bet) throw 'insufficient';
      const newBal = prev - bet;
      t.set(uref, { balance: newBal, updatedAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge:true });
      const optRef = db.collection('users').doc(currentUser.uid).collection('openTrades').doc(tradeId);
      t.set(optRef, { ...tr, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
    }).then(()=>{
      tr._mode = 'live';
      openTrades.push(tr);
      addOpenTradeUI(tr);
      scheduleLiveResolution(tr);
      balance = Math.max(0, balance - bet);
      updateBalanceDisplays();
    }).catch(err=>{
      console.error(err);
      alert('Gagal membuka trade: ' + (err === 'insufficient' ? 'saldo tidak cukup' : err));
      return;
    });
  }
  updateSummary();
}

/* resolution helpers (demo/live) - simplified copy of previous code (uses fetchLatestPriceForMarket) */
function saveDemoOpenTrades(){
  const demoList = openTrades.filter(t => t._mode === 'demo');
  localStorage.setItem('demoOpenTrades', JSON.stringify(demoList));
}
function loadDemoOpenTrades(){
  const raw = localStorage.getItem('demoOpenTrades');
  if(!raw) return;
  try{
    const arr = JSON.parse(raw);
    if(!Array.isArray(arr)) return;
    arr.forEach(tr=>{
      if(openTrades.find(x=>x.id === tr.id)) return;
      tr._mode = 'demo';
      openTrades.push(tr);
      addOpenTradeUI(tr);
      scheduleDemoResolution(tr);
    });
    updateSummary();
    updateBalanceDisplays();
  }catch(e){ console.error('load demo open trades err', e); }
}
function removeDemoOpenTradeById(id){
  openTrades = openTrades.filter(x=>!(x.id === id && x._mode === 'demo'));
  saveDemoOpenTrades();
}
function scheduleDemoResolution(tr){
  const now = Date.now();
  const remaining = Math.max(0, tr.expiryTs - now);
  if(tr._demoTimer) clearTimeout(tr._demoTimer);
  tr._demoTimer = setTimeout(()=> resolveDemoTrade(tr), remaining);
}
async function resolveDemoTrade(tr){
  const found = openTrades.find(x=>x.id === tr.id && x._mode === 'demo');
  if(!found) return;
  const exitPrice = await fetchLatestPriceForMarket(tr.market);
  const isBuy = (tr.side.toLowerCase() === 'naik' || tr.side.toLowerCase() === 'call');
  let isWin = false;
  if(exitPrice > tr.entryPrice) isWin = isBuy;
  else if(exitPrice < tr.entryPrice) isWin = !isBuy;
  else isWin = false;
  const payoutPercent = tr.payoutPercent || 70;
  const bet = Number(tr.amount || 0);
  const profit = Math.round((payoutPercent/100) * bet);

  if(isWin){
    demoBalance = demoBalance + bet + profit;
    const text = `Menang +Rp ${profit.toLocaleString('id-ID')} (plus pengembalian stake Rp ${bet.toLocaleString('id-ID')})`;
    const li = document.createElement('div'); li.className='history-item';
    li.innerHTML = `<div>${new Date().toLocaleTimeString()} ‚Äî ${tr.market} ‚Äî ${tr.side}</div><div style="color:#22c55e">${text}</div>`;
    listTrades.prepend(li); document.getElementById('sideTradeList').prepend(li.cloneNode(true));
    markTradeClosedUI(tr, true, exitPrice);
  } else {
    const text = `Kalah -Rp ${bet.toLocaleString('id-ID')}`;
    const li = document.createElement('div'); li.className='history-item';
    li.innerHTML = `<div>${new Date().toLocaleTimeString()} ‚Äî ${tr.market} ‚Äî ${tr.side}</div><div style="color:#fb7185">${text}</div>`;
    listTrades.prepend(li); document.getElementById('sideTradeList').prepend(li.cloneNode(true));
    markTradeClosedUI(tr, false, exitPrice);
  }

  removeDemoOpenTradeById(tr.id);
  if(tr._demoTimer) clearTimeout(tr._demoTimer);
  updateBalanceDisplays();
}

/* Live resolution helpers (similar to previous) */
let liveTradeTimers = {};
function scheduleLiveResolution(tr){
  const now = Date.now();
  const remaining = Math.max(0, tr.expiryTs - now);
  if(liveTradeTimers[tr.id]) clearTimeout(liveTradeTimers[tr.id]);
  liveTradeTimers[tr.id] = setTimeout(()=> resolveLiveTrade(tr.id), remaining);
}
async function resolveLiveTrade(tradeId){
  if(!currentUser) return;
  const docRef = db.collection('users').doc(currentUser.uid).collection('openTrades').doc(tradeId);
  try{
    const doc = await docRef.get();
    if(!doc.exists) return;
    const tr = { id: doc.id, ...doc.data() };
    const exitPrice = await fetchLatestPriceForMarket(tr.market);
    const isBuy = (tr.side.toLowerCase() === 'naik' || tr.side.toLowerCase() === 'call');
    let isWin = false;
    if(exitPrice > tr.entryPrice) isWin = isBuy;
    else if(exitPrice < tr.entryPrice) isWin = !isBuy;
    else isWin = false;
    const payoutPercent = tr.payoutPercent || 70;
    const bet = Number(tr.amount || 0);
    const profit = Math.round((payoutPercent/100) * bet);
    const refundOnWin = bet + profit;

    await db.runTransaction(async (t)=>{
      const uref = db.collection('users').doc(currentUser.uid);
      const udoc = await t.get(uref);
      const prev = (udoc.exists && udoc.data().balance) ? Number(udoc.data().balance) : 0;
      let newBal = prev;
      let text;
      if(isWin){
        newBal = prev + refundOnWin;
        text = `Menang +Rp ${profit.toLocaleString('id-ID')} (plus pengembalian stake Rp ${bet.toLocaleString('id-ID')})`;
      } else {
        newBal = prev;
        text = `Kalah -Rp ${bet.toLocaleString('id-ID')}`;
      }
      t.set(uref, { balance: newBal, updatedAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge:true });
      const histRef = db.collection('users').doc(currentUser.uid).collection('history').doc();
      t.set(histRef, {
        type: 'trade', side: tr.side, entryPrice: tr.entryPrice, exitPrice, amount: bet,
        result: isWin ? 'untung' : 'rugi', text, createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      t.delete(docRef);
    });

    markTradeClosedUI(tr, isWin, exitPrice);
    if(isWin) balance = (balance || 0) + refundOnWin;
    updateBalanceDisplays();
    const li = document.createElement('div'); li.className='history-item';
    li.innerHTML = `<div>${new Date().toLocaleTimeString()} ‚Äî ${tr.market} ‚Äî ${tr.side}</div><div style="color:${isWin?'#22c55e':'#fb7185'}">${isWin ? 'Menang' : 'Kalah'}</div>`;
    listTrades.prepend(li); document.getElementById('sideTradeList').prepend(li.cloneNode(true));
    openTrades = openTrades.filter(x=>x.id !== tradeId);
    if(liveTradeTimers[tradeId]) clearTimeout(liveTradeTimers[tradeId]);
  }catch(e){
    console.error('resolveLiveTrade err', e);
  }
}

function markTradeClosedUI(tr, isWin, exitPrice){
  const el = document.getElementById('open_' + tr.id);
  if(!el) return;
  el.classList.add('trade-closed');
  const entryEl = el.querySelector('.entryPrice');
  const exitEl = el.querySelector('.exitPrice');
  const countdown = el.querySelector('.countdown');
  if(entryEl) entryEl.textContent = formatPrice(Number(tr.entryPrice));
  if(exitEl) exitEl.textContent = formatPrice(Number(exitPrice));
  if(countdown) countdown.textContent = isWin ? 'MENANG' : 'KALAH';
  const left = el.querySelector('.left');
  const res = document.createElement('div');
  res.style.marginTop = '6px';
  res.innerHTML = `<div style="font-weight:800;color:${isWin? 'var(--green)':'var(--red)'}">${isWin ? 'Win' : 'Lose'}</div>`;
  left.appendChild(res);
  setTimeout(()=> { try{ el.remove(); } catch(e){} }, 6000);
}

/* helper: parse duration */
function parseDurationToSeconds(s){
  const parts = s.split(':').map(p=>Number(p));
  if(parts.length===3) return parts[0]*3600 + parts[1]*60 + parts[2];
  if(parts.length===2) return parts[0]*60 + parts[1];
  return Number(s) || 60;
}

/* helper: fetch latest price for a market (cgId) */
async function fetchLatestPriceForMarket(marketKey){
  const m = markets[marketKey];
  if(!m || !m.cgId) return 0;
  try{
    const url = `${COINGECKO_BASE}/simple/price?ids=${encodeURIComponent(m.cgId)}&vs_currencies=${CG_VS_CURRENCY}`;
    const res = await fetch(url);
    if(res.ok){
      const j = await res.json();
      const p = Number(j[m.cgId] && j[m.cgId][CG_VS_CURRENCY] ? j[m.cgId][CG_VS_CURRENCY] : NaN);
      if(!isNaN(p)){
        lastPriceMap[m.cgId] = { price: p, ts: Date.now() };
        return p;
      }
    }
  }catch(e){ console.warn('fetchLatestPriceForMarket err', e); }
  // fallback to cached
  return (lastPriceMap[m.cgId] && lastPriceMap[m.cgId].price) ? lastPriceMap[m.cgId].price : (m.price || 0);
}

/* ===== UI event bindings ===== */
symbolSelectTop.addEventListener('change', async ()=>{
  currentMarketId = symbolSelectTop.value;
  updateMarketUI();
  await loadCandlesForCurrentMarket();
});
daysSelect.addEventListener('change', async ()=>{
  await loadCandlesForCurrentMarket();
});
btnUp.addEventListener('click', ()=> executeTrade('Naik'));
btnDown.addEventListener('click', ()=> executeTrade('Turun'));
betAmountInput.addEventListener('input', updateSummary);
durationInput.addEventListener('input', ()=>{ document.getElementById('currDur').textContent = parseDurationToSeconds(durationInput.value); });

/* ===== listen to Firebase auth + app init ===== */
auth.onAuthStateChanged(async (user)=>{
  if(user){
    currentUser = user;
    uidLabel.innerText = user.uid;
    const uref = db.collection('users').doc(user.uid);
    const docu = await uref.get();
    if(!docu.exists){
      await uref.set({ balance: 0, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
    }
    // listen user balance
    db.collection('users').doc(user.uid).onSnapshot(doc=>{
      if(!doc.exists) return;
      const d = doc.data();
      balance = d.balance || 0;
      if(accountMode === 'live') updateBalanceDisplays();
      updateSummary();
    });
    // fetch top markets and start polling
    await fetchTop10CoinGeckoMarkets();
    // load overrides from Firestore markets collection if admin set custom payouts/locks
    db.collection('markets').get().then(snap=>{
      snap.forEach(doc=>{
        const id = decodeURIComponent(doc.id);
        if(markets[id]){
          const od = doc.data();
          if(typeof od.volatilityFraction !== 'undefined') markets[id].volatilityFraction = od.volatilityFraction;
          if(typeof od.payoutPercent !== 'undefined') markets[id].payoutPercent = od.payoutPercent;
          if(typeof od.locked !== 'undefined') markets[id].locked = od.locked;
        }
      });
      updateMarketUI();
    }).catch(()=>{});
    if(accountMode === 'demo') loadDemoOpenTrades();
  } else {
    auth.signInAnonymously().catch(e=>console.error(e));
  }
});

/* small helpers & initial UI */
function updateMarketUI(){
  const m = markets[currentMarketId];
  if(!m){ pairTitle.textContent = currentMarketId || '‚Äî'; pairSub.textContent = ''; payoutLabel.textContent='-%'; return; }
  pairTitle.textContent = `${m.symbol || currentMarketId}`;
  pairSub.textContent = `${m.name || ''} ‚Ä¢ ${currentMarketId}`;
  payoutLabel.textContent = (m.payoutPercent || 70) + '%';
  priceSmallHint.textContent = CG_VS_CURRENCY.toUpperCase();
  updateSummary();
}
function getActiveBalance(){ return accountMode === 'demo' ? demoBalance : balance; }
updateSummary();
updateBalanceDisplays();
setInterval(()=>{ const d = new Date(); document.getElementById('clock').innerText = d.toLocaleTimeString(); },1000);

/* Start polling prices even if auth not ready (once markets loaded) */
pollSimplePrices();

</script>
</body>
</html>
