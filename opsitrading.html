<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Crash GOOGLE - Binary Option Trading (Firebase)</title>
  <style>
    :root {
      --primary-color: #1e88e5;
      --bg-color: #f5f5f5;
      --text-color: #333;
      --card-bg: #fff;
      --up-color: #4caf50;
      --down-color: #f44336;
    }
    * { box-sizing:border-box; margin:0; padding:0; font-family:Poppins,sans-serif; }
    body { background:var(--bg-color); color:var(--text-color); }

    .header {
      display:flex; justify-content:space-between; align-items:center;
      background:var(--primary-color); color:#fff; padding:1rem;
    }
    .header .balance { font-weight:bold; }
    
    .controls {
      display:flex; gap:.5rem; padding:1rem; justify-content:center;
      background:#eee;
    }
    .controls select, .controls button {
      padding:.5rem; border-radius:4px; border:1px solid #ccc;
      background:#fff; cursor:pointer;
    }
    .controls .btn-deposit { background-color: #28a745; color:#fff; border:none; }
    .controls .btn-withdraw { background-color: #dc3545; color:#fff; border:none; }
    .controls .btn-deposit:hover, .controls .btn-deposit:focus { background-color:#218838; }
    .controls .btn-withdraw:hover, .controls .btn-withdraw:focus { background-color:#c82333; }

    .trading-panel {
      background:var(--card-bg); max-width:960px; margin:1rem auto; padding:1rem;
      border-radius:6px; box-shadow:0 2px 6px rgba(0,0,0,.1);
    }
    .chart-container { display:flex; flex-wrap:wrap; gap:1rem; }
    #chartCanvas { flex:1 1 0; width:100%; height:300px; border:1px solid #ddd; }
    .price-display {
      width:100px; padding:1rem; font-size:1.1rem;
      border-left:1px solid #ccc; text-align:center;
      display:flex; flex-direction:column; justify-content:center;
      background:#f9f9f9;
    }

    .market-info { display:flex; justify-content:space-between; margin:.5rem 0; }
    .options { display:flex; gap:.5rem; margin-bottom:.5rem; }
    .option-btn {
      flex:1; padding:.8rem; border:none; border-radius:4px;
      color:#fff; font-weight:bold; cursor:pointer;
    }
    #btnUp { background:var(--up-color); }
    #btnDown { background:var(--down-color); }

    .bet-controls { display:flex; gap:.5rem; margin-bottom:.5rem; }
    .bet-controls input {
      flex:1; padding:.6rem; border-radius:4px; border:1px solid #ccc;
    }

    .result, #activeTrade {
      text-align:center; font-weight:bold; margin-top:.5rem;
    }
    #tradeHistory {
      list-style:none; padding:0; max-width:600px; margin:1rem auto;
      font-size:.9rem;
    }
    #tradeHistory li { margin-bottom:.3rem; }

    .footer { text-align:center; margin:1rem; color:#777; }

    /* Modals */
    .modal {
      display:none; position:fixed; z-index:10;
      left:0; top:0; width:100%; height:100%;
      background:rgba(0,0,0,0.4); overflow:auto;
    }
    .modal-content {
      background:#fff; margin:10% auto; padding:1.5rem;
      border-radius:8px; width:90%; max-width:420px; position:relative;
    }
    .modal-close {
      position:absolute; top:.5rem; right:.8rem;
      font-size:1.2rem; cursor:pointer; color:#666;
    }
    .modal-content h3 { margin-bottom:1rem; color:var(--primary-color); }
    .modal-content label { display:block; margin:.5rem 0 .2rem; }
    .modal-content input, .modal-content select {
      width:100%; padding:.6rem; margin-bottom:.8rem;
      border:1px solid #ccc; border-radius:4px;
    }
    .modal-content button {
      width:100%; padding:.8rem; background:var(--primary-color);
      color:#fff; border:none; border-radius:4px; font-size:1rem;
      cursor:pointer; margin-top:.5rem;
    }
    .qrcode-container { text-align:center; margin-top:1rem; }
    .qrcode-container img { max-width:200px; display:block; margin:0 auto; }
    .qrcode-container p { margin:.5rem 0; }

    .promo {
      max-width:600px; margin:2rem auto; padding:1.5rem;
      background:var(--card-bg); border-radius:8px;
      box-shadow:0 2px 8px rgba(0,0,0,0.1); text-align:center;
    }
    .promo h2 { color:var(--primary-color); margin-bottom:.5rem; }
    .faq { max-width:900px; margin:0.5rem auto; }
    .small{ font-size:13px; color:#666; text-align:left; margin:6px 0; }
    pre.payload { background:#f6f6f6; padding:8px; overflow:auto; text-align:left; }
  </style>
</head>
<body>

  <div class="header">
    <div>ðŸš€ Option GOOGLE</div>
    <div class="balance">Saldo Real: Rp.<span id="balance">0.00</span></div>
  </div>

  <section class="faq">
    <h5>Sudah Trading/Deposit/Penarikan Jangan di Refresh Agar Tidak menghapus History dan Saldo Trading</h5>
  </section>
  
  <p style="text-align:center; margin-top:.5rem;">Informasi: Market â€“ Server â€“ Durasi Trading</p>
  <div class="controls">
    <select id="symbolSelect">
      <option value="EURUSD">Polusi Index</option>
      <option value="GBPUSD">Mineral Index</option>
      <option value="USDJPY">Air Index</option>
      <option value="AUDUSD">Kesehatan Index</option>
      <option value="USDCAD">Kemiskinan Index</option>
      <option value="USDCHF">Lingkungan Index</option>
      <option value="NZDUSD">UMKM Index</option>
      <option value="XAUUSD">Demokrasi Index</option>
    </select>
    <select id="tfSelect">
      <option value="1">Global</option>
      <option value="5">Asia</option>
      <option value="15">Eropa</option>
      <option value="60">Amerika</option>
    </select>
    <select id="durSelect">
      <option value="60">1 menit</option>
      <option value="120">2 menit</option>
      <option value="300">5 menit</option>
    </select>
    <button id="btnDeposit" class="btn-deposit">Deposit</button>
    <button id="btnWithdraw" class="btn-withdraw">Tarik Saldo</button>
  </div>

  <section class="trading-panel">
    <div class="chart-container">
      <canvas id="chartCanvas"></canvas>
      <div class="price-display">
        <div>Index Poin</div>
        <div id="currentPrice">â€“</div>
      </div>
    </div>
    <div class="market-info">
      <div id="currSymbol">Polusi Index</div>
      <div>Durasi: <span id="currDur">60</span>s</div>
    </div>
    <div class="options">
      <button id="btnUp" class="option-btn">BELI</button>
      <button id="btnDown" class="option-btn">JUAL</button>
    </div>
    <div class="bet-controls">
      <input type="number" id="betAmount" placeholder="Jumlah (Rp)" min="14900">
    </div>
    <div id="result" class="result"></div>
    <div id="activeTrade" class="result"></div>
    <h3 style="text-align:center; margin-top:1rem;">Riwayat Perdagangan</h3>
    <ul id="tradeHistory"></ul>
  </section>

  <!-- Deposit Modal (DIUBAH: pakai QRIS dinamis) -->
  <div id="depositModal" class="modal">
    <div class="modal-content">
      <span class="modal-close" id="depositClose">&times;</span>
      <h3>Deposit Saldo</h3>
      <label>Nominal (Rp)</label>
      <input type="number" id="depositAmount" placeholder="2000" min="1000">
      <label>No. Rekening Pengirim</label>
      <input type="text" id="depositAccount" placeholder="1234567890">
      <label>Metode Pembayaran</label>
      <select id="depositMethod">
        <option value="Dana">QRIS Dana</option>
      </select>
      <button id="depositPay">Bayar</button>

      <div class="qrcode-container" id="qrcodeContainer" style="display:none;">
        <div class="small">Nominal input: <span id="nominalLabel"></span></div>
        <div class="small">Fee 0.8%: <span id="feePercentLabel"></span></div>
        <div class="small">Biaya tetap: Rp <span id="fixedFeeLabel">850</span></div>
        <div class="small">Total (dibulatkan): <strong>Rp <span id="totalLabel"></span></strong></div>

        <div id="qrcodeDyn" style="margin:8px auto;"></div>

        <div class="small">Payload QRIS akhir (untuk scan/give kepada user):</div>
        <pre id="finalPayload" class="payload"></pre>
        <button id="copyPayloadBtn" style="margin-top:8px;">Salin payload</button>

        <p>Menunggu pembayaran... Sisa waktu: <span id="depositTimer">15</span>s</p>
        <button id="depositConfirm" style="display:none; margin-top:8px;">Sudah Bayar</button>
      </div>
    </div>
  </div>

  <!-- Withdraw Modal -->
  <div id="withdrawModal" class="modal">
    <div class="modal-content">
      <span class="modal-close" id="withdrawClose">&times;</span>
      <h3>Tarik Saldo</h3>
      <label>Nominal (Rp)</label>
      <input type="number" id="withdrawAmount" placeholder="350000" min="350000">
      <label>No. Rekening Tujuan</label>
      <input type="text" id="withdrawAccount" placeholder="1234567890">
      <label>Metode Penarikan</label>
      <select id="withdrawMethod">
        <option value="Bank">Dana</option>
        <option value="E-Wallet">Gopay</option>
      </select>
      <button id="withdrawSubmit">Tarik</button>
    </div>
  </div>

  <section class="promo">
    <h2>ðŸš€ Siap Uji Insting Trading Lu?</h2>
    <p>
      Gabung di <strong>Crash GOOGLE</strong>... (konten promo sama seperti sebelumnya)
    </p>
  </section>

  <div class="footer">Â© 2025 Dolphin LLC</div>

  <!-- QRCode.js (CDN) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <!-- Firebase v8 scripts -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

  <script>
    /* ========== CONFIG ========== */
    const firebaseConfig = {
      apiKey: "AIzaSyDVUEZ3ZVmH4ld7LVnEq_L368wEJpEs-l8",
      authDomain: "zeepaylater-93a94.firebaseapp.com",
      projectId: "zeepaylater-93a94",
      storageBucket: "zeepaylater-93a94.appspot.com",
      messagingSenderId: "358065954807",
      appId: "1:358065954807:web:66619211fea82a4b2518f2"
    };
    const ADMIN_UID = 'viCOsJo4wHVFmhtpmMx1Wd4sDF52';
    /* ================================= */

    // init firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // Default base payload (statis) â€” ubah sesuai merchant lo
    const DEFAULT_BASE_PAYLOAD = "00020101021126610014COM.GO-JEK.WWW01189360091433055874630210G3055874630303UMI51440014ID.CO.QRIS.WWW0215ID10254231099470303UMI5204481453033605802ID5925ZkgamingstoreGoTo, Toko H6007TANGSEL61051522062070703A0163040657";

    // ========= QRIS helper functions (sama) =========
    function crc16ccitt(str) {
      let crc = 0xFFFF;
      for (let i = 0; i < str.length; i++) {
        crc ^= (str.charCodeAt(i) << 8);
        for (let j = 0; j < 8; j++) {
          crc = (crc & 0x8000) ? ((crc << 1) ^ 0x1021) : (crc << 1);
          crc &= 0xFFFF;
        }
      }
      return crc.toString(16).toUpperCase().padStart(4, '0');
    }
    function padLen(n) { return String(n).padStart(2, '0'); }
    function insertAmountTag(payload630, amountStr) {
      const amountField = '54' + padLen(amountStr.length) + amountStr;
      const idx5303 = payload630.indexOf('5303'); // tag 53 start
      if (idx5303 !== -1) {
        return payload630.slice(0, idx5303) + amountField + payload630.slice(idx5303);
      } else {
        const idx6304 = payload630.indexOf('6304');
        if (idx6304 !== -1) {
          return payload630.slice(0, idx6304) + amountField + payload630.slice(idx6304);
        } else {
          return payload630 + amountField;
        }
      }
    }
    function formatRupiahTwoDecimals(rp) { return rp.toFixed(2); }

    // ========= App state & UI bindings =========
    let currentUser = null;
    let balance = 0;
    const balanceEl = document.getElementById('balance');

    // Trading UI elements (sama seperti sebelumnya)
    const symbolSelect = document.getElementById('symbolSelect');
    const tfSelect     = document.getElementById('tfSelect');
    const durSelect    = document.getElementById('durSelect');
    const currSymbol   = document.getElementById('currSymbol');
    const currDur      = document.getElementById('currDur');
    const tradeHistory = document.getElementById('tradeHistory');
    const canvas    = document.getElementById('chartCanvas');
    const ctx       = canvas.getContext('2d');
    const priceEl   = document.getElementById('currentPrice');
    const btnUp     = document.getElementById('btnUp');
    const btnDown   = document.getElementById('btnDown');
    const betAmount = document.getElementById('betAmount');
    const resultEl  = document.getElementById('result');
    const activeTrade = document.getElementById('activeTrade');

    let candles = [], markers = [], lastPrice = 1.2;
    let tradeDur = +durSelect.value;
    const historyCache = {}, candlesCache = {};

    function key() { return symbolSelect.value + '_' + tfSelect.value; }
    function loadHistoryUI() {
      const k = key();
      // show from local cache (will be supplemented by firestore load)
      tradeHistory.innerHTML = historyCache[k]?.join('') || '';
    }
    function saveHistoryItemLocal(html) {
      const k = key();
      historyCache[k] = historyCache[k] || [];
      historyCache[k].unshift(html);
    }

    // Firestore helpers
    function userDocRef(uid) { return db.collection('users').doc(uid); }
    function userHistoryRef(uid) { return db.collection('users').doc(uid).collection('history'); }

    function writeBalanceToFirestore(uid, newBalance) {
      return userDocRef(uid).set({
        balance: Number(newBalance) || 0,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      }, { merge: true });
    }

    function addHistoryToFirestore(uid, item) {
      // item: { type:'trade'|'deposit'|'withdraw', text, amount, timestamp }
      return userHistoryRef(uid).add({
        ...item,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      });
    }

    function listenToUser(uid) {
      // listen to balance changes
      userDocRef(uid).onSnapshot(doc => {
        if (!doc.exists) return;
        const data = doc.data();
        if (data && typeof data.balance !== 'undefined') {
          balance = Number(data.balance) || 0;
          balanceEl.textContent = balance.toFixed(2);
        }
      });

      // listen to latest history (limit 50) and render
      userHistoryRef(uid).orderBy('timestamp', 'desc').limit(50)
        .onSnapshot(snap => {
          tradeHistory.innerHTML = ''; // replace with firestore-backed history
          snap.forEach(d => {
            const it = d.data();
            const time = it.timestamp && it.timestamp.toDate ? it.timestamp.toDate().toLocaleTimeString() : new Date().toLocaleTimeString();
            let color = '#333';
            let label = '';
            if (it.type === 'trade') {
              color = it.result === 'win' ? 'green' : 'red';
              label = `${time} â€” ${it.side} @ ${it.entryPrice} â†’ Exit @ ${it.exitPrice} â€” ${it.text}`;
            } else if (it.type === 'deposit') {
              color = 'blue';
              label = `${time} â€” Deposit: Rp ${Number(it.amount).toLocaleString()} â€” ${it.text || ''}`;
            } else if (it.type === 'withdraw') {
              color = 'orange';
              label = `${time} â€” Withdraw: Rp ${Number(it.amount).toLocaleString()} â€” ${it.text || ''}`;
            } else {
              label = `${time} â€” ${it.text || JSON.stringify(it)}`;
            }
            const li = document.createElement('li');
            li.style.color = color;
            li.innerText = label;
            tradeHistory.appendChild(li);
          });
        });
    }

    // Auth: try restore / sign in anonymously
    auth.onAuthStateChanged(user => {
      if (user) {
        currentUser = user;
        // ensure user doc exists
        userDocRef(user.uid).get().then(doc => {
          if (!doc.exists) {
            // create default doc
            userDocRef(user.uid).set({
              balance: 0,
              createdAt: firebase.firestore.FieldValue.serverTimestamp()
            }).then(()=> {
              // listen
              listenToUser(user.uid);
            });
          } else {
            // listen
            listenToUser(user.uid);
          }
        }).catch(err => {
          console.error('Firestore get user doc error:', err);
        });
      } else {
        // not signed in => sign in anonymously
        auth.signInAnonymously().catch(err => {
          console.error('Anon sign-in failed:', err);
        });
      }
    });

    // ========= Chart & trading logic (sama seperti sebelumnya) =========
    function genHistory(base, count=50) {
      const tf = +tfSelect.value;
      const now = Date.now();
      let b = base, arr = [];
      for(let i=count; i>0; i--) {
        const t = now - i*tf*60000;
        const open = b;
        const close = open*(1+(Math.random()*0.02-0.01));
        const high = Math.max(open,close)*(1+Math.random()*0.005);
        const low  = Math.min(open,close)*(1-Math.random()*0.005);
        arr.push({ time:t, open, high, low, close });
        b = close;
      }
      return arr;
    }
    function loadChart() {
      currSymbol.textContent = symbolSelect.selectedOptions[0].text;
      currDur.textContent = tradeDur = +durSelect.value;
      const k = key();
      if (!candlesCache[k]) {
        lastPrice = 1 + Math.random();
        candlesCache[k] = genHistory(lastPrice);
      }
      candles = candlesCache[k];
      lastPrice = candles[candles.length-1].close;
      markers = [];
      priceEl.textContent = lastPrice.toFixed(4);
      loadHistoryUI();
      draw();
      startTicks();
    }
    let tickInterval;
    function startTicks() {
      clearInterval(tickInterval);
      tickInterval = setInterval(()=>{
        const change = lastPrice*(Math.random()*0.010-0.005);
        lastPrice += change;
        candles.push({
          time:Date.now(),
          open:candles[candles.length-1].close,
          high:Math.max(candles[candles.length-2].close,lastPrice),
          low:Math.min(candles[candles.length-2].close,lastPrice),
          close:lastPrice
        });
        if(candles.length>50) candles.shift();
        priceEl.textContent = lastPrice.toFixed(4);
        draw();
      },2500);
    }
    function draw() {
      canvas.width  = canvas.clientWidth;
      canvas.height = canvas.clientHeight;
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      if (!candles.length) return;
      const allPrices = candles.flatMap(c => [c.high, c.low]);
      const maxP = Math.max(...allPrices);
      const minP = Math.min(...allPrices);
      const upColor   = getComputedStyle(document.documentElement).getPropertyValue('--up-color').trim();
      const downColor = getComputedStyle(document.documentElement).getPropertyValue('--down-color').trim();
      const w = canvas.width / candles.length * 0.8;
      candles.forEach((c, i) => {
        const x  = i * (canvas.width / candles.length) + (canvas.width / candles.length - w) / 2;
        const yO = ((maxP - c.open)  / (maxP - minP || 1)) * canvas.height;
        const yC = ((maxP - c.close) / (maxP - minP || 1)) * canvas.height;
        const yH = ((maxP - c.high)  / (maxP - minP || 1)) * canvas.height;
        const yL = ((maxP - c.low)   / (maxP - minP || 1)) * canvas.height;
        ctx.strokeStyle = '#000000';
        ctx.beginPath();
        ctx.moveTo(x + w/2, yH);
        ctx.lineTo(x + w/2, yL);
        ctx.stroke();
        ctx.fillStyle = c.close >= c.open ? upColor : downColor;
        ctx.fillRect(x, Math.min(yO, yC), w, Math.max(1, Math.abs(yC - yO)));
      });
      markers.forEach(m=>{
        const i = candles.findIndex(c=>c.time===m.time);
        if(i<0) return;
        const x = i*(canvas.width/candles.length)+(canvas.width/candles.length)/2;
        const y = ((maxP-m.price)/(maxP-minP || 1))*canvas.height + (m.type==='Buy'?-12:12);
        ctx.fillStyle = m.type==='Buy'?'var(--up-color)':'var(--down-color)';
        ctx.font='12px sans-serif'; ctx.textAlign='center';
        ctx.fillText(m.type, x, y);
      });
    }

    function placeTrade(type) {
      const bet = parseFloat(betAmount.value);
      if (!bet || bet <= 14900) return alert('Minimal transaksi Rp.15.000');
      if (bet > balance) return alert('Saldo tidak cukup');

      const entryPrice = lastPrice;
      const entryTime  = Date.now();
      markers.push({ time: entryTime, price: entryPrice, type });
      draw();

      let t = tradeDur;
      activeTrade.textContent = `${type} @ ${entryPrice.toFixed(4)} | Sisa waktu: ${t}s`;
      const iv = setInterval(() => {
        t--;
        activeTrade.textContent = `${type} @ ${entryPrice.toFixed(4)} | Sisa waktu: ${t}s`;
        if (t <= 0) {
          clearInterval(iv);
          const exitPrice = lastPrice;
          const isBuy  = type.toUpperCase() === 'BELI' || type.toLowerCase() === 'call';
          const isSell = type.toUpperCase() === 'JUAL' || type.toLowerCase() === 'put';
          const win = (isBuy  && exitPrice > entryPrice) || (isSell && exitPrice < entryPrice);

          let text, color;
          if (win) {
            const profit = bet * 0.7;
            balance += profit;
            text = `Tutup Keuntungan +${profit.toFixed(2)} Rp (Exit @ ${exitPrice.toFixed(4)})`;
            color = 'green';
            // persist balance + history
            if (currentUser) {
              writeBalanceToFirestore(currentUser.uid, balance)
                .catch(e => console.error('writeBalance err', e));
              addHistoryToFirestore(currentUser.uid, {
                type: 'trade',
                side: type,
                entryPrice: entryPrice.toFixed(4),
                exitPrice: exitPrice.toFixed(4),
                amount: bet,
                result: 'win',
                text
              }).catch(e => console.error('addHistory err', e));
            } else {
              const html = `<li style="color:${color};">${new Date().toLocaleTimeString()} â€” ${type} @ ${entryPrice.toFixed(4)} â†’ Exit @ ${exitPrice.toFixed(4)} â€” ${text}</li>`;
              saveHistoryItemLocal(html);
            }
          } else {
            balance -= bet;
            text = `Tutup Kerugian -${bet.toFixed(2)} Rp (Exit @ ${exitPrice.toFixed(4)})`;
            color = 'red';
            if (currentUser) {
              writeBalanceToFirestore(currentUser.uid, balance)
                .catch(e => console.error('writeBalance err', e));
              addHistoryToFirestore(currentUser.uid, {
                type: 'trade',
                side: type,
                entryPrice: entryPrice.toFixed(4),
                exitPrice: exitPrice.toFixed(4),
                amount: bet,
                result: 'lose',
                text
              }).catch(e => console.error('addHistory err', e));
            } else {
              const html = `<li style="color:${color};">${new Date().toLocaleTimeString()} â€” ${type} @ ${entryPrice.toFixed(4)} â†’ Exit @ ${exitPrice.toFixed(4)} â€” ${text}</li>`;
              saveHistoryItemLocal(html);
            }
          }

          // Update UI
          balanceEl.textContent = balance.toFixed(2);
          resultEl.textContent  = text;
          activeTrade.textContent = '';

          // if not using firestore, push local history UI
          if (!currentUser) {
            const html = `<li style="color:${color};">${new Date().toLocaleTimeString()} â€” ${type} @ ${entryPrice.toFixed(4)} â†’ Exit @ ${exitPrice.toFixed(4)} â€” ${text}</li>`;
            saveHistoryItemLocal(html);
            tradeHistory.insertAdjacentHTML('afterbegin', html);
          }
          betAmount.value = '';
        }
      }, 1000);
    }

    // Events (trading)
    symbolSelect.addEventListener('change', loadChart);
    tfSelect.addEventListener('change', loadChart);
    durSelect.addEventListener('change', ()=>{ currDur.textContent = tradeDur = +durSelect.value; });
    btnUp.addEventListener('click', ()=>placeTrade('BELI'));
    btnDown.addEventListener('click', ()=>placeTrade('JUAL'));

    // ========= Deposit/QRIS logic (DIGANTI: pakai mekanisme dinamis) =========
    const btnDeposit     = document.getElementById('btnDeposit'),
          depositModal   = document.getElementById('depositModal'),
          depositClose   = document.getElementById('depositClose'),
          depositPay     = document.getElementById('depositPay'),
          qrcodeContainer= document.getElementById('qrcodeContainer'),
          nominalLabel   = document.getElementById('nominalLabel'),
          feePercentLabel= document.getElementById('feePercentLabel'),
          fixedFeeLabel  = document.getElementById('fixedFeeLabel'),
          totalLabelEl   = document.getElementById('totalLabel'),
          qrcodeDynEl    = document.getElementById('qrcodeDyn'),
          finalPayloadEl = document.getElementById('finalPayload'),
          copyPayloadBtn = document.getElementById('copyPayloadBtn'),
          depositTimerEl = document.getElementById('depositTimer'),
          depositConfirm = document.getElementById('depositConfirm');

    let depositTimer, depositCountdown, currentFinalPayload = '', currentNominal = 0;

    btnDeposit.addEventListener('click', ()=>{
      document.getElementById('depositAmount').value = '';
      document.getElementById('depositAccount').value = '';
      document.getElementById('depositMethod').selectedIndex = 0;
      qrcodeContainer.style.display = 'none';
      depositConfirm.style.display = 'none';
      clearInterval(depositTimer);
      depositModal.style.display = 'block';
    });

    depositClose.addEventListener('click', ()=> depositModal.style.display = 'none');
    window.addEventListener('click', e => { if (e.target === depositModal) depositModal.style.display = 'none'; });

    depositPay.addEventListener('click', ()=>{
      const amt = parseFloat(document.getElementById('depositAmount').value);
      const acc = document.getElementById('depositAccount').value.trim();
      const method = document.getElementById('depositMethod').value;
      if (!amt || amt < 1000) return alert('Minimal Rp 1.000');
      if (!acc) return alert('Masukkan no. rekening');

      // fees: 0.8% + Rp850
      const feePercent = amt * 0.008;
      const fixedFee = 850;
      const totalPay = Math.round(amt + feePercent + fixedFee); // total customer bayar
      const amountStr = formatRupiahTwoDecimals(totalPay); // "10000.00"

      // prepare base payload without CRC: ensure it ends with '6304'
      let base = DEFAULT_BASE_PAYLOAD.trim();
      let payloadNoCRC;
      if (base.slice(-8, -4) === '6304') {
        payloadNoCRC = base.slice(0, -8) + '6304';
      } else {
        const idx = base.indexOf('6304');
        if (idx !== -1) payloadNoCRC = base.slice(0, idx+4);
        else payloadNoCRC = base + '6304';
      }

      // insert amount tag (54)
      const withAmount630 = insertAmountTag(payloadNoCRC, amountStr);
      // compute CRC
      const crc = crc16ccitt(withAmount630);
      const finalPayload = withAmount630 + crc;

      // show in UI
      nominalLabel.innerText = `Rp ${amt.toLocaleString('id-ID')}`;
      feePercentLabel.innerText = `Rp ${Math.round(feePercent).toLocaleString('id-ID')} (${(0.8)}%)`;
      fixedFeeLabel.innerText = fixedFee.toLocaleString('id-ID');
      totalLabelEl.innerText = totalPay.toLocaleString('id-ID');
      finalPayloadEl.innerText = finalPayload;
      currentFinalPayload = finalPayload;
      currentNominal = amt;

      // generate QR
      qrcodeDynEl.innerHTML = '';
      new QRCode(qrcodeDynEl, {
        text: finalPayload,
        width: 200,
        height: 200,
        correctLevel: QRCode.CorrectLevel.H
      });

      qrcodeContainer.style.display = 'block';
      depositCountdown = 15;
      depositTimerEl.textContent = depositCountdown;
      depositConfirm.style.display = 'none';
      clearInterval(depositTimer);
      depositTimer = setInterval(()=>{
        depositCountdown--;
        depositTimerEl.textContent = depositCountdown;
        if (depositCountdown <= 0) {
          clearInterval(depositTimer);
          depositConfirm.style.display = 'block';
        }
      }, 1000);
    });

    copyPayloadBtn.addEventListener('click', ()=>{
      if (!currentFinalPayload) return;
      navigator.clipboard?.writeText(currentFinalPayload).then(()=> alert('Payload disalin ke clipboard.'));
    });

    depositConfirm.addEventListener('click', ()=>{
      const amt = currentNominal || parseFloat(document.getElementById('depositAmount').value);
      const acc = document.getElementById('depositAccount').value.trim();
      const method = document.getElementById('depositMethod').value;

      if (!amt || !acc) {
        alert('Data deposit tidak lengkap.');
        return;
      }

      // credit nominal to user's balance (merchant credits the nominal)
      balance += amt;
      balanceEl.textContent = balance.toFixed(2);
      depositModal.style.display = 'none';

      if (currentUser) {
        // persist
        writeBalanceToFirestore(currentUser.uid, balance).catch(e => console.error('writeBalance err', e));
        addHistoryToFirestore(currentUser.uid, {
          type: 'deposit',
          amount: amt,
          text: `Confirmed deposit (method ${method}, acc ${acc})`
        }).catch(e => console.error('addHistory err', e));
      } else {
        // no user (unlikely) -> keep local
        const html = `<li style="color:blue;">${new Date().toLocaleTimeString()} â€” Deposit: Rp ${amt.toLocaleString()} â€” Confirmed</li>`;
        saveHistoryItemLocal(html);
        tradeHistory.insertAdjacentHTML('afterbegin', html);
      }

      // open WA for admin confirmation (sama flow)
      const feePercent = Math.round(amt * 0.008);
      const fixedFee = 850;
      const totalPay = Math.round(amt + feePercent + fixedFee);
      const message = `
*Konfirmasi Deposit*
*Option Trading*
âž¤ Nominal: Rp ${amt.toLocaleString('id-ID')}
âž¤ Total Bayar: Rp ${totalPay.toLocaleString('id-ID')} (fee ${feePercent.toLocaleString('id-ID')} + tetap Rp ${fixedFee.toLocaleString('id-ID')})
âž¤ Rekening: ${acc}
âž¤ Metode: ${method}

*Setelah Mengirim Form ini, Harap Kirim SS bukti Transfer Pembayaran*
`.trim();

      const whatsappNumber = '6285697747768';
      const whatsappLink = `https://wa.me/${whatsappNumber}?text=${encodeURIComponent(message)}`;
      window.open(whatsappLink, '_blank');
    });

    // ========= Withdraw =========
    const btnWithdraw    = document.getElementById('btnWithdraw'),
          withdrawModal  = document.getElementById('withdrawModal'),
          withdrawClose  = document.getElementById('withdrawClose'),
          withdrawSubmit = document.getElementById('withdrawSubmit');

    btnWithdraw.addEventListener('click', () => {
      document.getElementById('withdrawAmount').value = '';
      document.getElementById('withdrawAccount').value = '';
      document.getElementById('withdrawMethod').selectedIndex = 0;
      withdrawModal.style.display = 'block';
    });

    withdrawClose.addEventListener('click', () => { withdrawModal.style.display = 'none'; });
    window.addEventListener('click', e => { if (e.target === withdrawModal) withdrawModal.style.display = 'none'; });

    withdrawSubmit.addEventListener('click', () => {
      const amt = parseFloat(document.getElementById('withdrawAmount').value);
      const acc = document.getElementById('withdrawAccount').value.trim();
      const method = document.getElementById('withdrawMethod').value;

      if (!amt || amt < 350000) return alert('Minimal Rp 350.000');
      if (amt > balance) return alert('Saldo tidak cukup');
      if (!acc) return alert('Masukkan nomor rekening tujuan');

      balance -= amt;
      balanceEl.textContent = balance.toFixed(2);
      withdrawModal.style.display = 'none';

      if (currentUser) {
        writeBalanceToFirestore(currentUser.uid, balance).catch(e => console.error('writeBalance err', e));
        addHistoryToFirestore(currentUser.uid, {
          type: 'withdraw',
          amount: amt,
          text: `Withdraw request to ${acc} via ${method}`
        }).catch(e => console.error('addHistory err', e));
      } else {
        const html = `<li style="color:orange;">${new Date().toLocaleTimeString()} â€” Withdraw: Rp ${amt.toLocaleString()} â€” Requested</li>`;
        saveHistoryItemLocal(html);
        tradeHistory.insertAdjacentHTML('afterbegin', html);
      }

      const message = `
*Permintaan Penarikan Saldo*
*Option Trading*
Nominal: Rp ${amt.toLocaleString('id-ID')}
Rekening Tujuan: ${acc}
Metode: ${method}

*Setelah Mengirim Detail Ini, Silahkan Kembali Ke web Sebelumnya Dan Jangan Di Refresh!!*
      `.trim();

      const whatsappNumber = '6285697747768';
      const whatsappLink = `https://wa.me/${whatsappNumber}?text=${encodeURIComponent(message)}`;
      window.open(whatsappLink, '_blank');
    });

    // Init
    loadChart();
  </script>
</body>
</html>
