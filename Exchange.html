<!DOCTYPE html>

<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CryptoSim Exchange - 2Spot Trading Platform</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

```
    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 50%, #16213e 100%);
        color: white;
        min-height: 100vh;
    }

    .navbar {
        background: rgba(0, 0, 0, 0.9);
        backdrop-filter: blur(15px);
        padding: 1rem 2rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid #333;
        position: sticky;
        top: 0;
        z-index: 100;
    }

    .logo {
        font-size: 1.5rem;
        font-weight: bold;
        color: #00d4aa;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .nav-actions {
        display: flex;
        gap: 1rem;
        align-items: center;
    }

    .btn {
        padding: 0.5rem 1rem;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-block;
        font-size: 0.9rem;
    }

    .btn-primary {
        background: linear-gradient(45deg, #00d4aa, #007acc);
        color: white;
    }

    .btn-secondary {
        background: transparent;
        border: 1px solid #00d4aa;
        color: #00d4aa;
    }

    .btn-danger {
        background: linear-gradient(45deg, #ff4757, #ff3742);
        color: white;
    }

    .btn-success {
        background: linear-gradient(45deg, #26de81, #20bf6b);
        color: white;
    }

    .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 212, 170, 0.4);
    }

    .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 2rem;
    }

    .auth-modal, .trading-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 1000;
    }

    .modal-content {
        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        padding: 2rem;
        border-radius: 15px;
        width: 90%;
        max-width: 400px;
        border: 1px solid #333;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    }

    .trading-content {
        max-width: 600px;
    }

    .form-group {
        margin-bottom: 1rem;
    }

    .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        color: #00d4aa;
        font-weight: 500;
    }

    .form-group input {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid #333;
        border-radius: 8px;
        background: rgba(255, 255, 255, 0.1);
        color: white;
        font-size: 1rem;
    }

    .form-group input:focus {
        outline: none;
        border-color: #00d4aa;
        box-shadow: 0 0 10px rgba(0, 212, 170, 0.3);
    }

    .dashboard {
        display: none;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .stat-card {
        background: rgba(255, 255, 255, 0.1);
        padding: 2rem;
        border-radius: 15px;
        border: 1px solid #333;
        backdrop-filter: blur(15px);
        transition: transform 0.3s ease;
    }

    .stat-card:hover {
        transform: translateY(-5px);
    }

    .stat-title {
        color: #888;
        font-size: 0.9rem;
        margin-bottom: 0.5rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .stat-value {
        font-size: 2rem;
        font-weight: bold;
        margin-bottom: 0.5rem;
    }

    .stat-subtitle {
        font-size: 0.8rem;
        color: #666;
    }

    .coins-section {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 20px;
        padding: 2rem;
        margin-bottom: 2rem;
        border: 1px solid #333;
        backdrop-filter: blur(15px);
    }

    .section-title {
        font-size: 1.5rem;
        margin-bottom: 1.5rem;
        color: #00d4aa;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .coin-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1.5rem;
        background: rgba(255, 255, 255, 0.05);
        margin-bottom: 0.75rem;
        border-radius: 12px;
        border-left: 3px solid #00d4aa;
        transition: all 0.3s ease;
    }

    .coin-item:hover {
        background: rgba(255, 255, 255, 0.1);
        transform: translateX(5px);
    }

    .coin-info {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .coin-icon {
        width: 50px;
        height: 50px;
        background: linear-gradient(45deg, #00d4aa, #007acc);
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 1.2rem;
    }

    .coin-details h3 {
        margin-bottom: 0.25rem;
        font-size: 1.1rem;
    }

    .coin-supply {
        font-size: 0.8rem;
        color: #888;
    }

    .coin-actions {
        display: flex;
        gap: 0.5rem;
    }

    .price-display {
        text-align: right;
        margin-right: 1rem;
    }

    .price {
        font-size: 1.3rem;
        font-weight: bold;
        margin-bottom: 0.25rem;
    }

    .price-change {
        font-size: 0.9rem;
        padding: 0.25rem 0.5rem;
        border-radius: 6px;
        font-weight: 500;
    }

    .positive {
        color: #26de81;
        background: rgba(38, 222, 129, 0.1);
    }

    .negative {
        color: #fc5c65;
        background: rgba(252, 92, 101, 0.1);
    }

    .admin-panel {
        display: none;
    }

    .admin-form {
        background: rgba(0, 212, 170, 0.1);
        padding: 2rem;
        border-radius: 15px;
        margin-bottom: 1rem;
        border: 1px solid #00d4aa;
    }

    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
    }

    .btn-small {
        padding: 0.4rem 0.8rem;
        font-size: 0.8rem;
    }

    .balance-info {
        background: rgba(0, 212, 170, 0.1);
        padding: 1.5rem;
        border-radius: 12px;
        margin-bottom: 1.5rem;
        border: 1px solid #00d4aa;
    }

    .balance-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 0.5rem;
    }

    .portfolio-section {
        background: rgba(255, 255, 255, 0.05);
        padding: 1.5rem;
        border-radius: 12px;
        margin-top: 1rem;
    }

    .portfolio-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem;
        background: rgba(255, 255, 255, 0.05);
        margin-bottom: 0.5rem;
        border-radius: 8px;
    }

    .error {
        color: #fc5c65;
        font-size: 0.9rem;
        margin-top: 0.5rem;
        padding: 0.5rem;
        background: rgba(252, 92, 101, 0.1);
        border-radius: 6px;
    }

    .success {
        color: #26de81;
        font-size: 0.9rem;
        margin-top: 0.5rem;
        padding: 0.5rem;
        background: rgba(38, 222, 129, 0.1);
        border-radius: 6px;
    }

    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
    }

    @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }

    .live-price {
        animation: pulse 2s infinite;
    }

    .user-info {
        color: #00d4aa;
        font-size: 0.9rem;
        line-height: 1.2;
    }

    .bot-status {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: rgba(0, 212, 170, 0.9);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-size: 0.8rem;
        z-index: 100;
        animation: pulse 3s infinite;
    }

    .market-activity {
        background: rgba(255, 255, 255, 0.05);
        padding: 1rem;
        border-radius: 10px;
        margin-bottom: 1rem;
        max-height: 200px;
        overflow-y: auto;
    }

    .activity-item {
        padding: 0.5rem;
        border-left: 2px solid #00d4aa;
        margin-bottom: 0.5rem;
        font-size: 0.85rem;
    }

    .trade-controls {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
        margin-top: 1rem;
    }

    @media (max-width: 768px) {
        .container {
            padding: 1rem;
        }
        
        .stats-grid {
            grid-template-columns: 1fr;
        }
        
        .form-row {
            grid-template-columns: 1fr;
        }
        
        .trade-controls {
            grid-template-columns: 1fr;
        }
    }
</style>
```

</head>
<body>
    <!-- Firebase SDK -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-app.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-auth.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-firestore.js"></script>

```
<!-- Navbar -->
<nav class="navbar">
    <div class="logo">
        ðŸš€ CryptoSim Exchange
        <span style="font-size: 0.7rem; color: #888;">(SPOT)</span>
    </div>
    <div class="nav-actions">
        <div id="userInfo" class="user-info" style="display: none;"></div>
        <button id="loginBtn" class="btn btn-primary">Login</button>
        <button id="registerBtn" class="btn btn-secondary">Daftar</button>
        <button id="logoutBtn" class="btn btn-danger" style="display: none;">Logout</button>
    </div>
</nav>

<!-- Bot Status Indicator -->
<div class="bot-status">ðŸ¤– BOT AKTIF</div>

<!-- Auth Modal -->
<div id="authModal" class="auth-modal">
    <div class="modal-content">
        <h2 id="authTitle">Login</h2>
        <form id="authForm">
            <div class="form-group">
                <label for="email">Email:</label>
                <input type="email" id="email" required placeholder="your@email.com">
            </div>
            <div class="form-group">
                <label for="password">Password:</label>
                <input type="password" id="password" required placeholder="Password">
            </div>
            <div class="form-group">
                <button type="submit" class="btn btn-primary" style="width: 100%;">Login</button>
            </div>
            <div class="form-group">
                <button type="button" id="closeModal" class="btn btn-secondary" style="width: 100%;">Tutup</button>
            </div>
            <div id="authError" class="error" style="display: none;"></div>
            <div id="authSuccess" class="success" style="display: none;"></div>
        </form>
    </div>
</div>

<!-- Trading Modal -->
<div id="tradingModal" class="trading-modal">
    <div class="modal-content trading-content">
        <h2 id="tradingTitle">ðŸ’° Spot Trading</h2>
        <div class="balance-info">
            <div class="balance-row">
                <span>ðŸ’³ Available Balance:</span>
                <span><strong>$<span id="userBalance">0</span></strong></span>
            </div>
            <div class="balance-row">
                <span>ðŸª™ Selected Coin:</span>
                <span><strong><span id="selectedCoinName">-</span></strong></span>
            </div>
            <div class="balance-row">
                <span>ðŸ’° Current Price:</span>
                <span><strong>$<span id="selectedCoinPrice" class="live-price">0</span></strong></span>
            </div>
            <div class="balance-row">
                <span>ðŸ“Š Owned Amount:</span>
                <span><strong><span id="ownedAmount">0</span> coins</strong></span>
            </div>
        </div>

        <form id="tradingForm">
            <div class="form-group">
                <label for="tradeAmount">ðŸ’µ Amount to Trade ($):</label>
                <input type="number" id="tradeAmount" min="1" step="0.01" required placeholder="100.00">
                <small style="color: #888;">Minimum: $1.00</small>
            </div>
            
            <div class="trade-controls">
                <button type="button" id="buyBtn" class="btn btn-success">
                    ðŸŸ¢ BUY SPOT
                    <div style="font-size: 0.7rem;">Own Real Coins</div>
                </button>
                <button type="button" id="sellBtn" class="btn btn-danger">
                    ðŸ”´ SELL SPOT
                    <div style="font-size: 0.7rem;">Sell Owned Coins</div>
                </button>
            </div>
            
            <div class="form-group">
                <button type="button" id="closeTradingModal" class="btn btn-secondary" style="width: 100%; margin-top: 1rem;">Tutup</button>
            </div>
            <div id="tradingError" class="error" style="display: none;"></div>
            <div id="tradingSuccess" class="success" style="display: none;"></div>
        </form>

        <!-- Portfolio Section in Trading Modal -->
        <div class="portfolio-section" id="portfolioPreview">
            <h4>ðŸ“ˆ Your Portfolio</h4>
            <div id="portfolioList"></div>
        </div>
    </div>
</div>

<!-- Main Content -->
<div class="container">
    <!-- Dashboard -->
    <div id="dashboard" class="dashboard">
        <!-- Stats Grid -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-title">ðŸ’° Total Balance</div>
                <div class="stat-value positive">$<span id="totalBalance">1000</span></div>
                <div class="stat-subtitle">USD Available</div>
            </div>
            <div class="stat-card">
                <div class="stat-title">ðŸ“Š Portfolio Value</div>
                <div class="stat-value" id="portfolioValue">$0</div>
                <div class="stat-subtitle">Total Holdings</div>
            </div>
            <div class="stat-card">
                <div class="stat-title">ðŸ“ˆ Today's P&L</div>
                <div class="stat-value" id="todayPnL">$0</div>
                <div class="stat-subtitle">Profit & Loss</div>
            </div>
            <div class="stat-card">
                <div class="stat-title">ðŸŽ¯ Win Rate</div>
                <div class="stat-value" id="winRate">0%</div>
                <div class="stat-subtitle">Success Rate</div>
            </div>
        </div>

        <!-- Admin Panel -->
        <div id="adminPanel" class="admin-panel">
            <div class="coins-section">
                <h2 class="section-title">ðŸ”§ Admin Control Panel</h2>
                <div class="admin-form">
                    <h3>ðŸª™ Create New Coin</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Coin Name:</label>
                            <input type="text" id="coinName" placeholder="Bitcoin">
                        </div>
                        <div class="form-group">
                            <label>Symbol:</label>
                            <input type="text" id="coinSymbol" placeholder="BTC">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Initial Price ($):</label>
                            <input type="number" id="coinPrice" step="0.01" placeholder="50000">
                        </div>
                        <div class="form-group">
                            <label>Total Supply:</label>
                            <input type="number" id="coinSupply" placeholder="1000000">
                        </div>
                    </div>
                    <button id="createCoinBtn" class="btn btn-primary">ðŸš€ Launch Coin</button>
                </div>

                <!-- Market Activity Monitor -->
                <div class="admin-form">
                    <h3>ðŸ¤– Bot Trading Activity</h3>
                    <div class="market-activity" id="marketActivity">
                        <div class="activity-item">System initialized...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Coins List -->
        <div class="coins-section">
            <h2 class="section-title">ðŸ“Š Available Coins (Spot Trading)</h2>
            <div id="coinsList"></div>
        </div>

        <!-- User Portfolio -->
        <div class="coins-section" id="userPortfolioSection" style="display: none;">
            <h2 class="section-title">ðŸ’¼ My Portfolio</h2>
            <div id="userPortfolio"></div>
        </div>
    </div>

    <!-- Welcome Screen -->
    <div id="welcomeScreen">
        <div style="text-align: center; padding: 4rem 0;">
            <h1 style="font-size: 3rem; margin-bottom: 1rem;">ðŸš€ Welcome to CryptoSim</h1>
            <p style="font-size: 1.2rem; color: #888; margin-bottom: 1rem;">
                Platform crypto trading simulator dengan sistem SPOT trading
            </p>
            <p style="font-size: 1rem; color: #666; margin-bottom: 2rem;">
                âœ… Admin controls market â€¢ âœ… Bot auto-trading â€¢ âœ… Real coin ownership â€¢ âœ… Spot trading only
            </p>
            <div>
                <button class="btn btn-primary" style="margin-right: 1rem;" onclick="showAuthModal('login')">Login Sekarang</button>
                <button class="btn btn-secondary" onclick="showAuthModal('register')">Daftar Gratis</button>
            </div>
        </div>
    </div>
</div>

<script>
 /***********************
 *  Firebase Setup
 ***********************/
const firebaseConfig = {
    apiKey: "AIzaSyDVUEZ3ZVmH4ld7LVnEq_L368wEJpEs-l8",
    authDomain: "zeepaylater-93a94.firebaseapp.com",
    projectId: "zeepaylater-93a94",
    storageBucket: "zeepaylater-93a94.appspot.com",
    messagingSenderId: "358065954807",
    appId: "1:358065954807:web:66619211fea82a4b2518f2"
};

// Pakai SDK compat (global `firebase`)
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/***********************
 *  Admin & Auth (Mock)
 ***********************/
const ADMIN_UIDS = ['demo-admin-uid-123'];
function isUserAdmin(uid) {
    return ADMIN_UIDS.includes(uid);
}

// FIX: jangan pakai `this.currentUser` di arrow function
const mockAuth = {
    currentUser: null,
    signInWithEmailAndPassword: (email, password) => {
        return new Promise((resolve, reject) => {
            setTimeout(() => {
                if (email && password) {
                    const demoUID = email === 'admin@test.com' ? 'demo-admin-uid-123' : 'user_' + Date.now();
                    mockAuth.currentUser = { 
                        uid: demoUID, 
                        email: email,
                        isAdmin: isUserAdmin(demoUID)
                    };
                    resolve({ user: mockAuth.currentUser });
                } else {
                    reject(new Error('Invalid credentials'));
                }
            }, 1000);
        });
    },
    createUserWithEmailAndPassword: (email, password) => {
        return new Promise((resolve) => {
            setTimeout(() => {
                const newUID = 'user_' + Date.now() + Math.random().toString(36).substr(2, 9);
                mockAuth.currentUser = { 
                    uid: newUID, 
                    email: email,
                    isAdmin: isUserAdmin(newUID)
                };
                resolve({ user: mockAuth.currentUser });
            }, 1000);
        });
    },
    signOut: () => {
        mockAuth.currentUser = null;
        return Promise.resolve();
    }
};

/***********************
 *  In-Memory Data
 ***********************/
let userData = {
    balance: 1000, // ZRC
    coins: {},
    trades: []
};

let marketData = {
    coins: [
        {
            id: 'dmp',
            name: 'DampCoin',
            symbol: 'DMP',
            price: 10,
            change: 2.5,
            supply: 50_000_000,
            createdBy: 'system',
            botActive: true,
            volume24h: 0
        },
        {
            id: 'atm',
            name: 'AtomCoin',
            symbol: 'ATM',
            price: 5,
            change: -1.2,
            supply: 200_000_000,
            createdBy: 'system',
            botActive: true,
            volume24h: 0
        }
    ]
};

/***********************
 *  Trading Bot
 ***********************/
class TradingBot {
    constructor() {
        this.isActive = true;
        this.activityLog = [];
    }

    startTrading() {
        // interval acak 5â€“15 detik
        setInterval(() => {
            if (!this.isActive) return;
            marketData.coins.forEach(coin => {
                if (coin.botActive && currentUser?.isAdmin) {
                    this.simulateTrade(coin);
                }
            });
        }, Math.random() * 10000 + 5000);
    }

    simulateTrade(coin) {
        const tradeType = Math.random() < 0.5 ? 'buy' : 'sell';
        const tradeSize = Math.random() * 1000 + 100;

        let priceImpact = 0;
        if (tradeType === 'buy') {
            priceImpact = (tradeSize / (coin.supply * 0.001)) * (Math.random() * 0.05 + 0.01);
            coin.price += coin.price * priceImpact;
        } else {
            priceImpact = -(tradeSize / (coin.supply * 0.001)) * (Math.random() * 0.05 + 0.01);
            coin.price += coin.price * priceImpact;
        }

        coin.change += priceImpact * 100;
        if (coin.price < 0.01) coin.price = 0.01;
        coin.volume24h += tradeSize;

        const activity = {
            type: tradeType,
            coin: coin.symbol,
            size: tradeSize,
            priceImpact: priceImpact * 100,
            newPrice: coin.price,
            timestamp: new Date()
        };

        this.activityLog.push(activity);
        if (this.activityLog.length > 50) this.activityLog.shift();

        this.updateActivityDisplay(activity);
        saveMarketData();
    }

    updateActivityDisplay(activity) {
        const activityContainer = document.getElementById('marketActivity');
        if (!activityContainer) return;

        const el = document.createElement('div');
        el.className = 'activity-item';
        el.innerHTML = `
            <span style="color:${activity.type === 'buy' ? '#26de81' : '#fc5c65'}">
                ${activity.type === 'buy' ? 'ðŸŸ¢' : 'ðŸ”´'} BOT ${activity.type.toUpperCase()}
            </span>
            ${activity.coin}/ZRC ${activity.size.toFixed(0)} ZRC 
            (${activity.priceImpact >= 0 ? '+' : ''}${activity.priceImpact.toFixed(2)}%) 
            â†’ ${activity.newPrice.toFixed(2)} ZRC
        `;
        activityContainer.insertBefore(el, activityContainer.firstChild);

        const items = activityContainer.children;
        if (items.length > 20) activityContainer.removeChild(items[items.length - 1]);
    }

    activateForCoin(coinId) {
        const coin = marketData.coins.find(c => c.id === coinId);
        if (coin) {
            coin.botActive = true;
            console.log(`ðŸ¤– Bot diaktifkan untuk ${coin.symbol}`);
            saveMarketData();
        }
    }
}

const tradingBot = new TradingBot();

/***********************
 *  Globals & DOM refs
 ***********************/
let currentUser = null;
let isAuthMode = 'login';
let selectedCoin = null;
let priceUpdateInterval = null;

// DOM elements (akan di-assign setelah DOM siap)
let authModal, tradingModal, dashboard, welcomeScreen, authForm, coinsList;

/***********************
 *  UI Helpers
 ***********************/
function showError(elementId, message) {
    const element = document.getElementById(elementId);
    if (!element) return;
    element.textContent = message;
    element.style.display = 'block';
}

function showSuccess(elementId, message) {
    const element = document.getElementById(elementId);
    if (!element) return;
    element.textContent = message;
    element.style.display = 'block';
}

function clearAuthMessages() {
    const a = document.getElementById('authError');
    const b = document.getElementById('authSuccess');
    if (a) a.style.display = 'none';
    if (b) b.style.display = 'none';
}

function clearTradingMessages() {
    const a = document.getElementById('tradingError');
    const b = document.getElementById('tradingSuccess');
    if (a) a.style.display = 'none';
    if (b) b.style.display = 'none';
}

/***********************
 *  Screen Switchers
 ***********************/
function showDashboard() {
    welcomeScreen.style.display = 'none';
    dashboard.style.display = 'block';
    
    document.getElementById('loginBtn').style.display = 'none';
    document.getElementById('registerBtn').style.display = 'none';
    document.getElementById('logoutBtn').style.display = 'inline-block';
    document.getElementById('userInfo').style.display = 'inline-block';
    document.getElementById('userInfo').innerHTML = `
        ðŸ‘¤ ${currentUser.email}<br>
        ${currentUser.isAdmin ? '<span style="color:#ff4757;">[ADMIN]</span>' : ''}
    `;

    document.getElementById('adminPanel').style.display = currentUser.isAdmin ? 'block' : 'none';
    document.getElementById('userPortfolioSection').style.display = 'block';

    updateDashboard();
    updateCoinsList();
    updatePortfolio();

    if (currentUser.isAdmin && !priceUpdateInterval) {
        tradingBot.startTrading();
        priceUpdateInterval = setInterval(() => {}, 5000);
    }
}

function showWelcomeScreen() {
    welcomeScreen.style.display = 'block';
    dashboard.style.display = 'none';
    document.getElementById('loginBtn').style.display = 'inline-block';
    document.getElementById('registerBtn').style.display = 'inline-block';
    document.getElementById('logoutBtn').style.display = 'none';
    document.getElementById('userInfo').style.display = 'none';
    document.getElementById('adminPanel').style.display = 'none';
    document.getElementById('userPortfolioSection').style.display = 'none';
}

/***********************
 *  Dashboard Updaters
 ***********************/
function updateDashboard() {
    const totalBalanceEl = document.getElementById('totalBalance');
    if (totalBalanceEl) totalBalanceEl.textContent = userData.balance.toFixed(2);

    let portfolioValue = 0;
    for (const coinId in userData.coins) {
        const coin = marketData.coins.find(c => c.id === coinId);
        if (coin) portfolioValue += userData.coins[coinId].amount * coin.price;
    }
    const portfolioValueEl = document.getElementById('portfolioValue');
    if (portfolioValueEl) portfolioValueEl.textContent = `${portfolioValue.toFixed(2)} ZRC`;

    let todayPnL = 0;
    userData.trades.forEach(trade => {
        if (new Date(trade.timestamp).toDateString() === new Date().toDateString()) {
            todayPnL += trade.type === 'buy' ? -trade.total : trade.total;
        }
    });
    const todayPnLEl = document.getElementById('todayPnL');
    if (todayPnLEl) {
        todayPnLEl.textContent = `${todayPnL >= 0 ? '+' : ''}${todayPnL.toFixed(2)} ZRC`;
        todayPnLEl.className = `stat-value ${todayPnL >= 0 ? 'positive' : 'negative'}`;
    }

    const totalTrades = userData.trades.length;
    const winningTrades = userData.trades.filter(trade => trade.profit > 0).length;
    const winRate = totalTrades > 0 ? (winningTrades / totalTrades * 100).toFixed(1) : 0;
    const winRateEl = document.getElementById('winRate');
    if (winRateEl) winRateEl.textContent = `${winRate}%`;
}

function updateCoinsList() {
    if (!coinsList) return;
    coinsList.innerHTML = '';
    marketData.coins.forEach(coin => {
        const coinElement = document.createElement('div');
        coinElement.className = 'coin-item';
        coinElement.innerHTML = `
            <div class="coin-info">
                <div class="coin-icon">${coin.symbol}</div>
                <div class="coin-details">
                    <h3>${coin.name} (${coin.symbol}/ZRC)</h3>
                    <div class="coin-supply">Total Supply: ${coin.supply.toLocaleString()}</div>
                </div>
            </div>
            <div class="price-display">
                <div class="price live-price">${coin.price.toFixed(2)} ZRC</div>
                <div class="price-change ${coin.change >= 0 ? 'positive' : 'negative'}">
                    ${coin.change >= 0 ? '+' : ''}${coin.change.toFixed(2)}%
                </div>
            </div>
            <div class="coin-actions">
                <button class="btn btn-small btn-primary" data-coin-id="${coin.id}">Trade</button>
            </div>
        `;
        coinsList.appendChild(coinElement);
    });

    // delegate tombol trade
    coinsList.querySelectorAll('button[data-coin-id]').forEach(btn => {
        btn.addEventListener('click', () => openTradingModal(btn.dataset.coinId));
    });
}

function updatePortfolio() {
    const portfolioList = document.getElementById('userPortfolio');
    if (!portfolioList) return;
    portfolioList.innerHTML = '';
    
    for (const coinId in userData.coins) {
        const coin = marketData.coins.find(c => c.id === coinId);
        if (coin && userData.coins[coinId].amount > 0) {
            const currentValue = userData.coins[coinId].amount * coin.price;
            const profit = currentValue - userData.coins[coinId].totalInvested;
            const item = document.createElement('div');
            item.className = 'portfolio-item';
            item.innerHTML = `
                <div>
                    <strong>${coin.name} (${coin.symbol})</strong><br>
                    Jumlah: ${userData.coins[coinId].amount.toFixed(6)}<br>
                    Harga Beli Rata-rata: ${userData.coins[coinId].avgPrice.toFixed(2)} ZRC
                </div>
                <div style="text-align:right;">
                    Nilai: ${currentValue.toFixed(2)} ZRC<br>
                    <span class="${profit >= 0 ? 'positive' : 'negative'}">
                        P&L: ${profit >= 0 ? '+' : ''}${profit.toFixed(2)} ZRC
                    </span>
                </div>
            `;
            portfolioList.appendChild(item);
        }
    }

    const preview = document.getElementById('portfolioList');
    if (preview) preview.innerHTML = portfolioList.innerHTML;
}

/***********************
 *  Modals & Trading
 ***********************/
function openTradingModal(coinId) {
    selectedCoin = marketData.coins.find(c => c.id === coinId);
    if (!selectedCoin) {
        console.error('Koin tidak ditemukan:', coinId);
        return;
    }

    tradingModal.style.display = 'flex';
    document.getElementById('tradingTitle').textContent = `ðŸ’° Spot Trading - ${selectedCoin.name}`;
    document.getElementById('selectedCoinName').textContent = `${selectedCoin.name} (${selectedCoin.symbol}/ZRC)`;
    document.getElementById('selectedCoinPrice').textContent = selectedCoin.price.toFixed(2);
    document.getElementById('userBalance').textContent = userData.balance.toFixed(2);
    document.getElementById('ownedAmount').textContent = userData.coins[coinId]?.amount?.toFixed(6) || '0';
    console.log('Modal trading ditampilkan untuk koin:', selectedCoin.symbol);
}

async function executeSpotTrade(type) {
    const amount = parseFloat(document.getElementById('tradeAmount').value);
    if (!selectedCoin || isNaN(amount) || amount <= 0) {
        showError('trtingError' /* sengaja salah? tidak */, 'Masukkan jumlah trade yang valid');
        // FIX typo id elemen: gunakan id yang benar
        showError('tradingError', 'Masukkan jumlah trade yang valid');
        return;
    }

    const totalCost = amount; // ZRC yang dipakai
    const coinAmount = amount / selectedCoin.price;

    if (type === 'buy') {
        if (totalCost > userData.balance) {
            showError('tradingError', 'Saldo ZRC tidak cukup');
            return;
        }

        userData.balance -= totalCost;
        if (!userData.coins[selectedCoin.id]) {
            userData.coins[selectedCoin.id] = { amount: 0, avgPrice: 0, totalInvested: 0 };
        }

        userData.coins[selectedCoin.id].amount += coinAmount;
        userData.coins[selectedCoin.id].totalInvested += totalCost;
        userData.coins[selectedCoin.id].avgPrice =
            userData.coins[selectedCoin.id].totalInvested / userData.coins[selectedCoin.id].amount;

        userData.trades.push({
            type: 'buy',
            coinId: selectedCoin.id,
            coinName: selectedCoin.name,
            amount: coinAmount,
            price: selectedCoin.price,
            total: totalCost,
            timestamp: new Date(),
            profit: 0
        });

        showSuccess('tradingSuccess', `Berhasil beli ${coinAmount.toFixed(6)} ${selectedCoin.symbol}`);
    } else {
        const ownedAmount = userData.coins[selectedCoin.id]?.amount || 0;
        if (coinAmount > ownedAmount) {
            showError('tradingError', 'Jumlah koin tidak cukup');
            return;
        }

        userData.balance += totalCost;
        userData.coins[selectedCoin.id].amount -= coinAmount;
        userData.coins[selectedCoin.id].totalInvested -= (coinAmount * userData.coins[selectedCoin.id].avgPrice);

        const profit = (selectedCoin.price - userData.coins[selectedCoin.id].avgPrice) * coinAmount;
        userData.trades.push({
            type: 'sell',
            coinId: selectedCoin.id,
            coinName: selectedCoin.name,
            amount: coinAmount,
            price: selectedCoin.price,
            total: totalCost,
            timestamp: new Date(),
            profit: profit
        });

        if (userData.coins[selectedCoin.id].amount <= 0) {
            delete userData.coins[selectedCoin.id];
        } else {
            userData.coins[selectedCoin.id].avgPrice =
                userData.coins[selectedCoin.id].totalInvested / userData.coins[selectedCoin.id].amount;
        }

        showSuccess('tradingSuccess', `Berhasil jual ${coinAmount.toFixed(6)} ${selectedCoin.symbol}`);
    }

    await saveUserData();
    updateDashboard();
    updatePortfolio();
    document.getElementById('userBalance').textContent = userData.balance.toFixed(2);
    document.getElementById('ownedAmount').textContent = userData.coins[selectedCoin.id]?.amount?.toFixed(6) || '0';
    document.getElementById('tradeAmount').value = '';
    setTimeout(clearTradingMessages, 3000);
}

/***********************
 *  Firestore Data Ops
 ***********************/
async function initializeUserData(uid) {
    userData = {
        uid: uid,
        balance: 1000,
        coins: {},
        trades: [],
        isAdmin: isUserAdmin(uid),
        createdAt: new Date()
    };

    try {
        await db.collection('users').doc(uid).set({
            balance: 1000,
            coins: {},
            trades: [],
            isAdmin: isUserAdmin(uid),
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        console.log('User data diinisialisasi untuk UID:', uid);
    } catch (error) {
        console.error('Error inisialisasi data user:', error);
    }
}

async function loadUserData(uid) {
    try {
        const snap = await db.collection('users').doc(uid).get();
        if (snap.exists) {
            userData = { uid: uid, ...snap.data() };
            userData.isAdmin = isUserAdmin(uid);
            console.log('User data dimuat:', userData);
        } else {
            await initializeUserData(uid);
        }
    } catch (error) {
        console.error('Error load data user:', error);
        await initializeUserData(uid);
    }
}

async function saveUserData() {
    try {
        await db.collection('users').doc(userData.uid).set({
            balance: userData.balance,
            coins: userData.coins,
            trades: userData.trades,
            isAdmin: userData.isAdmin,
            lastUpdated: firebase.firestore.FieldValue.serverTimestamp(),
            createdAt: userData.createdAt || firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true });
        console.log('User data disimpan:', userData);
    } catch (error) {
        console.error('Error simpan data user:', error);
    }
}

async function loadMarketData() {
    try {
        const snap = await db.collection('market').doc('coins').get();
        if (snap.exists) {
            marketData.coins = snap.data().coins || [];
            console.log('Market data dimuat:', marketData.coins);
        } else {
            await saveMarketData();
        }
    } catch (error) {
        console.error('Error load data market:', error);
    }

    // Real-time listener
    db.collection('market').doc('coins').onSnapshot((doc) => {
        if (doc.exists) {
            marketData.coins = doc.data().coins || [];
            updateCoinsList();
            updatePortfolio();
            updateDashboard();
            console.log('Market data updated via listener:', marketData.coins);
        }
    });
}

async function saveMarketData() {
    try {
        await db.collection('market').doc('coins').set({
            coins: marketData.coins,
            lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
        });
        console.log('Market data disimpan:', marketData.coins);
    } catch (error) {
        console.error('Error simpan data market:', error);
    }
}

/***********************
 *  Auth Handlers
 ***********************/
function showAuthModal(mode) {
    isAuthMode = mode;
    document.getElementById('authTitle').textContent = mode === 'login' ? 'Login' : 'Daftar Akun Baru';
    const submitBtn = document.querySelector('#authForm button[type="submit"]');
    if (submitBtn) submitBtn.textContent = mode === 'login' ? 'Login' : 'Daftar';
    authModal.style.display = 'flex';
}

function closeAuthModal() {
    authModal.style.display = 'none';
    clearAuthMessages();
}

function closeTradingModal() {
    tradingModal.style.display = 'none';
    clearTradingMessages();
}

async function handleAuth(e) {
    e.preventDefault();
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value;

    try {
        let result;
        if (isAuthMode === 'login') {
            result = await mockAuth.signInWithEmailAndPassword(email, password);
        } else {
            result = await mockAuth.createUserWithEmailAndPassword(email, password);
            await initializeUserData(result.user.uid);
        }

        currentUser = result.user;
        await loadUserData(currentUser.uid);
        currentUser.isAdmin = isUserAdmin(currentUser.uid);
        
        showSuccess('authSuccess', `${isAuthMode === 'login' ? 'Login' : 'Registrasi'} berhasil!`);
        
        setTimeout(() => {
            closeAuthModal();
            showDashboard();
        }, 1500);

    } catch (error) {
        showError('authError', error.message);
    }
}

async function logout() {
    await mockAuth.signOut();
    currentUser = null;
    if (priceUpdateInterval) {
        clearInterval(priceUpdateInterval);
        priceUpdateInterval = null;
    }
    showWelcomeScreen();
}

/***********************
 *  Bootstrapping DOM
 ***********************/
document.addEventListener('DOMContentLoaded', () => {
    // Assign DOM refs setelah HTML siap
    authModal = document.getElementById('authModal');
    tradingModal = document.getElementById('tradingModal');
    dashboard = document.getElementById('dashboard');
    welcomeScreen = document.getElementById('welcomeScreen');
    authForm = document.getElementById('authForm');
    coinsList = document.getElementById('coinsList');

    // Event Listeners tombol
    const btnLogin = document.getElementById('loginBtn');
    const btnRegister = document.getElementById('registerBtn');
    const btnWelcomeLogin = document.getElementById('welcomeLoginBtn');
    const btnWelcomeRegister = document.getElementById('welcomeRegisterBtn');
    const btnLogout = document.getElementById('logoutBtn');
    const btnCloseAuth = document.getElementById('closeModal');
    const btnCloseTrading = document.getElementById('closeTradingModal');
    const btnCreateCoin = document.getElementById('createCoinBtn');
    const btnBuy = document.getElementById('buyBtn');
    const btnSell = document.getElementById('sellBtn');

    if (btnLogin) btnLogin.addEventListener('click', () => showAuthModal('login'));
    if (btnRegister) btnRegister.addEventListener('click', () => showAuthModal('register'));
    if (btnWelcomeLogin) btnWelcomeLogin.addEventListener('click', () => showAuthModal('login'));
    if (btnWelcomeRegister) btnWelcomeRegister.addEventListener('click', () => showAuthModal('register'));
    if (btnLogout) btnLogout.addEventListener('click', logout);
    if (btnCloseAuth) btnCloseAuth.addEventListener('click', closeAuthModal);
    if (btnCloseTrading) btnCloseTrading.addEventListener('click', closeTradingModal);
    if (btnCreateCoin) btnCreateCoin.addEventListener('click', createCoin);
    if (btnBuy) btnBuy.addEventListener('click', () => executeSpotTrade('buy'));
    if (btnSell) btnSell.addEventListener('click', () => executeSpotTrade('sell'));
    if (authForm) authForm.addEventListener('submit', handleAuth);

    // Initial render
    showWelcomeScreen();
    updateCoinsList();
    loadMarketData();
});


</script>
```

</body>
</html>
