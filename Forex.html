<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Trading Panel — SPA + Firebase (Engine All Markets)</title>
<style>
  :root{
    --bg:#071026; --panel:#0f1724; --muted:#9fb0d6; --text:#dbe7ff;
    --green:#2dd36f; --red:#ff5c5c; --glass: rgba(255,255,255,0.03);
  }
  html,body{height:100%;margin:0;background:linear-gradient(180deg,#071026,#071827);color:var(--text);font-family:Inter, Arial}
  .app{display:flex;flex-direction:column;min-height:100vh}
  .main{display:flex;gap:12px;padding:12px;box-sizing:border-box;flex:1}
  .left{flex:1}
  .right{width:360px}
  .panel{background:var(--panel);padding:12px;border-radius:12px;box-shadow:0 8px 30px rgba(0,0,0,0.6);margin-bottom:12px}
  .chart-wrap{height:420px; min-height:320px; border-radius:10px; overflow:hidden; display:flex;flex-direction:column}
  canvas{width:100%;height:100%; display:block; touch-action:none; user-select:none}
  .bottom-nav{position:fixed;left:12px;right:12px;bottom:12px;display:flex;justify-content:space-around;background:rgba(15,23,36,0.95);padding:8px;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,0.6);z-index:1000}
  .nav-btn{background:transparent;border:0;color:var(--text);padding:10px 12px;border-radius:8px;cursor:pointer;font-weight:700}
  .nav-btn.active{background:rgba(255,255,255,0.03)}
  .list{display:flex;flex-direction:column;gap:8px}
  .list-item{padding:10px;border-radius:8px;background:rgba(255,255,255,0.02);display:flex;justify-content:space-between;align-items:center}
  .small{font-size:13px;color:var(--muted)}
  .btn{padding:8px 10px;border-radius:8px;border:0;cursor:pointer;font-weight:700}
  .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--text)}
  .btn-primary{background:linear-gradient(180deg,var(--green),#11b85a);color:#04260f}
  .btn-danger{background:linear-gradient(180deg,#ff7b7b,var(--red));color:#2b0606}
  .flex{display:flex;gap:8px;align-items:center}
  @media(max-width:900px){
    .main{flex-direction:column}
    .right{width:100%}
  }
</style>
</head>
<body>
<div class="app">
  <div class="main">
    <div class="left">
      <div id="page-home" class="panel">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><h3 style="margin:0">Home</h3><div class="small">Saldo & Market</div></div>
          <div class="flex">
            <div style="text-align:right"><div class="small">Balance</div><div id="homeBalance">—</div></div>
            <div style="width:10px"></div>
            <div style="text-align:right"><div class="small">Equity</div><div id="homeEquity">—</div></div>
          </div>
        </div>

        <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn btn-ghost" id="homeDeposit">Deposit</button>
          <button class="btn btn-ghost" id="homeWithdraw">Withdraw</button>
          <button class="btn btn-ghost" id="homeOpenOrders">Transaksi Terbuka</button>
          <button class="btn btn-ghost" id="homeMarkets">Daftar Market</button>
        </div>

        <div style="margin-top:12px">
          <div class="small">Pilih market untuk buka view market</div>
          <div id="homeMarketList" class="list" style="margin-top:8px;max-height:240px;overflow:auto"></div>
        </div>
      </div>

      <div id="page-market" class="panel" style="display:none">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <h3 id="marketTitle" style="margin:0">Market</h3>
            <div class="small" id="marketSub">—</div>
          </div>
          <div class="flex">
            <div style="text-align:right"><div class="small">Balance</div><div id="marketBalance">—</div></div>
          </div>
        </div>

        <div style="margin-top:8px" class="chart-wrap">
          <canvas id="chartCanvas"></canvas>
        </div>

        <div style="display:flex;gap:8px;align-items:center;margin-top:8px;justify-content:space-between">
          <div style="display:flex;gap:8px">
            <button class="btn btn-primary" id="pageBuy">BUY</button>
            <button class="btn btn-danger" id="pageSell">SELL</button>
            <button class="btn btn-ghost" id="pageCloseAll">Close All (device)</button>
          </div>
          <div style="display:flex;gap:8px;align-items:center">
            <select id="pageTimeframe">
              <option value="1000">1s</option>
              <option value="60000">1m</option>
              <option value="300000">5m</option>
              <option value="900000">15m</option>
              <option value="1800000">30m</option>
              <option value="3600000">1h</option>
              <option value="86400000">1d</option>
            </select>
            <div class="small">Visible: <span id="visibleCount">—</span></div>
          </div>
        </div>

        <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
          <div style="flex:1;display:flex;gap:8px;align-items:center">
            <div style="width:120px"><label class="small">Lot</label><input id="pageLot" type="number" value="0.1" step="0.1" style="width:100%"/></div>
            <div style="width:120px"><label class="small">TP (pips)</label><input id="pageTP" type="number" value="20" style="width:100%"/></div>
            <div style="width:120px"><label class="small">SL (pips)</label><input id="pageSL" type="number" value="20" style="width:100%"/></div>
          </div>
        </div>

      </div>

      <div id="page-transactions" class="panel" style="display:none">
        <h3 style="margin:0">Transaksi</h3>
        <div class="small">Margin & transaksi device ini</div>
        <div style="display:flex;gap:12px;margin-top:8px">
          <div style="flex:1" class="panel">
            <div class="small">Margin Used</div>
            <div id="marginUsed">—</div>
            <div class="small" style="margin-top:8px">Margin Free</div>
            <div id="marginFree">—</div>
            <div style="margin-top:8px"><label class="small">Leverage</label><input id="leverage" type="number" value="100" style="width:100%"/></div>
          </div>
          <div style="flex:1" class="panel">
            <div class="small">Open Orders (device)</div>
            <div id="txOpenList" class="list" style="max-height:200px;overflow:auto;margin-top:8px"></div>
            <div style="margin-top:8px"><button class="btn btn-ghost" id="closeAllBtn">Close All Orders (device)</button></div>
          </div>
        </div>

        <div style="margin-top:12px">
          <div class="small">Closed Orders (device)</div>
          <div id="txClosedList" class="list" style="max-height:200px;overflow:auto;margin-top:8px"></div>
        </div>
      </div>

      <div id="page-settings" class="panel" style="display:none">
        <h3 style="margin:0">Pengaturan</h3>
        <div class="small">Akun & preferensi</div>
        <div style="margin-top:8px">
          <div class="small">User</div>
          <div id="settingsUser" style="font-weight:700">—</div>
          <div class="small">UID</div>
          <div id="settingsUID">—</div>
          <div style="margin-top:8px">
            <button class="btn btn-ghost" id="btnSignInGoogle">Sign in (Google)</button>
            <button class="btn btn-ghost" id="btnSignOut">Sign out</button>
          </div>
          <div style="margin-top:8px">
            <div class="small">Leverage Default</div>
            <input id="settingsLeverage" type="number" value="100" style="width:100%"/>
          </div>
        </div>
      </div>

      <div id="page-admin" class="panel" style="display:none">
        <h3 style="margin:0">Admin Panel</h3>
        <div class="small">Hanya terlihat kalau login admin</div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button class="btn btn-ghost" id="adminCreateMarket">Create Market</button>
          <button class="btn btn-ghost" id="adminListMarkets">List Markets</button>
          <button class="btn btn-ghost" id="adminEngineToggle">Start Engine (All Markets)</button>
        </div>
        <div style="margin-top:8px">
          <div class="small">Global Volatility</div>
          <input id="adminVol" type="range" min="0.2" max="5.0" step="0.1" value="1.0"/>
        </div>
        <div style="margin-top:8px">
          <div class="small">Orders (market selected)</div>
          <div id="adminOrders" style="max-height:220px;overflow:auto;margin-top:8px"></div>
        </div>
      </div>
    </div>

    <div class="right">
      <div class="panel">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><strong>Quick</strong><div class="small">Info akun & market</div></div>
          <div style="text-align:right"><div class="small">Price</div><div id="quickPrice">—</div></div>
        </div>

        <div style="margin-top:8px">
          <div class="small">Selected Market</div>
          <div id="selectedMarketName" style="font-weight:700">—</div>
          <div style="margin-top:8px" class="small">Actions</div>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button class="btn btn-ghost" id="btnViewMarket">View Market</button>
            <button class="btn btn-ghost" id="btnOpenTxPage">Open Transactions</button>
          </div>
        </div>

      </div>

      <div class="panel">
        <div class="small">History recent (device)</div>
        <div id="rightHistory" style="max-height:320px;overflow:auto;margin-top:8px"></div>
      </div>
    </div>
  </div>

  <div class="bottom-nav" id="bottomNav">
    <button class="nav-btn active" data-page="home" id="navHome">Home</button>
    <button class="nav-btn" data-page="markets" id="navMarkets">Markets</button>
    <button class="nav-btn" data-page="view" id="navView">View Market</button>
    <button class="nav-btn" data-page="tx" id="navTx">Transactions</button>
    <button class="nav-btn" data-page="settings" id="navSettings">Settings</button>
    <button class="nav-btn" data-page="admin" id="navAdmin" style="display:none">Admin</button>
  </div>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

<script>
/* ========== CONFIG ========== */
const firebaseConfig = {
  apiKey: "AIzaSyDVUEZ3ZVmH4ld7LVnEq_L368wEJpEs-l8",
  authDomain: "zeepaylater-93a94.firebaseapp.com",
  projectId: "zeepaylater-93a94",
  storageBucket: "zeepaylater-93a94.appspot.com",
  messagingSenderId: "358065954807",
  appId: "1:358065954807:web:66619211fea82a4b2518f2"
};
const ADMIN_UID = 'viCOsJo4wHVFmhtpmMx1Wd4sDF52';
/* ================================= */

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

/* ========== device & balance ========== */
let deviceId = localStorage.getItem('device_id');
if(!deviceId){ deviceId = 'dev-' + Math.floor(Math.random()*10000000); localStorage.setItem('device_id', deviceId); }
let localBalanceKey = 'balance_' + deviceId;
let balance = parseFloat(localStorage.getItem(localBalanceKey)) || 1000.0;
let equity = balance;
document.getElementById('homeBalance').innerText = balance.toFixed(2);
document.getElementById('marketBalance').innerText = balance.toFixed(2);

/* ========== canvas/chart ========== */
const canvas = document.getElementById('chartCanvas');
const ctx = canvas.getContext('2d');
let DPR = window.devicePixelRatio || 1;
function resizeCanvas(){ const r = canvas.getBoundingClientRect(); canvas.width = Math.floor(r.width*DPR); canvas.height = Math.floor(r.height*DPR); ctx.setTransform(DPR,0,0,DPR,0,0); }
window.addEventListener('resize', ()=>{ resizeCanvas(); draw(); });
resizeCanvas();

/* data state */
let priceHistory = [];
let candles = [];
let timeframeMs = parseInt(document.getElementById('pageTimeframe').value || '1000');
let userTimeframeOverride = false;
let lastTickTime = 0;

/* pan/zoom */
let visibleSlotsOverride = null;
let historyOffset = 0;
let MIN_VISIBLE_CANDLES = 20, MAX_VISIBLE_CANDLES = 300;
let LEFT_MARGIN = 40, RIGHT_MARGIN = 90;

/* orders & user & market */
let ordersSnapshot = [];
let currentUser = null;
let currentMarketId = null;
let currentMarket = null;
let unsubscribeMarket = null, unsubscribeOrders = null;

/* engine control for ALL markets */
let engineAllInterval = null;
let engineAllRunning = false;

/* refs */
const homeMarketList = document.getElementById('homeMarketList');
const selectedMarketName = document.getElementById('selectedMarketName');
const quickPrice = document.getElementById('quickPrice');

/* helpers */
function formatPrice(p){ return p ? p.toFixed(5) : '—'; }
function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }
function toPips(a,b){ return Math.round((a-b)/0.0001); }

/* ---------- SPA navigation ---------- */
const pages = {
  home: document.getElementById('page-home'),
  market: document.getElementById('page-market'),
  tx: document.getElementById('page-transactions'),
  settings: document.getElementById('page-settings'),
  admin: document.getElementById('page-admin')
};
function showPage(name){
  Object.values(pages).forEach(p=>p.style.display='none');
  if(name === 'home') pages.home.style.display='block';
  if(name === 'market') pages.market.style.display='block';
  if(name === 'tx') pages.tx.style.display='block';
  if(name === 'settings') pages.settings.style.display='block';
  if(name === 'admin') pages.admin.style.display='block';
  document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
  const active = {home:'navHome', markets:'navMarkets', view:'navView', tx:'navTx', settings:'navSettings', admin:'navAdmin'}[name];
  if(active) document.getElementById(active).classList.add('active');
}
document.getElementById('navHome').addEventListener('click',()=>showPage('home'));
document.getElementById('navMarkets').addEventListener('click',()=>{ showPage('home'); document.getElementById('homeMarkets').click(); });
document.getElementById('navView').addEventListener('click',()=>{ openSelectedMarketView(); });
document.getElementById('navTx').addEventListener('click',()=>showPage('tx'));
document.getElementById('navSettings').addEventListener('click',()=>showPage('settings'));
document.getElementById('navAdmin').addEventListener('click',()=>showPage('admin'));
showPage('home');

/* ---------- Market list for Home ---------- */
async function listMarketsToHome(){
  homeMarketList.innerHTML = '';
  const snap = await db.collection('markets').orderBy('createdAt','desc').get();
  snap.forEach(doc=>{
    const m = doc.data(); m.id = doc.id;
    const el = document.createElement('div'); el.className='list-item';
    el.innerHTML = `<div>
      <div style="font-weight:700">${m.name}</div>
      <div class="small">price: ${formatPrice(m.price)}</div>
    </div>
    <div style="display:flex;flex-direction:column;gap:6px;align-items:flex-end">
      <button class="btn btn-ghost" data-id="${m.id}">Open</button>
      <div class="small">vol:${m.volatility||1.0}</div>
    </div>`;
    el.querySelector('button').addEventListener('click', ()=>{ selectMarketFromHome(m.id); });
    homeMarketList.appendChild(el);
  });
}

async function selectMarketFromHome(marketId){
  currentMarketId = marketId;
  document.getElementById('selectedMarketName').innerText = marketId;
  await selectMarket(marketId);
  showPage('market');
}

function openSelectedMarketView(){
  if(currentMarketId) { showPage('market'); return; }
  db.collection('markets').orderBy('createdAt','desc').limit(1).get().then(snap=>{
    const doc = snap.docs[0];
    if(doc) selectMarket(doc.id).then(()=>showPage('market'));
  });
}

/* ---------- load ticks for market from ticks subcollection ---------- */
async function loadTicksForMarket(marketId){
  priceHistory = [];
  lastTickTime = 0;
  try {
    const q = db.collection('markets').doc(marketId).collection('ticks').orderBy('ts','asc').limit(5000);
    const snap = await q.get();
    snap.forEach(d=>{
      const data = d.data();
      const t = data.ts && data.ts.toMillis ? data.ts.toMillis() : (data.t || Date.now());
      priceHistory.push({t, price: data.price});
      lastTickTime = Math.max(lastTickTime, t);
    });
    rebuildCandlesFromHistory();
  } catch(e){
    console.error('loadTicks err', e);
  }
}

/* ---------- select market & subscribe ---------- */
async function selectMarket(marketId){
  if(unsubscribeMarket) unsubscribeMarket();
  if(unsubscribeOrders) unsubscribeOrders();
  currentMarketId = marketId;
  currentMarket = null;
  ordersSnapshot = [];
  priceHistory = []; candles = []; historyOffset = 0; visibleSlotsOverride = null;
  document.getElementById('selectedMarketName').innerText = marketId || '—';
  await loadTicksForMarket(marketId);
  const ref = db.collection('markets').doc(marketId);
  unsubscribeMarket = ref.onSnapshot(doc=>{
    if(!doc.exists) return;
    const m = doc.data();
    currentMarket = { id: doc.id, ...m };
    document.getElementById('marketTitle').innerText = m.name;
    document.getElementById('marketSub').innerText = 'Price: ' + formatPrice(m.price);
    quickPrice.innerText = formatPrice(m.price);
    document.getElementById('homeBalance').innerText = balance.toFixed(2);
    document.getElementById('marketBalance').innerText = balance.toFixed(2);
    if(!userTimeframeOverride){
      timeframeMs = m.timeframeMs || timeframeMs;
      document.getElementById('pageTimeframe').value = String(timeframeMs);
    }
    const stamp = (m.lastUpdate && m.lastUpdate.toMillis) ? m.lastUpdate.toMillis() : Date.now();
    if(stamp > lastTickTime - 1){
      priceHistory.push({t: stamp, price: m.price});
      lastTickTime = Math.max(lastTickTime, stamp);
      rebuildCandlesFromHistory();
    }
    draw();
  });

  unsubscribeOrders = db.collection('markets').doc(marketId).collection('orders').orderBy('createdAt','desc').onSnapshot(snap=>{
    ordersSnapshot = [];
    snap.forEach(d=>{ const o = d.data(); o.id = d.id; ordersSnapshot.push(o); });
    renderOrdersUI();
    renderAdminOrders();
  });

  document.getElementById('pageTimeframe').value = String(timeframeMs);
  document.getElementById('marketTitle').innerText = currentMarket ? currentMarket.name : 'Market';
  draw();
}

/* ---------- write tick helper (persist) ---------- */
async function writeTickToFirestore(marketId, price){
  try{
    const tickRef = db.collection('markets').doc(marketId).collection('ticks');
    await tickRef.add({ price, ts: firebase.firestore.FieldValue.serverTimestamp() });
  } catch(e){
    console.error('writeTick err', e);
  }
}

/* ========== ENGINE: START/STOP FOR ALL MARKETS ========== */
/* When admin clicks Start Engine, engine will now update ALL markets continuously.
   For each market:
    - compute new price
    - update market doc (price, lastUpdate)
    - write tick to ticks subcollection
    - check open orders in that market and auto-close TP/SL */
document.getElementById('adminEngineToggle').addEventListener('click', async ()=>{
  if(!currentUser || currentUser.uid !== ADMIN_UID) return alert('Only admin');
  engineAllRunning = !engineAllRunning;
  document.getElementById('adminEngineToggle').innerText = engineAllRunning ? 'Stop Engine (All)' : 'Start Engine (All)';
  if(engineAllRunning) startEngineAll(); else stopEngineAll();
});

function stopEngineAll(){
  if(engineAllInterval) clearInterval(engineAllInterval);
  engineAllInterval = null;
  engineAllRunning = false;
}

/* start engine for all markets */
function startEngineAll(){
  // interval tick (ms)
  const TICK_MS = 600;
  // not re-enter if already running
  if(engineAllInterval) return;
  engineAllInterval = setInterval(async ()=>{
    try {
      const marketsSnap = await db.collection('markets').get();
      // process each market sequentially to avoid too many concurrent requests, but you can parallelize if desired
      for(const mdoc of marketsSnap.docs){
        try {
          const mid = mdoc.id;
          const m = mdoc.data();
          // get volatility from market doc (or global admin vol fallback)
          const marketVol = (m.volatility !== undefined) ? m.volatility : (parseFloat(document.getElementById('adminVol').value) || 1.0);
          let vol = marketVol;
          let mode = m.engineMode || 'normal';
          // price step logic (same as before)
          const rnd = (Math.random()-0.5)*2;
          const spike = (Math.random()<0.01) ? (Math.random()-0.5)*0.002*vol : 0;
          const mrStrength = 0.001;
          const last = m.price || 1.1000;
          let step = rnd * 0.00008 * vol + (1.1 - last) * mrStrength * 0.0001 + spike;
          if(mode === 'slow') step *= 0.2;
          if(mode === 'extreme') step *= 4;
          const newP = Math.max(0.0001, parseFloat((last + step).toFixed(5)));
          // update market price & lastUpdate
          await mdoc.ref.update({ price: newP, lastUpdate: firebase.firestore.FieldValue.serverTimestamp() });
          // persist tick
          writeTickToFirestore(mid, newP).catch(e=>console.error('tick write err', e));
          // check open orders in this market and auto-close TP/SL
          try {
            const ordersSnap = await mdoc.ref.collection('orders').where('status','==','open').get();
            const batch = db.batch();
            ordersSnap.forEach(odoc=>{
              const o = odoc.data();
              if(!o) return;
              if(o.type === 'BUY'){
                if(newP >= o.tp){
                  const pl = Math.round((o.tp - o.entry)/0.0001) * 10 * o.size;
                  batch.update(odoc.ref, { status:'closed', closePrice:o.tp, closedAt: firebase.firestore.FieldValue.serverTimestamp(), reason:'TP', pl });
                } else if(newP <= o.sl){
                  const pl = Math.round((o.sl - o.entry)/0.0001) * 10 * o.size;
                  batch.update(odoc.ref, { status:'closed', closePrice:o.sl, closedAt: firebase.firestore.FieldValue.serverTimestamp(), reason:'SL', pl });
                }
              } else {
                if(newP <= o.tp){
                  const pl = Math.round((o.entry - o.tp)/0.0001) * 10 * o.size;
                  batch.update(odoc.ref, { status:'closed', closePrice:o.tp, closedAt: firebase.firestore.FieldValue.serverTimestamp(), reason:'TP', pl });
                } else if(newP >= o.sl){
                  const pl = Math.round((o.entry - o.sl)/0.0001) * 10 * o.size;
                  batch.update(odoc.ref, { status:'closed', closePrice:o.sl, closedAt: firebase.firestore.FieldValue.serverTimestamp(), reason:'SL', pl });
                }
              }
            });
            // commit batch if any changes (batch.commit even if empty is fine)
            await batch.commit();
          } catch(ordErr){
            console.error('order processing err for market', mid, ordErr);
          }
        } catch(innerErr){
          console.error('engine per-market err', innerErr);
        }
      } // end for each market
    } catch(e){
      console.error('engine all markets err', e);
    }
  }, TICK_MS);
}

/* ========== Candles aggregation & draw (same as previous improved) ========== */
function rebuildCandlesFromHistory(){
  candles = []; if(!priceHistory.length) return;
  const tf = timeframeMs = parseInt(document.getElementById('pageTimeframe').value) || timeframeMs;
  let bucket = null;
  for(let i=0;i<priceHistory.length;i++){
    const pt = priceHistory[i];
    const bucketStart = Math.floor(pt.t / tf) * tf;
    if(!bucket || bucket.t !== bucketStart){
      if(bucket) candles.push(bucket);
      bucket = { t: bucketStart, o: pt.price, h: pt.price, l: pt.price, c: pt.price };
    } else {
      bucket.c = pt.price;
      if(pt.price > bucket.h) bucket.h = pt.price;
      if(pt.price < bucket.l) bucket.l = pt.price;
    }
  }
  if(bucket) candles.push(bucket);
  if(candles.length > 5000) candles = candles.slice(-5000);
  const maxOff = Math.max(0, candles.length - 1);
  historyOffset = clamp(historyOffset, 0, maxOff);
}

function getVisibleSlice(slotCount, offset){
  const len = candles.length;
  if(len === 0) return [];
  const end = (offset === 0) ? len : Math.max(0, len - offset);
  const start = Math.max(0, end - slotCount);
  return candles.slice(start, end);
}

function draw(){
  const W = canvas.width / DPR; const H = canvas.height / DPR;
  ctx.clearRect(0,0,W,H); ctx.fillStyle='transparent'; ctx.fillRect(0,0,W,H);
  if(!currentMarket){ ctx.fillStyle='#9fb0d6'; ctx.font='14px Arial'; ctx.fillText('Select market to view chart',20,30); return; }

  let desiredVisible = visibleSlotsOverride || Math.floor((W - LEFT_MARGIN - RIGHT_MARGIN) / 8);
  desiredVisible = clamp(desiredVisible, MIN_VISIBLE_CANDLES, MAX_VISIBLE_CANDLES);
  const usableW = Math.max(60, W - LEFT_MARGIN - RIGHT_MARGIN);
  let candleWidth = usableW / desiredVisible * 0.72;
  candleWidth = Math.max(3, Math.min(18, candleWidth));
  const totalCandlesWidth = candleWidth * desiredVisible;
  let gap = (usableW - totalCandlesWidth) / Math.max(1, desiredVisible - 1);
  if(gap < 1) gap = 1;

  const arr = getVisibleSlice(desiredVisible, historyOffset);
  const arrLen = arr.length;
  const slotsTotalWidth = (candleWidth * desiredVisible) + ((desiredVisible - 1) * gap);
  const slotsLeft = LEFT_MARGIN + Math.max(0, usableW - slotsTotalWidth);
  const emptySlots = desiredVisible - arrLen;
  const startX = slotsLeft + emptySlots * (candleWidth + gap);

  let maxP = -Infinity, minP = Infinity;
  if(arrLen === 0){ maxP = minP = currentMarket.price || 1.0; } else {
    for(let i=0;i<arrLen;i++){ const c = arr[i]; if(c.h > maxP) maxP = c.h; if(c.l < minP) minP = c.l; }
  }
  const pad = (maxP - minP) * 0.12 || 0.0005; maxP += pad; minP -= pad;
  function py(p){ if(maxP === minP) return H/2; return ((maxP - p)/(maxP-minP))*(H-40)+20; }

  ctx.strokeStyle='rgba(255,255,255,0.03)'; ctx.lineWidth=1; ctx.beginPath();
  for(let i=0;i<5;i++){ const y = 20 + i*(H-40)/4; ctx.moveTo(LEFT_MARGIN, y); ctx.lineTo(W-10, y); }
  ctx.stroke();

  let x = startX;
  for(let i=0;i<arrLen;i++){
    const c = arr[i]; const up = c.c >= c.o;
    const colorUp = getComputedStyle(document.documentElement).getPropertyValue('--green').trim() || '#2dd36f';
    const colorDn = getComputedStyle(document.documentElement).getPropertyValue('--red').trim() || '#ff5c5c';
    const col = up ? colorUp : colorDn;
    const yO = py(c.o), yC = py(c.c), yH = py(c.h), yL = py(c.l);
    ctx.strokeStyle = col; ctx.lineWidth=1; ctx.beginPath(); ctx.moveTo(x+candleWidth/2,yH); ctx.lineTo(x+candleWidth/2,yL); ctx.stroke();
    const top = Math.min(yO,yC), hbody = Math.max(1, Math.abs(yC-yO));
    ctx.fillStyle = col; ctx.fillRect(x, top, candleWidth, hbody);
    x += candleWidth + gap;
  }

  ctx.fillStyle='rgba(255,255,255,0.06)'; ctx.fillRect(W-RIGHT_MARGIN+10,10,RIGHT_MARGIN-20,H-20);
  ctx.fillStyle='#bcd7ff'; ctx.font='12px Arial'; ctx.textAlign='right';
  for(let i=0;i<5;i++){ const v = minP + ((5-i-1)/4)*(maxP-minP); const y = 20 + i*(H-40)/4; ctx.fillText(v.toFixed(5), W-14, y+4); }

  ordersSnapshot.forEach(o=>{
    if(o.status !== 'open') return;
    if(o.tp && o.sl){
      const yTP = py(o.tp), ySL = py(o.sl);
      ctx.setLineDash([6,4]); ctx.lineWidth=1.2; ctx.strokeStyle='rgba(45,211,111,0.9)'; ctx.beginPath(); ctx.moveTo(LEFT_MARGIN, yTP); ctx.lineTo(W-RIGHT_MARGIN+10, yTP); ctx.stroke();
      ctx.strokeStyle='rgba(255,92,92,0.9)'; ctx.beginPath(); ctx.moveTo(LEFT_MARGIN, ySL); ctx.lineTo(W-RIGHT_MARGIN+10, ySL); ctx.stroke();
      ctx.setLineDash([]);
    }
  });

  ctx.strokeStyle='rgba(255,255,255,0.12)'; ctx.beginPath();
  const yNow = py(currentMarket.price); ctx.moveTo(LEFT_MARGIN, yNow); ctx.lineTo(W-10, yNow); ctx.stroke();
  ctx.fillStyle='#fff'; ctx.font='12px Arial'; ctx.textAlign='right'; ctx.fillText(formatPrice(currentMarket.price), W-14, yNow-6);
  document.getElementById('visibleCount').innerText = String(arrLen) + '/' + String(desiredVisible);
}

/* ---------- timeframe change ---------- */
document.getElementById('pageTimeframe').addEventListener('change', ()=>{
  userTimeframeOverride = true;
  timeframeMs = parseInt(document.getElementById('pageTimeframe').value);
  rebuildCandlesFromHistory();
  historyOffset = 0; draw();
});

/* ---------- orders placing ---------- */
document.getElementById('pageBuy').addEventListener('click', ()=>placeOrderFromPage('BUY'));
document.getElementById('pageSell').addEventListener('click', ()=>placeOrderFromPage('SELL'));

async function placeOrderFromPage(type){
  if(!currentMarketId) return alert('Pilih market');
  const lot = parseFloat(document.getElementById('pageLot').value)||0.1;
  const tp_pips = parseFloat(document.getElementById('pageTP').value)||20;
  const sl_pips = parseFloat(document.getElementById('pageSL').value)||20;
  const entry = currentMarket.price;
  const tp = type==='BUY' ? parseFloat((entry + tp_pips*0.0001).toFixed(5)) : parseFloat((entry - tp_pips*0.0001).toFixed(5));
  const sl = type==='BUY' ? parseFloat((entry - sl_pips*0.0001).toFixed(5)) : parseFloat((entry + sl_pips*0.0001).toFixed(5));
  const doc = { userUID: currentUser ? currentUser.uid : 'anon', deviceId, type, size: lot, entry, tp, sl, status:'open', createdAt: firebase.firestore.FieldValue.serverTimestamp() };
  await db.collection('markets').doc(currentMarketId).collection('orders').add(doc);
  alert('Order placed: ' + type + ' @' + formatPrice(entry));
}

/* ---------- render orders UI ---------- */
function renderOrdersUI(){
  const openList = document.getElementById('txOpenList');
  openList.innerHTML = '';
  const closedList = document.getElementById('txClosedList');
  closedList.innerHTML = '';
  ordersSnapshot.forEach(o=>{
    if(o.deviceId === deviceId){
      if(o.status === 'open'){
        const el = document.createElement('div'); el.className='list-item';
        el.innerHTML = `<div><div style="font-weight:700">${o.type} ${o.size} lot</div><div class="small">Entry ${formatPrice(o.entry)}</div></div>
          <div style="text-align:right"><div class="small">TP ${formatPrice(o.tp)}</div><button class="btn btn-ghost" onclick="manualClose('${o.id}')">Close</button></div>`;
        openList.appendChild(el);
      } else {
        const el = document.createElement('div'); el.className='list-item';
        el.innerHTML = `<div><div style="font-weight:700">${o.type} ${o.size} • ${o.reason||o.status}</div><div class="small">Entry ${formatPrice(o.entry)} • Close ${o.closePrice?formatPrice(o.closePrice):'-'}</div></div>
          <div style="text-align:right">${o.pl? (o.pl>=0?'<div style="color:var(--green);font-weight:700">+'+o.pl.toFixed(2)+'</div>':'<div style="color:var(--red);font-weight:700">'+o.pl.toFixed(2)+'</div>') : ''}</div>`;
        closedList.appendChild(el);
      }
    }
  });

  const rightHistory = document.getElementById('rightHistory'); rightHistory.innerHTML = '';
  ordersSnapshot.filter(o=>o.deviceId===deviceId && o.status==='closed').slice(0,50).forEach(o=>{
    const el = document.createElement('div'); el.className='list-item';
    el.innerHTML = `<div><div style="font-weight:700">${o.type} ${o.size}</div><div class="small">${o.reason||o.status} • ${o.closedAt?new Date(o.closedAt.seconds*1000).toLocaleString():''}</div></div>
      <div style="text-align:right">${o.pl? (o.pl>=0?'<div style="color:var(--green);font-weight:700">+'+o.pl.toFixed(2)+'</div>':'<div style="color:var(--red);font-weight:700">'+o.pl.toFixed(2)+'</div>') : ''}</div>`;
    rightHistory.appendChild(el);
  });

  updateMarginInfo();
}

/* ---------- manual close ---------- */
window.manualClose = async (orderId) => {
  if(!currentMarketId) return;
  const ref = db.collection('markets').doc(currentMarketId).collection('orders').doc(orderId);
  const doc = await ref.get(); if(!doc.exists) return;
  const o = doc.data();
  if(o.deviceId !== deviceId) return alert('Hanya device pembuat order yang bisa close manual');
  const closePrice = currentMarket.price;
  const pips = Math.round((closePrice - o.entry)/0.0001) * (o.type==='BUY'?1:-1);
  const pl = pips * 10 * o.size;
  await ref.update({ status:'closed', closePrice, closedAt: firebase.firestore.FieldValue.serverTimestamp(), reason:'manual', pl });
  alert('Order ditutup manual');
};

/* ---------- close all device orders ---------- */
document.getElementById('closeAllBtn')?.addEventListener('click', async ()=>{
  if(!currentMarketId) return alert('Pilih market');
  const coll = db.collection('markets').doc(currentMarketId).collection('orders');
  const snap = await coll.where('deviceId','==',deviceId).where('status','==','open').get();
  const batch = db.batch();
  snap.forEach(d=> {
    const o = d.data(); const closePrice = currentMarket.price; const pips = Math.round((closePrice - o.entry)/0.0001) * (o.type==='BUY'?1:-1); const pl = pips * 10 * o.size;
    batch.update(d.ref, { status:'closed', closePrice, closedAt: firebase.firestore.FieldValue.serverTimestamp(), reason:'close_all', pl });
  });
  await batch.commit();
  alert('Close all executed for this device');
});

/* ---------- apply closed PL to device balance ---------- */
db.collectionGroup('orders').where('status','==','closed').onSnapshot(snap=>{
  snap.docChanges().forEach(change=>{
    if(change.type === 'added' || change.type === 'modified'){
      const o = change.doc.data();
      if(!o) return;
      if(o.deviceId === deviceId && o.pl){
        const appliedKey = 'applied_orders_'+deviceId;
        let applied = JSON.parse(localStorage.getItem(appliedKey) || '[]');
        const ordPath = change.doc.ref.path;
        if(applied.indexOf(ordPath) === -1){
          balance += (o.pl || 0);
          localStorage.setItem(localBalanceKey, balance);
          document.getElementById('homeBalance').innerText = balance.toFixed(2);
          document.getElementById('marketBalance').innerText = balance.toFixed(2);
          applied.push(ordPath);
          localStorage.setItem(appliedKey, JSON.stringify(applied));
        }
      }
    }
  });
});

/* ---------- admin orders render ---------- */
function renderAdminOrders(){
  const container = document.getElementById('adminOrders');
  container.innerHTML = '';
  ordersSnapshot.forEach(o=>{
    const el = document.createElement('div'); el.className='list-item';
    el.innerHTML = `<div><div style="font-weight:700">${o.type} ${o.size} lot</div><div class="small">${o.userUID} • dev:${o.deviceId}</div></div>
      <div style="text-align:right">${o.status}<div style="margin-top:6px">${o.status==='open'?`<button class="btn btn-ghost" onclick="adminCloseOrder('${o.id}','TP')">Close TP</button> <button class="btn btn-ghost" onclick="adminCloseOrder('${o.id}','SL')">Close SL</button>`:''}</div></div>`;
    container.appendChild(el);
  });
}
window.adminCloseOrder = async (orderId, reason) => {
  if(!currentUser || currentUser.uid !== ADMIN_UID) return alert('Only admin');
  const ref = db.collection('markets').doc(currentMarketId).collection('orders').doc(orderId);
  const doc = await ref.get(); if(!doc.exists) return;
  const o = doc.data();
  const closePrice = reason==='TP' ? o.tp : (reason==='SL' ? o.sl : currentMarket.price);
  const pips = Math.round((closePrice - o.entry)/0.0001) * (o.type==='BUY'?1:-1);
  const pl = pips * 10 * o.size;
  await ref.update({ status:'closed', closePrice, closedAt: firebase.firestore.FieldValue.serverTimestamp(), reason:'admin-'+reason, pl });
  alert('Order closed by admin');
};

/* ---------- auth ---------- */
const provider = new firebase.auth.GoogleAuthProvider();
document.getElementById('btnSignInGoogle').addEventListener('click', ()=>auth.signInWithPopup(provider).catch(e=>alert(e.message)));
document.getElementById('btnSignOut').addEventListener('click', ()=>auth.signOut());
auth.onAuthStateChanged(async (user)=>{
  currentUser = user;
  if(user){
    document.getElementById('settingsUser').innerText = user.email || user.displayName || user.uid;
    document.getElementById('settingsUID').innerText = user.uid;
    if(user.uid === ADMIN_UID){ document.getElementById('navAdmin').style.display = 'inline-block'; } else { document.getElementById('navAdmin').style.display='none'; }
  } else {
    document.getElementById('settingsUser').innerText = 'not signed in';
    document.getElementById('settingsUID').innerText = '-';
    document.getElementById('navAdmin').style.display='none';
  }
});

/* ---------- boot ---------- */
async function boot(){
  await ensureDefaultMarket();
  await listMarketsToHome();
  const prefer = await db.collection('markets').doc('eur-usd').get();
  if(prefer.exists) {
    await selectMarket('eur-usd');
    currentMarketId = 'eur-usd';
  } else {
    const first = await db.collection('markets').orderBy('createdAt','desc').limit(1).get();
    if(first.docs[0]) await selectMarket(first.docs[0].id);
  }
  draw();
}
boot();

async function ensureDefaultMarket(){
  try {
    const defaultId = 'eur-usd';
    const docRef = db.collection('markets').doc(defaultId);
    const doc = await docRef.get();
    if(!doc.exists){
      await docRef.set({ name:'EUR/USD (Demo)', price:1.10000, volatility:1.0, timeframeMs:1000, ownerUID:null, autoTick:false, engineMode:'normal', createdAt: firebase.firestore.FieldValue.serverTimestamp(), lastUpdate: firebase.firestore.FieldValue.serverTimestamp() });
    }
  } catch(e){ console.error(e); }
}

/* ---------- home deposit/withdraw (demo) ---------- */
document.getElementById('homeDeposit').addEventListener('click', async ()=>{
  const amt = parseFloat(prompt('Jumlah deposit (demo)', '100'));
  if(!amt || amt <= 0) return;
  balance += amt; localStorage.setItem(localBalanceKey, balance); document.getElementById('homeBalance').innerText = balance.toFixed(2); document.getElementById('marketBalance').innerText = balance.toFixed(2);
  alert('Deposit diterima (demo) +'+amt);
});
document.getElementById('homeWithdraw').addEventListener('click', ()=>{
  const amt = parseFloat(prompt('Jumlah withdraw', '50'));
  if(!amt || amt <= 0) return;
  if(amt > balance) return alert('Saldo tidak cukup');
  balance -= amt; localStorage.setItem(localBalanceKey, balance); document.getElementById('homeBalance').innerText = balance.toFixed(2); document.getElementById('marketBalance').innerText = balance.toFixed(2);
  alert('Withdraw diproses (demo) -'+amt);
});

/* ---------- admin create/list market ---------- */
document.getElementById('adminCreateMarket').addEventListener('click', async ()=>{
  if(!currentUser || currentUser.uid !== ADMIN_UID) return alert('Only admin');
  const name = prompt('Nama market');
  if(!name) return;
  const base = parseFloat(prompt('Harga awal','1.1000')) || 1.1000;
  await db.collection('markets').add({ name, price: parseFloat(base.toFixed(5)), volatility:1.0, timeframeMs:1000, ownerUID: currentUser.uid, engineMode:'normal', createdAt: firebase.firestore.FieldValue.serverTimestamp(), lastUpdate: firebase.firestore.FieldValue.serverTimestamp() });
  await listMarketsToHome();
  alert('Market created');
});
document.getElementById('adminListMarkets').addEventListener('click', ()=>listMarketsToHome());

/* ---------- utilities ---------- */
setInterval(()=>{ draw(); }, 700);
setInterval(()=>{ document.getElementById('homeBalance').innerText = balance.toFixed(2); document.getElementById('marketBalance').innerText = balance.toFixed(2); }, 2000);

</script>
</body>
</html>
