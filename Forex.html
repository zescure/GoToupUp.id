<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Trading Panel — Candlestick (Firebase Sync)</title>
<style>
  :root{
    --bg:#071026; --panel:#0f1724; --muted:#9fb0d6; --text:#dbe7ff;
    --green:#2dd36f; --red:#ff5c5c; --glass: rgba(255,255,255,0.03);
  }
  html,body{height:100%;margin:0;background:linear-gradient(180deg,#071026,#071827);color:var(--text);font-family:Inter, Arial}
  /* Mobile-first layout: chart top large, controls below */
  .container{display:flex;flex-direction:column;height:100vh;padding:10px;box-sizing:border-box;gap:10px}
  .chart-wrap{flex:1;min-height:320px;background:var(--panel);border-radius:12px;padding:8px;display:flex;flex-direction:column;gap:8px;box-shadow:0 8px 30px rgba(0,0,0,0.6)}
  .chart-top{display:flex;justify-content:space-between;align-items:center}
  .title{font-weight:700}
  .metrics{display:flex;gap:8px;align-items:center}
  .metric{background:rgba(255,255,255,0.02);padding:6px 8px;border-radius:8px;font-size:13px}
  canvas{border-radius:8px;width:100%;height:100%}
  .controls{display:flex;flex-direction:column;gap:8px}
  .row{display:flex;gap:8px;align-items:center}
  .panel{background:var(--panel);padding:10px;border-radius:12px;box-shadow:0 6px 20px rgba(0,0,0,0.5)}
  label{font-size:12px;color:var(--muted)}
  input,select,button{padding:8px;border-radius:8px;border:0;outline:none}
  input[type="number"]{background:var(--glass);color:var(--text);border:1px solid rgba(255,255,255,0.03)}
  .btn{cursor:pointer;font-weight:700}
  .btn-buy{background:linear-gradient(180deg,var(--green),#11b85a);color:#04260f}
  .btn-sell{background:linear-gradient(180deg,#ff7b7b,var(--red));color:#2b0606}
  .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--text)}
  .orders{display:flex;flex-direction:column;gap:6px;max-height:140px;overflow:auto}
  .order{display:flex;justify-content:space-between;padding:8px;border-radius:8px;background:rgba(255,255,255,0.02)}
  .admin-panel{display:none;gap:8px}
  .show{display:flex}
  @media(min-width:900px){
    .container{flex-direction:row;gap:12px}
    .left{flex:0 1 68%}
    .right{flex:0 1 32%;display:flex;flex-direction:column;gap:10px;height:calc(100vh - 20px)}
    .chart-wrap{height:60vh}
  }
</style>
</head>
<body>
<div class="container">
  <div class="left">
    <div class="chart-wrap panel" id="chartCard">
      <div class="chart-top">
        <div>
          <div class="title">Simulator Candlestick — <span id="marketName">—</span></div>
          <div style="font-size:12px;color:var(--muted)">Harga disimpan di Firebase (sama antar device) — engine controlled</div>
        </div>
        <div class="metrics">
          <div class="metric"><div style="font-size:11px;color:var(--muted)">Balance</div><div id="balance">1000.00</div></div>
          <div class="metric"><div style="font-size:11px;color:var(--muted)">Equity</div><div id="equity">1000.00</div></div>
          <div class="metric"><div style="font-size:11px;color:var(--muted)">Price</div><div id="price">—</div></div>
        </div>
      </div>
      <canvas id="chartCanvas"></canvas>
    </div>

    <div class="panel controls" style="margin-top:10px">
      <div class="row" style="justify-content:space-between">
        <div style="flex:1">
          <label>Market</label>
          <select id="marketSelect" style="width:100%"></select>
        </div>
        <div style="width:120px">
          <label>Timeframe</label>
          <select id="timeframe">
            <option value="1000">1s</option>
            <option value="60000">1m</option>
            <option value="300000">5m</option>
            <option value="900000">15m</option>
            <option value="1800000">30m</option>
            <option value="3600000">1h</option>
            <option value="86400000">1d</option>
          </select>
        </div>
        <div style="width:160px">
          <label>Volatility (client)</label>
          <input id="volClient" type="range" min="0.2" max="3.0" step="0.1" value="1.0"/>
        </div>
      </div>

      <div class="row" style="margin-top:8px;flex-wrap:wrap">
        <div style="flex:1;min-width:120px">
          <label>Lot Size</label>
          <input id="size" type="number" value="0.1" step="0.1" min="0.01"/>
        </div>
        <div style="width:120px">
          <label>TP (pips)</label>
          <input id="tp" type="number" value="20"/>
        </div>
        <div style="width:120px">
          <label>SL (pips)</label>
          <input id="sl" type="number" value="20"/>
        </div>
        <div style="display:flex;gap:6px">
          <button id="btnBuy" class="btn btn-buy">BUY</button>
          <button id="btnSell" class="btn btn-sell">SELL</button>
        </div>
      </div>

      <div style="display:flex;gap:8px;align-items:center;margin-top:8px;flex-wrap:wrap">
        <button id="btnRefreshMarkets" class="btn-ghost">Refresh Markets</button>
        <button id="btnLoadDemoBalance" class="btn-ghost">Reset Balance</button>
        <div style="flex:1"></div>
        <div style="font-size:12px;color:var(--muted)">Engine:</div>
        <button id="btnStartEngine" class="btn-ghost">Start Engine</button>
      </div>

      <div style="margin-top:8px">
        <div style="font-size:13px;color:var(--muted)">Open Orders</div>
        <div class="orders" id="ordersList"></div>
      </div>
    </div>
  </div>

  <div class="right">
    <div class="panel">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <div style="font-weight:700">User / Admin</div>
          <div style="font-size:12px;color:var(--muted)">Masukkan UID (demo auth)</div>
        </div>
        <div style="width:160px">
          <input id="uidInput" placeholder="Enter UID (demo)"/>
        </div>
      </div>

      <div style="display:flex;gap:8px;margin-top:8px">
        <button id="btnSetUid" class="btn-ghost">Set UID</button>
        <button id="btnSignOut" class="btn-ghost">Sign Out</button>
      </div>

      <div style="margin-top:8px">
        <div style="font-weight:700">Admin Panel</div>
        <div style="font-size:12px;color:var(--muted)">(Visible jika UID = admin UID)</div>
        <div id="adminPanel" class="admin-panel" style="flex-direction:column;margin-top:6px">
          <div style="display:flex;gap:8px">
            <button id="btnCreateMarket" class="btn-ghost">Create Market</button>
            <button id="btnListMarkets" class="btn-ghost">List All Markets</button>
          </div>
          <div style="margin-top:8px">
            <label>Global Volatility</label>
            <input id="volAdmin" type="range" min="0.2" max="5.0" step="0.1" value="1.0"/>
          </div>
          <div style="margin-top:8px">
            <label>Engine Mode</label>
            <select id="engineMode">
              <option value="normal">Normal</option>
              <option value="slow">Slow</option>
              <option value="extreme">Extreme</option>
            </select>
          </div>
          <div style="margin-top:8px">
            <div style="font-size:13px;color:var(--muted)">Market Orders (selected market)</div>
            <div id="adminOrders" style="max-height:150px;overflow:auto;margin-top:6px"></div>
          </div>
          <div style="margin-top:8px">
            <div style="font-size:13px;color:var(--muted)">Deposit Verifications (simulated)</div>
            <div id="depositsList" style="max-height:100px;overflow:auto;margin-top:6px"></div>
          </div>
        </div>
      </div>
    </div>

    <div class="panel" style="margin-top:10px">
      <div style="font-weight:700">History</div>
      <div id="historyList" style="max-height:280px;overflow:auto;margin-top:6px"></div>
    </div>
  </div>
</div>

<!-- Firebase SDKs (compat mode for simplicity). Versions may vary; using common CDN URLs -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>

<script>
/*
  Trading Panel + Firebase (Firestore) sync demo
  - Use Firestore collection "markets" (doc per market)
  - Each market doc: { name, price, volatility, timeframeMs, ownerUID, autoTick, engineMode, lastUpdate }
  - Orders stored in subcollection: markets/{marketId}/orders
  - Admin UID (demo) that can create market: viCOsJo4wHVFmhtpmMx1Wd4sDF52
*/

/* ================== Firebase config (you provided) ================== */
const firebaseConfig = {
  apiKey: "AIzaSyDVUEZ3ZVmH4ld7LVnEq_L368wEJpEs-l8",
  authDomain: "zeepaylater-93a94.firebaseapp.com",
  projectId: "zeepaylater-93a94",
  storageBucket: "zeepaylater-93a94.appspot.com",
  messagingSenderId: "358065954807",
  appId: "1:358065954807:web:66619211fea82a4b2518f2"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
/* =================================================================== */

const ADMIN_UID = 'viCOsJo4wHVFmhtpmMx1Wd4sDF52'; // special UID for create market

// UI refs
const marketSelect = document.getElementById('marketSelect');
const marketNameEl = document.getElementById('marketName');
const priceEl = document.getElementById('price');
const balanceEl = document.getElementById('balance');
const equityEl = document.getElementById('equity');
const ordersListEl = document.getElementById('ordersList');
const historyListEl = document.getElementById('historyList');
const uidInput = document.getElementById('uidInput');
const btnSetUid = document.getElementById('btnSetUid');
const btnSignOut = document.getElementById('btnSignOut');
const adminPanel = document.getElementById('adminPanel');
const btnCreateMarket = document.getElementById('btnCreateMarket');
const btnListMarkets = document.getElementById('btnListMarkets');
const adminOrdersEl = document.getElementById('adminOrders');
const btnStartEngine = document.getElementById('btnStartEngine');
const btnRefreshMarkets = document.getElementById('btnRefreshMarkets');
const timeframeSel = document.getElementById('timeframe');
const volAdmin = document.getElementById('volAdmin');
const volClient = document.getElementById('volClient');
const engineModeSel = document.getElementById('engineMode');
const depositsList = document.getElementById('depositsList');

let clientUid = localStorage.getItem('demo_uid') || null;
let balance = parseFloat(localStorage.getItem('demo_balance')) || 1000.0;
let equity = balance;
let pipValue = 10; // $ per pip per lot (simple)
let currentMarketId = null;
let currentMarket = null;
let orders = []; // local snapshot
let history = [];
let unsubscribeMarket = null;
let unsubscribeOrders = null;
let engineInterval = null;
let engineRunning = false;
let clientId = 'c-' + Math.floor(Math.random()*1000000);

// set initial balance UI
balanceEl.innerText = balance.toFixed(2);
equityEl.innerText = equity.toFixed(2);

// Canvas setup
const canvas = document.getElementById('chartCanvas');
const ctx = canvas.getContext('2d');
let DPR = window.devicePixelRatio || 1;
function resizeCanvas(){
  const rect = canvas.getBoundingClientRect();
  canvas.width = Math.floor(rect.width * DPR);
  canvas.height = Math.floor(rect.height * DPR);
  ctx.setTransform(DPR,0,0,DPR,0,0);
}
window.addEventListener('resize', resizeCanvas);
resizeCanvas();

// chart state
let priceHistory = []; // {t, price}
let candles = []; // aggregated by timeframeMs
let timeframeMs = parseInt(timeframeSel.value);
timeframeSel.addEventListener('change', ()=>{
  timeframeMs = parseInt(timeframeSel.value);
  rebuildCandlesFromHistory();
  draw();
});

// helper
function formatPrice(p){ return p ? p.toFixed(5) : '—'; }
function toPips(a,b){ return Math.round((a-b)/0.0001); }

// Firestore helpers
async function listMarkets(){
  const snap = await db.collection('markets').orderBy('createdAt','desc').get();
  marketSelect.innerHTML = '';
  snap.forEach(doc=>{
    const m = doc.data();
    const opt = document.createElement('option');
    opt.value = doc.id;
    opt.innerText = m.name + ' • ' + (m.ownerUID || 'anon');
    marketSelect.appendChild(opt);
  });
  if(marketSelect.options.length>0 && !currentMarketId){
    marketSelect.selectedIndex = 0;
    selectMarket(marketSelect.value);
  }
}
btnRefreshMarkets.addEventListener('click', ()=>listMarkets());
btnListMarkets.addEventListener('click', ()=>listMarkets());

// create market (admin only)
btnCreateMarket.addEventListener('click', async ()=>{
  if(!clientUid || clientUid !== ADMIN_UID){
    alert('Hanya admin yang boleh create market (demo). Masukkan UID admin terlebih dahulu.');
    return;
  }
  const name = prompt('Nama market (ex: EUR/USD Demo)');
  if(!name) return;
  const basePrice = parseFloat(prompt('Harga awal (contoh 1.1000)','1.1000')) || 1.1000;
  const doc = await db.collection('markets').add({
    name,
    price: parseFloat(basePrice.toFixed(5)),
    volatility: 1.0,
    timeframeMs: 1000,
    ownerUID: clientUid,
    autoTick: false,
    engineMode: 'normal',
    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
    lastUpdate: firebase.firestore.FieldValue.serverTimestamp()
  });
  alert('Market created: ' + doc.id);
  await listMarkets();
});

// select market
marketSelect.addEventListener('change', ()=>{
  selectMarket(marketSelect.value);
});

async function selectMarket(marketId){
  if(unsubscribeMarket) unsubscribeMarket();
  if(unsubscribeOrders) unsubscribeOrders();
  currentMarketId = marketId;
  currentMarket = null;
  priceHistory = []; candles=[];
  draw();
  // subscribe market doc
  const ref = db.collection('markets').doc(marketId);
  unsubscribeMarket = ref.onSnapshot(doc=>{
    if(!doc.exists) return;
    const m = doc.data();
    currentMarket = { id: doc.id, ...m };
    marketNameEl.innerText = m.name;
    priceEl.innerText = formatPrice(m.price);
    // sync volatility/timeframe from market
    document.getElementById('volClient').value = m.volatility || 1.0;
    timeframeMs = m.timeframeMs || timeframeMs;
    timeframeSel.value = String(timeframeMs);
    // append price update to history for candling
    pushPriceToHistory(m.price, (m.lastUpdate && m.lastUpdate.toMillis) ? m.lastUpdate.toMillis() : Date.now());
    draw();
  });

  // subscribe orders subcollection
  unsubscribeOrders = db.collection('markets').doc(marketId).collection('orders').orderBy('createdAt','desc').onSnapshot(snap=>{
    orders = [];
    snap.forEach(d=>{
      const o = d.data(); o.id = d.id;
      orders.push(o);
    });
    renderOrders();
    if(clientUid === ADMIN_UID) renderAdminOrders();
  });

  // subscribe deposits (for admin verify)
  db.collection('markets').doc(marketId).collection('deposits').orderBy('createdAt','desc').onSnapshot(snap=>{
    depositsList.innerHTML = '';
    snap.forEach(d=>{
      const dep = d.data(); dep.id = d.id;
      const el = document.createElement('div');
      el.style.display='flex'; el.style.justifyContent='space-between'; el.style.padding='6px'; el.style.borderRadius='6px'; el.style.background='rgba(255,255,255,0.02)';
      el.innerHTML = `<div><div style="font-weight:700">${dep.userUID}</div><div style="font-size:12px;color:#9fb0d6">${dep.amount}</div></div>
        <div>
          <button class="btn-ghost" onclick="approveDeposit('${marketId}','${dep.id}')">Accept</button>
          <button class="btn-ghost" onclick="rejectDeposit('${marketId}','${dep.id}')">Reject</button>
        </div>`;
      depositsList.appendChild(el);
    });
  });
}

// push deposit approve/reject (admin)
window.approveDeposit = async (mid, depId) => {
  if(clientUid !== ADMIN_UID) return alert('Only admin');
  await db.collection('markets').doc(mid).collection('deposits').doc(depId).update({status:'approved', verifiedAt: firebase.firestore.FieldValue.serverTimestamp(), verifier: clientUid});
  alert('Approved');
};
window.rejectDeposit = async (mid, depId) => {
  if(clientUid !== ADMIN_UID) return alert('Only admin');
  await db.collection('markets').doc(mid).collection('deposits').doc(depId).update({status:'rejected', verifiedAt: firebase.firestore.FieldValue.serverTimestamp(), verifier: clientUid});
  alert('Rejected');
};

// place order
document.getElementById('btnBuy').addEventListener('click', ()=>placeOrder('BUY'));
document.getElementById('btnSell').addEventListener('click', ()=>placeOrder('SELL'));

async function placeOrder(type){
  if(!currentMarketId){ alert('Pilih market dulu'); return; }
  const lot = parseFloat(document.getElementById('size').value) || 0.1;
  const tp_pips = parseFloat(document.getElementById('tp').value) || 20;
  const sl_pips = parseFloat(document.getElementById('sl').value) || 20;
  const entry = currentMarket.price;
  const tp = type === 'BUY' ? parseFloat((entry + tp_pips*0.0001).toFixed(5)) : parseFloat((entry - tp_pips*0.0001).toFixed(5));
  const sl = type === 'BUY' ? parseFloat((entry - sl_pips*0.0001).toFixed(5)) : parseFloat((entry + sl_pips*0.0001).toFixed(5));
  const orderDoc = {
    userUID: clientUid || 'anon-'+clientId,
    type, size: lot, entry, tp, sl,
    status: 'open', createdAt: firebase.firestore.FieldValue.serverTimestamp()
  };
  await db.collection('markets').doc(currentMarketId).collection('orders').add(orderDoc);
  // local feedback
  alert('Order placed: ' + type + ' @' + formatPrice(entry));
}

// render orders UI
function renderOrders(){
  ordersListEl.innerHTML = '';
  orders.filter(o=>o.status==='open' && (o.userUID === (clientUid||'anon-'+clientId))).forEach(o=>{
    const el = document.createElement('div'); el.className='order';
    el.innerHTML = `<div><div style="font-weight:700">${o.type} ${o.size} lot</div><div style="font-size:12px;color:var(--muted)">Entry ${formatPrice(o.entry)} TP ${formatPrice(o.tp)} SL ${formatPrice(o.sl)}</div></div>
      <div style="text-align:right"><div style="font-weight:700">${o.userUID=== (clientUid||'anon-'+clientId)?'<button class=\"btn-ghost\" onclick=\"closeManual(\\''+o.id+'\\')\">Close</button>':''}</div></div>`;
    ordersListEl.appendChild(el);
  });

  // history show closed orders by this user
  historyListEl.innerHTML='';
  orders.filter(o=> o.userUID === (clientUid||'anon-'+clientId)).slice(0,40).forEach(o=>{
    if(o.status !== 'open'){
      const el = document.createElement('div');
      el.style.padding='6px'; el.style.borderRadius='6px'; el.style.background='rgba(255,255,255,0.02)'; el.style.marginBottom='6px';
      el.innerHTML = `<div style="font-weight:700">${o.type} ${o.size} • ${o.status}</div><div style="font-size:12px;color:var(--muted)">Entry ${formatPrice(o.entry)} Close ${o.closePrice?formatPrice(o.closePrice):'-'}</div>`;
      historyListEl.appendChild(el);
    }
  });
}

// manual close (user)
window.closeManual = async (orderId) => {
  if(!currentMarketId) return;
  const docRef = db.collection('markets').doc(currentMarketId).collection('orders').doc(orderId);
  const doc = await docRef.get();
  if(!doc.exists) return;
  const o = doc.data();
  if(o.userUID !== (clientUid||'anon-'+clientId)) return alert('Only owner can close');
  const closePrice = currentMarket.price;
  const pips = toPips(closePrice, o.entry) * (o.type === 'BUY' ? 1 : -1);
  const pl = pips * pipValue * o.size;
  await docRef.update({status:'closed', closePrice, closedAt: firebase.firestore.FieldValue.serverTimestamp(), reason:'manual', pl});
  alert('Order closed');
};

// admin: render all orders
function renderAdminOrders(){
  adminOrdersEl.innerHTML = '';
  orders.forEach(o=>{
    const el = document.createElement('div');
    el.style.padding='6px'; el.style.borderRadius='6px'; el.style.background='rgba(255,255,255,0.02)'; el.style.marginBottom='6px';
    el.innerHTML = `<div style="display:flex;justify-content:space-between"><div><div style="font-weight:700">${o.type} ${o.size}</div><div style="font-size:12px;color:var(--muted)">${o.userUID}</div></div>
      <div style="text-align:right"><div style="font-weight:700">${o.status}</div>
      ${o.status==='open'?`<button class="btn-ghost" onclick="adminCloseOrder('${o.id}','TP')">Close TP</button><button class="btn-ghost" onclick="adminCloseOrder('${o.id}','SL')">Close SL</button>`:''}
      </div></div>`;
    adminOrdersEl.appendChild(el);
  });
}
window.adminCloseOrder = async (orderId, reason)=>{
  if(clientUid !== ADMIN_UID) return alert('Only admin');
  const ref = db.collection('markets').doc(currentMarketId).collection('orders').doc(orderId);
  const doc = await ref.get();
  if(!doc.exists) return;
  const o = doc.data();
  const closePrice = reason === 'TP' ? o.tp : (reason==='SL' ? o.sl : currentMarket.price);
  const pips = toPips(closePrice, o.entry) * (o.type === 'BUY' ? 1 : -1);
  const pl = pips * pipValue * o.size;
  await ref.update({status:'closed', closePrice, closedAt: firebase.firestore.FieldValue.serverTimestamp(), reason:'admin-'+reason, pl});
  alert('Order closed by admin');
};

// deposits simulation
async function createDepositForDemo(amount=100){
  if(!currentMarketId) return;
  await db.collection('markets').doc(currentMarketId).collection('deposits').add({
    userUID: clientUid||'anon-'+clientId, amount, status:'pending', createdAt: firebase.firestore.FieldValue.serverTimestamp()
  });
  alert('Deposit submitted (pending verification)');
}

// admin toggles engine (start/stop)
btnStartEngine.addEventListener('click', ()=>{
  if(clientUid !== ADMIN_UID) return alert('Only admin can start engine (demo)');
  if(!currentMarketId) return alert('Select market first');
  engineRunning = !engineRunning;
  btnStartEngine.innerText = engineRunning ? 'Stop Engine' : 'Start Engine';
  if(engineRunning) startEngineLoop();
  else stopEngineLoop();
});

function stopEngineLoop(){
  if(engineInterval) clearInterval(engineInterval);
  engineInterval = null;
}

// engine: only admin should run this — updates market.price in firestore periodically
function startEngineLoop(){
  if(!currentMarketId) return alert('Pilih market dulu');
  const marketRef = db.collection('markets').doc(currentMarketId);
  // read current settings
  marketRef.get().then(doc=>{
    if(!doc.exists) return alert('Market not found');
    const m = doc.data();
    let vol = m.volatility || 1.0;
    let mode = m.engineMode || 'normal';
    // engine tick rate depends on timeframe (we'll tick every 200ms by default)
    let baseTickMs = 500;
    engineInterval = setInterval(async ()=>{
      // re-read vol/mode occasionally
      const snap = await marketRef.get();
      const ms = snap.exists ? snap.data() : m;
      vol = ms.volatility || vol;
      mode = ms.engineMode || mode;
      // compute step
      let rnd = (Math.random()-0.5)*2;
      let spike = (Math.random()<0.01) ? (Math.random()-0.5)*0.002*vol : 0;
      let mrStrength = 0.001;
      let last = ms.price || 1.1000;
      let step = rnd * 0.00008 * vol + (1.1 - last) * mrStrength * 0.0001 + spike;
      // engineMode adjustments
      if(mode === 'slow') step *= 0.2;
      if(mode === 'extreme') step *= 4;
      const newP = Math.max(0.0001, parseFloat((last + step).toFixed(5)));
      // write to firestore
      await marketRef.update({
        price: newP,
        lastUpdate: firebase.firestore.FieldValue.serverTimestamp()
      });
      // server-side order checks are simulated by admin client: check orders and auto-close
      // fetch open orders and close those hitting TP/SL
      const ordersSnap = await marketRef.collection('orders').where('status','==','open').get();
      ordersSnap.forEach(async odoc=>{
        const o = odoc.data();
        if(o.type === 'BUY'){
          if(newP >= o.tp){
            const pips = toPips(o.tp, o.entry);
            const pl = pips * pipValue * o.size;
            await odoc.ref.update({status:'closed', closePrice:o.tp, closedAt: firebase.firestore.FieldValue.serverTimestamp(), reason:'TP', pl});
          } else if(newP <= o.sl){
            const pips = toPips(o.sl, o.entry);
            const pl = pips * pipValue * o.size * (o.type==='BUY'?1:-1);
            await odoc.ref.update({status:'closed', closePrice:o.sl, closedAt: firebase.firestore.FieldValue.serverTimestamp(), reason:'SL', pl});
          }
        } else {
          if(newP <= o.tp){
            const pips = toPips(o.entry, o.tp);
            const pl = pips * pipValue * o.size;
            await odoc.ref.update({status:'closed', closePrice:o.tp, closedAt: firebase.firestore.FieldValue.serverTimestamp(), reason:'TP', pl});
          } else if(newP >= o.sl){
            const pips = toPips(o.entry, o.sl);
            const pl = pips * pipValue * o.size * (o.type==='BUY'?1:-1);
            await odoc.ref.update({status:'closed', closePrice:o.sl, closedAt: firebase.firestore.FieldValue.serverTimestamp(), reason:'SL', pl});
          }
        }
      });

    }, baseTickMs);
  });
}

// UI: set uid (demo)
btnSetUid.addEventListener('click', ()=>{
  const v = uidInput.value.trim();
  if(!v) return alert('Masukkan UID demo (string). Untuk admin masukkan: ' + ADMIN_UID);
  clientUid = v;
  localStorage.setItem('demo_uid', clientUid);
  alert('UID set: ' + clientUid);
  updateAdminUI();
});
btnSignOut.addEventListener('click', ()=>{
  clientUid = null; localStorage.removeItem('demo_uid'); updateAdminUI(); alert('Signed out (demo)');
});

function updateAdminUI(){
  if(clientUid === ADMIN_UID){
    adminPanel.classList.add('show');
  } else {
    adminPanel.classList.remove('show');
  }
}
updateAdminUI();

// admin vol change -> update market's volatility if admin toggles and market selected
volAdmin.addEventListener('input', ()=>{
  if(clientUid !== ADMIN_UID) return;
  if(!currentMarketId) return;
  db.collection('markets').doc(currentMarketId).update({volatility: parseFloat(volAdmin.value)});
});
engineModeSel.addEventListener('change', ()=>{
  if(clientUid !== ADMIN_UID) return;
  if(!currentMarketId) return;
  db.collection('markets').doc(currentMarketId).update({engineMode: engineModeSel.value});
});

// load markets at start
listMarkets();

// listen for market changes (firestore) - used to build priceHistory
function pushPriceToHistory(price, t){
  if(!t) t = Date.now();
  priceHistory.push({t, price});
  // limit history
  if(priceHistory.length > 2000) priceHistory.shift();
  rebuildCandlesFromHistory();
}

// rebuild candles according to timeframeMs
function rebuildCandlesFromHistory(){
  candles = [];
  if(priceHistory.length === 0) return;
  // group ticks into timeframe buckets
  let bucket = null;
  priceHistory.forEach(pt=>{
    const bucketStart = Math.floor(pt.t / timeframeMs) * timeframeMs;
    if(!bucket || bucket.t !== bucketStart){
      if(bucket) candles.push(bucket);
      bucket = {t: bucketStart, o: pt.price, h: pt.price, l: pt.price, c: pt.price};
    } else {
      bucket.c = pt.price;
      if(pt.price > bucket.h) bucket.h = pt.price;
      if(pt.price < bucket.l) bucket.l = pt.price;
    }
  });
  if(bucket) candles.push(bucket);
  // keep recent N candles
  if(candles.length > 400) candles = candles.slice(-400);
  draw();
}

// Draw chart based on candles
function draw(){
  const W = canvas.width / DPR;
  const H = canvas.height / DPR;
  ctx.clearRect(0,0,W,H);
  ctx.fillStyle = 'transparent'; ctx.fillRect(0,0,W,H);
  if(!currentMarket) {
    ctx.fillStyle = '#9fb0d6'; ctx.font='14px Arial'; ctx.fillText('Pilih market untuk mulai', 20, 30); return;
  }
  const arr = candles.slice(-Math.max(40, Math.min(150, Math.floor(W/6))));
  if(arr.length === 0) return;
  let maxP = -Infinity, minP = Infinity;
  arr.forEach(c=>{ maxP = Math.max(maxP, c.h); minP = Math.min(minP, c.l); });
  const pad = (maxP - minP) * 0.15 || 0.0005;
  maxP += pad; minP -= pad;
  function py(p){ return ((maxP - p)/(maxP-minP))*(H-40)+20; }
  const candleW = Math.max(4, (W / Math.max(30, arr.length)) * 0.6);
  const gap = candleW * 0.25;
  let x = 40;
  for(let i=0;i<arr.length;i++){
    const c = arr[i];
    const up = c.c >= c.o;
    const col = up ? getComputedStyle(document.documentElement).getPropertyValue('--green').trim() : getComputedStyle(document.documentElement).getPropertyValue('--red').trim();
    const yOpen = py(c.o), yClose = py(c.c), yHigh = py(c.h), yLow = py(c.l);
    // wick
    ctx.strokeStyle = col; ctx.lineWidth = 1;
    ctx.beginPath(); ctx.moveTo(x + candleW/2, yHigh); ctx.lineTo(x + candleW/2, yLow); ctx.stroke();
    // body
    const top = Math.min(yOpen,yClose), hbody = Math.max(1, Math.abs(yClose-yOpen));
    ctx.fillStyle = col; ctx.fillRect(x, top, candleW, hbody);
    x += candleW + gap;
  }
  // last price line
  ctx.strokeStyle = 'rgba(255,255,255,0.12)'; ctx.beginPath();
  const yNow = py(currentMarket.price);
  ctx.moveTo(40, yNow); ctx.lineTo(W-10, yNow); ctx.stroke();
  ctx.fillStyle = '#fff'; ctx.font='12px Arial'; ctx.textAlign='right'; ctx.fillText(formatPrice(currentMarket.price), W-12, yNow-6);
}

// When orders change, update local balance/equity based on closed PL for this user
db.collectionGroup('orders').where('status','==','closed').onSnapshot(snap=>{
  // We'll only update local balance if closed order belongs to this client (simple).
  snap.docChanges().forEach(change=>{
    if(change.type === 'added'){
      const o = change.doc.data();
      if(o.userUID === (clientUid||'anon-'+clientId) && o.pl){
        // apply to local balance if not already applied (basic dedupe by storing applied ids)
        const applied = JSON.parse(localStorage.getItem('applied_pl_ids')||'[]');
        if(applied.indexOf(change.doc.ref.path) === -1){
          balance += (o.pl || 0);
          localStorage.setItem('demo_balance', balance);
          applied.push(change.doc.ref.path);
          localStorage.setItem('applied_pl_ids', JSON.stringify(applied));
          balanceEl.innerText = balance.toFixed(2);
        }
      }
    }
  });
});

// initial market load
listMarkets();

// quick demo helpers
document.getElementById('btnLoadDemoBalance').addEventListener('click', ()=>{
  balance = 1000; localStorage.setItem('demo_balance', balance); balanceEl.innerText = balance.toFixed(2); alert('Balance reset demo');
});

// sign in on load if saved
if(clientUid){ uidInput.value = clientUid; updateAdminUI(); }

// refresh draw occasionally
setInterval(()=>draw(), 800);

</script>
</body>
</html>
