<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Info Akun & Transfer - ZESTORE</title>
  <style>
    *{box-sizing:border-box;margin:0;padding:0;font-family:'Segoe UI',sans-serif;}
    body{background:#0a0a0f;color:#fff;display:flex;flex-direction:column;align-items:center;padding:20px;}

    header{width:100%;max-width:400px;background:#111927;
      padding:15px 20px;display:flex;justify-content:space-between;
      align-items:center;border-bottom:1px solid #222;margin-bottom:20px;}
    .logo{font-size:20px;color:#00bfff;font-weight:bold;}
    .menu-btn{background:none;border:none;color:#fff;font-size:24px;cursor:pointer;}
    .menu-list{display:none;flex-direction:column;background:#111927;
      position:absolute;top:60px;left:20px;width:160px;border:1px solid #333;
      border-radius:8px;box-shadow:0 0 10px rgba(0,0,0,0.3);padding:10px;}
    .menu-list a{color:#fff;text-decoration:none;padding:8px;border-radius:4px;}
    .menu-list a:hover{background:#222;}

    .account-box, .coin-container, .history-box{
      width:100%;max-width:400px;background:#141b2d;padding:20px;
      border:1px solid #2c3e50;border-radius:10px;box-shadow:0 0 20px rgba(0,0,0,0.3);
      margin-bottom:20px;
    }
    .account-box h2, .coin-container h3, .history-box h3{
      text-align:center;color:#00bfff;margin-bottom:15px;
    }
    .account-box p, .coin-container .coin-display{
      margin:8px 0;
    }
    .account-box button, .coin-container button{
      width:100%;padding:10px;margin-top:10px;border:none;border-radius:5px;
      font-size:16px;cursor:pointer;transition:.3s;
    }
    .logout-btn{background:#e74c3c;color:#fff;}
    .back-btn{background:#2c3e50;color:#fff;}
    .coin-container {
  text-align: center; /* Tambahkan ini */
} .coin-display{font-size:2rem;color:#ffd700;}
    .coin-container button{background:#00bfff;color:#fff;margin-top:0;}
    .coin-container button:hover, .account-box button:hover{opacity:.8;}

    .transfer-popup{
      position:fixed;top:0;left:0;width:100%;height:100%;
      background:rgba(0,0,0,0.7);display:none;align-items:center;justify-content:center;
      z-index:1000;
    }
    .transfer-content{
      background:#1e1e40;padding:20px;border-radius:12px;
      width:90%;max-width:320px;text-align:left;
    }
    .transfer-content h3{color:#ffde59;margin-bottom:10px;text-align:center;}
    .transfer-content label{display:block;margin-top:10px;}
    .transfer-content input{
      width:100%;padding:8px;margin-top:5px;border:none;border-radius:5px;
    }
    .transfer-content button{
      width:100%;padding:10px;margin-top:15px;
      border:none;border-radius:5px;background:#4c8bf5;color:#fff;
      cursor:pointer;transition:.3s;
    }
    .transfer-content button:hover{background:#3a6ed1;}
    .transfer-content .close-transfer{background:#f54242;}
    .transfer-content p.status{margin-top:8px;color:#ffde59;font-size:.9rem;}

    .history-box ul{list-style:none;max-height:200px;overflow:auto;padding-left:0;}
    .history-box li{padding:6px;border-bottom:1px solid #2c3e50;font-size:.9rem;}
    .history-box li.positive{color:#2ecc71;}
    .history-box li.negative{color:#e74c3c;}
  </style>
</head>
<body>

  <header>
    <div class="logo">ZESTORE.ID</div>
    <button class="menu-btn" id="toggleMenu">&#9776;</button>
    <div class="menu-list" id="menuList">
      <a href="/home">üè† Beranda</a>
      <a href="/info-akun">üë§ Info Akun</a>
      <a href="#" id="logoutBtn">üö™ Logout</a>
    </div>
  </header>

  <div class="account-box">
    <h2>Info Akun</h2>
    <p><strong>Username:</strong> <span id="displayName">‚Äì</span></p>
    <p><strong>Email:</strong> <span id="email">‚Äì</span></p>
    <p><strong>Nomor HP:</strong> <span id="phone">‚Äì</span></p>
    <p><strong>UID:</strong> <span id="uid">‚Äì</span></p>
    <button class="logout-btn" id="logoutBtn2">Logout</button>
    <button class="back-btn" onclick="location.href='/home'">‚¨Ö Kembali</button>
  </div>

  <div class="coin-container">
    <h3>Saldo Koin Anda</h3>
    <p class="coin-display">ü™ô <span id="coinBalance">0</span></p>
    <button id="openTransfer">Transfer Koin</button>
  </div>

  <div class="transfer-popup" id="transferPopup">
    <div class="transfer-content">
      <h3>Transfer Koin</h3>
      <label>UID Penerima:</label>
      <input type="text" id="transferUid" placeholder="Masukkan UID">
      <label>Jumlah Koin:</label>
      <input type="number" id="transferAmt" placeholder="Jumlah">
      <p style="font-size:.85rem;color:#ccc;margin-top:5px;">
        *Minimal sisa 10 koin. Biaya = 1% + 10 koin.
      </p>
      <button id="transferBtn">Kirim</button>
      <button class="close-transfer" id="closeTransfer">Batal</button>
      <p class="status" id="transferStatus"></p>
    </div>
  </div>

  <div class="history-box">
    <h3>Histori Transaksi</h3>
    <ul id="txHistory"></ul>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
    import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
    import {
      getFirestore, doc, getDoc, runTransaction,
      collection, query, orderBy, limit, getDocs, serverTimestamp
    } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyDVUEZ3ZVmH4ld7LVnEq_L368wEJpEs-l8",
      authDomain: "zeepaylater-93a94.firebaseapp.com",
      projectId: "zeepaylater-93a94",
      storageBucket: "zeepaylater-93a94.appspot.com",
      messagingSenderId: "358065954807",
      appId: "1:358065954807:web:66619211fea82a4b2518f2"
    };
    initializeApp(firebaseConfig);
    const auth = getAuth();
    const db   = getFirestore();

    const feeReceiverUid = '5UJtoleUCPVOHFEQWwfHMMZaTgG3';

    // DOM
    const displayNameEl = document.getElementById('displayName');
    const emailEl       = document.getElementById('email');
    const phoneEl       = document.getElementById('phone');
    const uidEl         = document.getElementById('uid');
    const coinEl        = document.getElementById('coinBalance');
    const txHistoryUl   = document.getElementById('txHistory');
    const openTransfer  = document.getElementById('openTransfer');
    const transferPopup = document.getElementById('transferPopup');
    const closeTransfer = document.getElementById('closeTransfer');
    const transferBtn   = document.getElementById('transferBtn');
    const transferStatus= document.getElementById('transferStatus');

    let currentUser;

    onAuthStateChanged(auth, async user => {
      if (!user) return location.href = '/register-login';
      currentUser = user;
      displayNameEl.textContent = localStorage.getItem('username')||user.displayName||'-';
      emailEl.textContent       = user.email||'-';
      phoneEl.textContent       = user.phoneNumber||'-';
      uidEl.textContent         = user.uid;
      await loadBalance();
      await loadHistory();
    });

    async function loadBalance(){
      const snap = await getDoc(doc(db,'users',currentUser.uid));
      coinEl.textContent = snap.exists()? (snap.data().coinBalance||0) : 0;
    }

    async function loadHistory(){
      txHistoryUl.innerHTML = '';
      const q = query(collection(db,'users',currentUser.uid,'transactions'),
                      orderBy('timestamp','desc'), limit(20));
      const snaps = await getDocs(q);
      snaps.forEach(d => {
        const data = d.data();
        const dt   = data.timestamp.toDate().toLocaleString('id');
        const am   = data.amount;
        const cls  = am>0?'positive':'negative';
        txHistoryUl.innerHTML += `<li class="${cls}">${dt} ‚Üí ${am>0?'+':''}${am} koin</li>`;
      });
    }

    // menu toggle & logout
    document.getElementById('toggleMenu').onclick = ()=>{
      const ml = document.getElementById('menuList');
      ml.style.display = ml.style.display==='flex'?'none':'flex';
    };
    document.getElementById('logoutBtn').onclick = document.getElementById('logoutBtn2').onclick = ()=>{
      signOut(auth).then(()=>{
        localStorage.removeItem('username');
        location.href = '/register-login';
      });
    };

    // transfer popup logic
    openTransfer.onclick  = ()=>{ transferStatus.textContent=''; transferPopup.style.display='flex'; };
    closeTransfer.onclick = ()=>transferPopup.style.display='none';

    transferBtn.onclick = async()=>{
      const toUid = document.getElementById('transferUid').value.trim();
      const amt   = parseInt(document.getElementById('transferAmt').value);
      if(!toUid||!amt||amt<=0){
        return transferStatus.textContent='Isi UID dan jumlah dengan benar.';
      }
      transferStatus.textContent='Memproses...';
      try{
        await runTransaction(db, async tx=>{
          const sRef = doc(db,'users',currentUser.uid);
          const rRef = doc(db,'users',toUid);
          const fRef = doc(db,'users',feeReceiverUid);

          const sSnap= await tx.get(sRef);
          const rSnap= await tx.get(rRef);
          const fSnap= await tx.get(fRef);

          if(!sSnap.exists()) throw 'Pengirim tidak ditemukan.';
          if(!rSnap.exists()) throw 'Penerima tidak ditemukan.';
          if(!fSnap.exists()) throw 'Akun fee tidak ditemukan.';

          const sBal = sSnap.data().coinBalance||0;
          const fee  = Math.ceil(amt*0.01) + 10;
          if(sBal - amt - fee < 10) throw 'Saldo tidak mencukupi (min sisa 10).';

          const rBal = rSnap.data().coinBalance||0;
          const fBal = fSnap.data().coinBalance||0;

          tx.update(sRef,{ coinBalance: sBal - amt - fee });
          tx.update(rRef,{ coinBalance: rBal + amt });
          tx.update(fRef,{ coinBalance: fBal + fee });

          const ts = serverTimestamp();
          const tsColS = collection(sRef,'transactions');
          const tsColR = collection(rRef,'transactions');
          const tsColF = collection(fRef,'transactions');

          tx.set(doc(tsColS),{ timestamp:ts, amount: -(amt+fee) });
          tx.set(doc(tsColR),{ timestamp:ts, amount: +amt     });
          tx.set(doc(tsColF),{ timestamp:ts, amount: +fee     });
        });
        transferStatus.textContent='Transfer berhasil!';
        await loadBalance();
        await loadHistory();
      } catch(e){
        transferStatus.textContent = 'Error: '+e;
      }
    };
  </script>
</body>
</html>
