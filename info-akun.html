<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Info Akun - ZESTORE</title>
  <style>
    *{box-sizing:border-box;margin:0;padding:0;font-family:'Segoe UI',sans-serif;}
    body{background:#0a0a0f;color:#fff;}

    header{
      background:#111927;padding:15px 20px;display:flex;justify-content:space-between;
      align-items:center;position:relative;z-index:10;border-bottom:1px solid #222;
    }
    .logo{font-size:20px;font-weight:bold;color:#00bfff;}
    .menu-btn{background:none;border:none;color:#fff;font-size:24px;cursor:pointer;}
    .menu-list{display:none;flex-direction:column;background:#111927;position:absolute;
      top:60px;left:15px;width:160px;border-radius:8px;border:1px solid #333;
      box-shadow:0 0 10px rgba(0,0,0,0.3);padding:10px;
    }
    .menu-list a{color:#fff;text-decoration:none;padding:10px;border-radius:4px;}
    .menu-list a:hover{background:#222;}

    .account-box{
      margin:30px auto;max-width:400px;background:#141b2d;padding:20px;border-radius:10px;
      border:1px solid #2c3e50;box-shadow:0 0 20px rgba(0,0,0,0.3);
    }
    .account-box h2{text-align:center;margin-bottom:20px;color:#00bfff;}
    .account-box p{margin:10px 0;}
    .account-box button{
      width:100%;padding:10px;margin-top:15px;border:none;border-radius:5px;font-size:16px;
      cursor:pointer;transition:.3s;
    }
    .logout-btn{background:#e74c3c;color:#fff;}
    .logout-btn:hover{background:#c0392b;}
    .back-btn{background:#2c3e50;color:#fff;margin-top:10px;}
    .back-btn:hover{background:#1f2a38;}

    /* Kontainer saldo koin terpisah */
    .coin-container{
      margin:20px auto;max-width:400px;background:#1e2537;padding:20px;border-radius:10px;
      text-align:center;border:1px solid #2c3e50;box-shadow:0 0 20px rgba(0,0,0,0.3);
    }
    .coin-container p{margin:10px 0;}
    .coin-display{font-size:1.8rem;color:#ffd700;margin:5px 0;}
    .coin-container button{
      background:#00bfff;color:#fff;padding:10px 15px;border:none;border-radius:5px;
      margin:5px;cursor:pointer;transition:.3s;
    }
    .coin-container button:hover{opacity:.8;}

    #phoneInputSection,#otpSection{
      margin-top:20px;display:none;
    }
    #phoneInput,#otpInput{
      width:100%;padding:10px;margin-top:5px;border-radius:5px;border:none;outline:none;
    }
  </style>
</head>
<body>

  <header>
    <div class="logo">ZESTORE.ID</div>
    <button class="menu-btn" id="toggleMenu">&#9776;</button>
    <div class="menu-list" id="menuList">
      <a href="/home">üè† Beranda</a>
      <a href="/info-akun">üë§ Info Akun</a>
      <a href="#" id="logoutBtn">üö™ Logout</a>
    </div>
  </header>

  <!-- Info Akun -->
  <div class="account-box">
    <h2>Info Akun</h2>
    <p><strong>Username:</strong> <span id="displayName">Memuat...</span></p>
    <p><strong>Email:</strong> <span id="email">Memuat...</span></p>
    <p><strong>Nomor HP:</strong> <span id="phone">Memuat...</span></p>
    <p><strong>Wallet Adress:</strong> <span id="uid">Memuat...</span></p>

    <div id="phoneInputSection">
      <label for="phoneInput">Masukkan Nomor HP:</label>
      <input type="tel" id="phoneInput" placeholder="08xxxxxxxxxx">
      <button onclick="sendOTP()">Kirim OTP</button>
    </div>
    <div id="otpSection">
      <label for="otpInput">Masukkan OTP:</label>
      <input type="text" id="otpInput" placeholder="Kode OTP">
      <button onclick="verifyOTP()">Verifikasi</button>
    </div>

    <button class="logout-btn" id="logoutBtn2">Logout</button>
    <button class="back-btn" onclick="window.location.href='/home'">‚¨Ö Kembali</button>
  </div>

  <!-- SALDO KOIN (TERPISAH) -->
  <div class="coin-container">
    <p>Saldo Koin Anda</p>
    <p class="coin-display">ü™ô <span id="coinBalance">0</span></p>
    <button id="withdrawBtn">Tarik Koin</button>
    <button id="depositBtn">Deposit Koin</button>
  </div>

  <script type="module">
    import { auth } from './firebase-config.js';
    import { onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
    import { getFirestore, doc, getDoc } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

    const db = getFirestore();
    const displayName = document.getElementById("displayName");
    const emailEl = document.getElementById("email");
    const uidEl = document.getElementById("uid");
    const phoneEl = document.getElementById("phone");
    const coinEl = document.getElementById("coinBalance");
    const phoneInputSection = document.getElementById("phoneInputSection");
    const otpSection = document.getElementById("otpSection");

    onAuthStateChanged(auth, async user => {
      if (!user) return window.location.href = "/register-login";

      displayName.textContent = localStorage.getItem("username") || user.displayName || "-";
      emailEl.textContent = user.email || "-";
      uidEl.textContent = user.uid;
      phoneEl.textContent = user.phoneNumber || "-";
      phoneInputSection.style.display = "block";

      // Ambil saldo koin (pastikan field ada di Firestore)
      try {
        const userDoc = await getDoc(doc(db,"users",user.uid));
        coinEl.textContent = (userDoc.exists() && userDoc.data().coinBalance) || 0;
      } catch(e) {
        console.error("Gagal ambil saldo koin:", e);
        coinEl.textContent = 0;
      }
    });

    const logoutAll = () => {
      signOut(auth).then(()=>{
        localStorage.removeItem("username");
        window.location.href = "/register-login";
      });
    };
    document.getElementById("logoutBtn").onclick = logoutAll;
    document.getElementById("logoutBtn2").onclick = logoutAll;

    document.getElementById("toggleMenu").onclick = () => {
      const menuList = document.getElementById("menuList");
      menuList.style.display = menuList.style.display==="flex" ? "none" : "flex";
    };

    document.getElementById("withdrawBtn").onclick = () => {
      window.open(`https://wa.me/?text=${encodeURIComponent(`Halo admin, saya ingin tarik koin sebanyak ${coinEl.textContent}.`)}`,"_blank");
    };
    document.getElementById("depositBtn").onclick = () => {
      alert("Fitur deposit masih dalam pengembangan.");
    };

    let generatedOTP="";
    window.sendOTP = () => {
      const phone = document.getElementById("phoneInput").value.trim();
      if(!phone) return alert("Masukkan nomor HP dulu!");
      generatedOTP = Math.floor(1000+Math.random()*9000).toString();
      otpSection.style.display = "block";
      window.open(`https://wa.me/?text=${encodeURIComponent(`Verifikasi nomor:\nHP: ${phone}\nOTP: ${generatedOTP}`)}`,"_blank");
    };
    window.verifyOTP = () => {
      if(document.getElementById("otpInput").value === generatedOTP){
        alert("Nomor berhasil diverifikasi!");
        phoneEl.textContent = document.getElementById("phoneInput").value;
        phoneInputSection.style.display="none";
        otpSection.style.display="none";
      } else {
        alert("Kode OTP salah, coba lagi.");
      }
    };
  </script>
</body>
</html>
