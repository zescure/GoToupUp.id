<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Info Akun, Transfer & Ekonomi Koin - ZESTORE</title>
  <style>
    *{box-sizing:border-box;margin:0;padding:0;font-family:'Segoe UI',sans-serif;}
    body{background:#0a0a0f;color:#fff;display:flex;flex-direction:column;align-items:center;padding:20px;}

    header{width:100%;max-width:400px;background:#111927;
      padding:15px 20px;display:flex;justify-content:space-between;
      align-items:center;border-bottom:1px solid #222;margin-bottom:20px;}
    .logo{font-size:20px;color:#00bfff;font-weight:bold;}
    .menu-btn{background:none;border:none;color:#fff;font-size:24px;cursor:pointer;}
    .menu-list{display:none;flex-direction:column;background:#111927;
      position:absolute;top:60px;left:20px;width:160px;border:1px solid #333;
      border-radius:8px;box-shadow:0 0 10px rgba(0,0,0,0.3);padding:10px;}
    .menu-list a{color:#fff;text-decoration:none;padding:8px;border-radius:4px;}
    .menu-list a:hover{background:#222;}

    .card{
      width:100%;max-width:400px;background:#141b2d;padding:20px;
      border:1px solid #2c3e50;border-radius:10px;box-shadow:0 0 20px rgba(0,0,0,0.3);
      margin-bottom:20px;
    }
    .card h2,.card h3{text-align:center;margin-bottom:15px;}
    .card h2{color:#00bfff;}
    .card h3{color:#4c8bf5;}
    .card p{margin:8px 0;}

    .account-box button, .coin-container button{
      width:100%;padding:10px;margin-top:10px;border:none;border-radius:5px;
      font-size:16px;cursor:pointer;transition:.3s;
    }
    .logout-btn{background:#e74c3c;color:#fff;}
    .logout-btn:hover{background:#c0392b;}
    .back-btn{background:#2c3e50;color:#fff;}
    .back-btn:hover{background:#1f2a38;}

    .coin-display{font-size:2rem;color:#ffd700;text-align:center;}

    .transfer-popup{
      position:fixed;top:0;left:0;width:100%;height:100%;
      background:rgba(0,0,0,0.7);display:none;align-items:center;justify-content:center;
      z-index:1000;
    }
    .transfer-content{
      background:#1e1e40;padding:20px;border-radius:12px;
      width:90%;max-width:320px;text-align:left;
    }
    .transfer-content h3{color:#ffde59;margin-bottom:10px;text-align:center;}
    .transfer-content label{display:block;margin-top:10px;}
    .transfer-content input{
      width:100%;padding:8px;margin-top:5px;border:none;border-radius:5px;
    }
    .transfer-content button{
      width:100%;padding:10px;margin-top:15px;
      border:none;border-radius:5px;background:#4c8bf5;color:#fff;
      cursor:pointer;transition:.3s;
    }
    .transfer-content button:hover{background:#3a6ed1;}
    .transfer-content .close-transfer{background:#f54242;}
    .transfer-content p.status{margin-top:8px;color:#ffde59;font-size:.9rem;}

    .history-box ul{list-style:none;max-height:200px;overflow:auto;padding-left:0;}
    .history-box li{padding:6px;border-bottom:1px solid #2c3e50;font-size:.9rem;}
    .history-box li.positive{color:#2ecc71;}
    .history-box li.negative{color:#e74c3c;}

    .economy-row{
      display:flex;justify-content:space-between;gap:8px;font-size:.92rem;
      background:#1e2537;border-radius:6px;padding:8px 10px;margin:5px 0;
    }
    .economy-row span:first-child{color:#999;}
    .economy-row strong{color:#ffde59;}
  </style>
</head>
<body>

  <header>
    <div class="logo">ZESTORE.ID</div>
    <button class="menu-btn" id="toggleMenu">&#9776;</button>
    <div class="menu-list" id="menuList">
      <a href="/home">üè† Beranda</a>
      <a href="/info-akun">üë§ Info Akun</a>
      <a href="#" id="logoutBtn">üö™ Logout</a>
    </div>
  </header>

  <!-- Info Akun -->
  <div class="card account-box">
    <h2>Info Akun</h2>
    <p><strong>Username:</strong> <span id="displayName">‚Äì</span></p>
    <p><strong>Email:</strong> <span id="email">‚Äì</span></p>
    <p><strong>Nomor HP:</strong> <span id="phone">‚Äì</span></p>
    <p><strong>UID:</strong> <span id="uid">‚Äì</span></p>
    <button class="logout-btn" id="logoutBtn2">Logout</button>
    <button class="back-btn" onclick="location.href='/home'">‚¨Ö Kembali</button>
  </div>

  <!-- Saldo Koin -->
  <div class="card coin-container">
    <h3>Saldo Koin Anda</h3>
    <p class="coin-display">ü™ô <span id="coinBalance">0</span></p>
    <p style="text-align:center;color:#ccc;font-size:.9rem;">‚âà Rp <span id="coinBalanceIDR">0</span></p>
    <button id="openTransfer">Transfer Koin</button>
  </div>

  <!-- Ekonomi Koin -->
  <div class="card economy-box">
    <h3>Ekonomi Koin Zestore</h3>
    <div class="economy-row"><span>Kurs Tetap</span><strong>10 koin = Rp 10</strong></div>
    <div class="economy-row"><span>Total Suplai</span><strong id="totalSupply">0</strong></div>
    <div class="economy-row"><span>Koin Beredar</span><strong id="circulating">0</strong></div>
    <div class="economy-row"><span>Koin Terkunci</span><strong id="locked">0</strong></div>
  </div>

<!-- Popup Transfer -->
<div class="transfer-popup" id="transferPopup">
  <div class="transfer-content">
    <h3>Transfer Koin</h3>
    <label>UID Penerima:</label>
    <input type="text" id="transferUid" placeholder="Masukkan UID">
    <label>Jumlah Koin:</label>
    <input type="number" id="transferAmt" placeholder="Jumlah">

    <div id="recipientInfo" style="font-size:.9rem;color:#0f0;margin:5px 0;"></div>

    <p style="font-size:.85rem;color:#ccc;margin-top:5px;">
      *Minimal sisa 10 koin. Biaya = 1% + 10 koin (dikirim ke wallet fee).
    </p>
    <button id="transferBtn">Kirim</button>
    <button class="close-transfer" id="closeTransfer">Batal</button>
    <p class="status" id="transferStatus"></p>
  </div>
</div>

  <!-- History -->
  <div class="card history-box">
    <h3>Histori Transaksi</h3>
    <ul id="txHistory"></ul>
  </div>

  <script type="module">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
  import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
  import {
    getFirestore, doc, getDoc, runTransaction,
    collection, query, orderBy, limit, getDocs,
    serverTimestamp, setDoc
  } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

  // ----------------- FIREBASE INIT -----------------
  const firebaseConfig = {
    apiKey: "AIzaSyDVUEZ3ZVmH4ld7LVnEq_L368wEJpEs-l8",
    authDomain: "zeepaylater-93a94.firebaseapp.com",
    projectId: "zeepaylater-93a94",
    storageBucket: "zeepaylater-93a94.appspot.com",
    messagingSenderId: "358065954807",
    appId: "1:358065954807:web:66619211fea82a4b2518f2"
  };
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);

  // ----------------- ECONOMY CONFIG -----------------
  const ECON_REF = doc(db, 'economy', 'meta');
  const TOTAL_SUPPLY = 21_000_000;  // 21 juta
  const RATE_COINS  = 10;
  const RATE_IDR    = 10;           // 10 coin = Rp 10

  const FEE_RECEIVER_UID = '5UJtoleUCPVOHFEQWwfHMMZaTgG3';

  // ----------------- DOM ELEM -----------------
  const displayNameEl = document.getElementById('displayName');
  const emailEl       = document.getElementById('email');
  const phoneEl       = document.getElementById('phone');
  const uidEl         = document.getElementById('uid');
  const coinEl        = document.getElementById('coinBalance');
  const coinIDREl     = document.getElementById('coinBalanceIDR');
  const txHistoryUl   = document.getElementById('txHistory');

  const totalSupplyEl = document.getElementById('totalSupply');
  const circulatingEl = document.getElementById('circulating');
  const lockedEl      = document.getElementById('locked');

  const openTransfer  = document.getElementById('openTransfer');
  const transferPopup = document.getElementById('transferPopup');
  const closeTransfer = document.getElementById('closeTransfer');
  const transferBtn   = document.getElementById('transferBtn');
  const transferStatus= document.getElementById('transferStatus');

  let currentUser;

  // ----------------- HELPERS -----------------
  const nf = (n)=> (n||0).toLocaleString('id-ID');

  async function ensureEconomyDoc(){
    const snap = await getDoc(ECON_REF);
    if(!snap.exists()){
      await setDoc(ECON_REF,{
        totalSupply: TOTAL_SUPPLY,
        circulatingSupply: 0,
        rate: { coins: RATE_COINS, idr: RATE_IDR }
      });
    }
  }

  async function loadEconomy(){
    const snap = await getDoc(ECON_REF);
    const data = snap.exists()? snap.data(): { totalSupply: TOTAL_SUPPLY, circulatingSupply: 0 };
    const total = data.totalSupply || TOTAL_SUPPLY;
    const circ  = data.circulatingSupply || 0;
    totalSupplyEl.textContent = nf(total);
    circulatingEl.textContent = nf(circ);
    lockedEl.textContent      = nf(total - circ);
  }

  async function loadBalance(uid){
    const snap = await getDoc(doc(db,'users',uid));
    const bal  = snap.exists()? (snap.data().coinBalance||0) : 0;
    coinEl.textContent    = nf(bal);
    coinIDREl.textContent = nf(bal * (RATE_IDR / RATE_COINS)); // 1 coin = 1 rupiah, tetap pakai formula
  }

  async function loadHistory(uid){
    txHistoryUl.innerHTML = '';
    const q = query(collection(db,'users',uid,'transactions'),
                    orderBy('timestamp','desc'), limit(50));
    const snaps = await getDocs(q);
    snaps.forEach(d => {
      const data = d.data();
      const dt   = data.timestamp?.toDate?.().toLocaleString('id-ID') || '-';
      const am   = data.amount;
      const cls  = am>0?'positive':'negative';
      txHistoryUl.innerHTML += `<li class="${cls}">${dt} ‚Üí ${am>0?'+':''}${nf(am)} koin</li>`;
    });
  }

  // ----------------- AUTH -----------------
  onAuthStateChanged(auth, async (user)=>{
    if(!user) return location.href = '/register-login';
    currentUser = user;

    displayNameEl.textContent = localStorage.getItem('username') || user.displayName || '-';
    emailEl.textContent       = user.email || '-';
    phoneEl.textContent       = user.phoneNumber || '-';
    uidEl.textContent         = user.uid;

    await ensureEconomyDoc();
    await Promise.all([
      loadEconomy(),
      loadBalance(user.uid),
      loadHistory(user.uid)
    ]);
  });

  // ----------------- MENU / LOGOUT -----------------
  document.getElementById('toggleMenu').onclick = ()=>{
    const ml = document.getElementById('menuList');
    ml.style.display = ml.style.display==='flex' ? 'none' : 'flex';
  };
  const doLogout = ()=> signOut(auth).then(()=>{ localStorage.removeItem('username'); location.href='/register-login'; });
  document.getElementById('logoutBtn').onclick = doLogout;
  document.getElementById('logoutBtn2').onclick = doLogout;

// ----------------- TRANSFER (REWORK) -----------------
const recipientInfo = document.getElementById('recipientInfo'); // tambahkan <div id="recipientInfo"> di HTML

openTransfer.onclick  = ()=>{
  transferStatus.textContent='';
  recipientInfo.innerHTML = '';
  transferPopup.style.display='flex';
};
closeTransfer.onclick = ()=>transferPopup.style.display='none';

// Sensor email ‚Üí n***e@g***.com
function maskEmail(email='') {
  if (!email || !email.includes('@')) return '-';
  const [name, domain] = email.split('@');
  const mask = (str) => {
    if (str.length <= 2) return str[0] + '*';
    return str[0] + '*'.repeat(str.length - 2) + str[str.length - 1];
  };
  const [domName, ...domRest] = domain.split('.');
  const domMasked = mask(domName) + (domRest.length ? '.' + domRest.join('.') : '');
  return `${mask(name)}@${domMasked}`;
}

// Ambil info penerima untuk konfirmasi
async function previewRecipient(uid) {
  const rRef  = doc(db, 'users', uid);
  const rSnap = await getDoc(rRef);
  if (!rSnap.exists()) throw new Error('Penerima tidak ditemukan di /users. Pastikan UID benar dan user sudah pernah login.');
  const rData = rSnap.data();
  const balance = Number(rData.coinBalance || 0);
  const email   = rData.email || '-';

  // 3 histori terakhir
  let lastTx = [];
  try {
    const qTx = query(collection(rRef, 'transactions'), orderBy('timestamp', 'desc'), limit(3));
    const qs  = await getDocs(qTx);
    lastTx = qs.docs.map(d => {
      const x = d.data();
      const ts = x.timestamp?.toDate?.() ? x.timestamp.toDate().toLocaleString('id-ID') : '-';
      return `${ts} ‚Üí ${x.amount > 0 ? '+' : ''}${(x.amount||0).toLocaleString('id-ID')} koin (${x.type||'-'})`;
    });
  } catch(e) {
    // abaikan kalau belum ada subcollection atau index
  }

  return {
    emailMasked: maskEmail(email),
    balance,
    history: lastTx
  };
}

transferBtn.onclick = async()=>{
  const toUidRaw = (document.getElementById('transferUid').value||'').trim();
  const toUid    = toUidRaw.replace(/\s/g,'');
  const amt      = Number((document.getElementById('transferAmt').value||'').trim());
  recipientInfo.innerHTML = '';
  
  if(!toUid || !amt || !Number.isFinite(amt) || amt<=0){
    transferStatus.textContent = 'Isi UID & jumlah dengan benar.';
    return;
  }
  transferStatus.textContent='Cek penerima...';

  try{
    // 1) Preview penerima
    const info = await previewRecipient(toUid);
    recipientInfo.innerHTML = `
      Akun ditemukan:<br>
      Email: <b>${info.emailMasked}</b><br>
      Saldo: <b>${info.balance.toLocaleString('id-ID')} koin</b><br>
      ${info.history.length ? ('Histori terakhir:<br><small>' + info.history.join('<br>') + '</small>') : '<small>(Belum ada histori)</small>'}
    `;

    // 2) Konfirmasi
    const ok = confirm(`Lanjut transfer ${amt.toLocaleString('id-ID')} koin ke UID:\n${toUid}\nEmail: ${info.emailMasked}`);
    if (!ok) {
      transferStatus.textContent = 'Transfer dibatalkan.';
      return;
    }
    transferStatus.textContent='Memproses transfer...';

    // 3) Jalankan transaksi
    await runTransaction(db, async tx=>{
      const sRef = doc(db,'users',currentUser.uid);
      const rRef = doc(db,'users',toUid);
      const fRef = doc(db,'users',FEE_RECEIVER_UID);

      const [sSnap, rSnap, fSnap] = await Promise.all([
        tx.get(sRef), tx.get(rRef), tx.get(fRef)
      ]);

      if(!sSnap.exists()) throw new Error('Pengirim tidak ditemukan.');
      if(!rSnap.exists()) throw new Error('Penerima tidak ditemukan.');
      if(!fSnap.exists()) throw new Error('Akun fee tidak ditemukan.');

      const sBal = Number(sSnap.data().coinBalance||0);
      const rBal = Number(rSnap.data().coinBalance||0);
      const fBal = Number(fSnap.data().coinBalance||0);

      const fee  = Math.ceil(amt * 0.01) + 10;
      if (sBal - amt - fee < 10) throw new Error('Saldo tidak mencukupi (minimal sisa 10 koin).');

      // Update balances
      tx.update(sRef, { coinBalance: sBal - amt - fee });
      tx.update(rRef, { coinBalance: rBal + amt });
      tx.update(fRef, { coinBalance: fBal + fee });

      // Log transaksi (semua pihak)
      const ts = serverTimestamp();
      tx.set(doc(collection(sRef,'transactions')), { timestamp:ts, amount: -(amt+fee), to: toUid,            type:'transfer-out' });
      tx.set(doc(collection(rRef,'transactions')), { timestamp:ts, amount: +amt,      from: currentUser.uid, type:'transfer-in'  });
      tx.set(doc(collection(fRef,'transactions')), { timestamp:ts, amount: +fee,      from: currentUser.uid, type:'fee'           });
    });

    transferStatus.textContent='Transfer berhasil!';
    await Promise.all([ loadBalance(currentUser.uid), loadHistory(currentUser.uid) ]);
  }catch(e){
    console.error(e);
    transferStatus.textContent = 'Error: ' + (e?.message || e);
  }
};
</script>
</body>
</html>
