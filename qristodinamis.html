<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>QRIS Statis → Dinamis (Nominal + fee)</title>
<style>
  body { font-family: Inter, system-ui, sans-serif; padding:20px; max-width:820px; margin:0 auto; }
  h1{ margin:0 0 12px 0; font-size:18px }
  .row{ display:flex; gap:12px; align-items:center; margin-bottom:12px; flex-wrap:wrap;}
  label{ min-width:140px; }
  input[type="number"]{ padding:8px; width:160px; }
  button{ padding:8px 12px; cursor:pointer; }
  .card{ border:1px solid #e5e5e5; padding:12px; border-radius:8px; margin-top:12px; }
  .qr { width:300px; height:300px; }
  pre{ background:#f6f6f6; padding:8px; overflow:auto; }
  .small{ font-size:13px; color:#666; }
</style>
</head>
<body>
  <h1>Ubah QRIS statis → dinamis (nominal + 0.8% + Rp850)</h1>
  <div class="card">
    <div class="row">
      <label>Payload QRIS statis (raw):</label>
      <textarea id="basePayload" rows="3" style="width:100%;max-width:520px">00020101021126610014COM.GO-JEK.WWW01189360091433055874630210G3055874630303UMI51440014ID.CO.QRIS.WWW0215ID10254231099470303UMI5204481453033605802ID5925ZkgamingstoreGoTo, Toko H6007TANGSEL61051522062070703A0163040657</textarea>
    </div>

    <div class="row">
      <label>Masukkan nominal (Rp):</label>
      <input id="nominal" type="number" min="0" step="1" placeholder="contoh: 100000" />
      <button id="genBtn">Generate QR Dinamis</button>
    </div>

    <div id="out" class="card" style="display:none">
      <div class="row">
        <div>
          <div class="small">Nominal input</div>
          <div id="nominalLabel"></div>
        </div>
        <div>
          <div class="small">Fee 0.8%</div>
          <div id="feePercent"></div>
        </div>
        <div>
          <div class="small">Biaya tetap</div>
          <div>Rp 850</div>
        </div>
        <div>
          <div class="small">Total (dibulatkan ke Rupiah)</div>
          <div id="totalLabel" style="font-weight:700"></div>
        </div>
      </div>

      <div style="display:flex; gap:24px; align-items:flex-start; margin-top:12px; flex-wrap:wrap">
        <div id="qrcode" class="qr"></div>
        <div style="flex:1; min-width:280px">
          <div class="small">Payload QRIS akhir (untuk scan/give kepada user):</div>
          <pre id="finalPayload" style="max-height:260px"></pre>
          <button id="copyBtn">Salin payload</button>
        </div>
      </div>
    </div>
  </div>

  <!-- QRCode.js (CDN) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script>
  // CRC16-CCITT (poly 0x1021, init 0xFFFF) — cocok untuk EMV QR CRC
  function crc16ccitt(str) {
    let crc = 0xFFFF;
    for (let i = 0; i < str.length; i++) {
      crc ^= (str.charCodeAt(i) << 8);
      for (let j = 0; j < 8; j++) {
        crc = (crc & 0x8000) ? ((crc << 1) ^ 0x1021) : (crc << 1);
        crc &= 0xFFFF;
      }
    }
    return crc.toString(16).toUpperCase().padStart(4, '0');
  }

  // Pad 2 digits for EMV length
  function padLen(n) { return String(n).padStart(2, '0'); }

  // Insert tag '54' (amount) before tag '53' if present, else before '6304'
  function insertAmountTag(payload630, amountStr) {
    // payload630: string that ends with '6304' (no CRC yet)
    const amountField = '54' + padLen(amountStr.length) + amountStr;
    const idx5303 = payload630.indexOf('5303'); // tag 53 start
    if (idx5303 !== -1) {
      return payload630.slice(0, idx5303) + amountField + payload630.slice(idx5303);
    } else {
      // insert before '6304'
      const idx6304 = payload630.indexOf('6304');
      if (idx6304 !== -1) {
        return payload630.slice(0, idx6304) + amountField + payload630.slice(idx6304);
      } else {
        // fallback: append
        return payload630 + amountField;
      }
    }
  }

  function formatRupiahTwoDecimals(rp) {
    // rp is number (rupiah). We produce string with 2 decimals "10000.00"
    return rp.toFixed(2);
  }

  // main
  document.getElementById('genBtn').addEventListener('click', () => {
    const raw = document.getElementById('basePayload').value.trim();
    if (!raw) return alert('Masukkan payload QRIS statis dulu.');
    const nominal = Number(document.getElementById('nominal').value || 0);
    if (!nominal || nominal <= 0) return alert('Masukkan nominal valid (>0).');

    // fees
    const feePercent = nominal * 0.008;
    const fixedFee = 850;
    const total = Math.round(nominal + feePercent + fixedFee); // dibulatkan ke rupiah
    const amountStr = formatRupiahTwoDecimals(total); // e.g. "10000.00"

    // prepare base payload without CRC: ensure it ends with '6304'
    // assume last 8 chars are '6304' + 4hex if original has CRC
    let payloadNoCRC;
    if (raw.slice(-8, -4) === '6304') {
      // original has 6304 + 4 hex = last 8 chars
      payloadNoCRC = raw.slice(0, -8) + '6304';
    } else {
      // if not, try find '6304' position
      const idx = raw.indexOf('6304');
      if (idx !== -1) payloadNoCRC = raw.slice(0, idx+4);
      else payloadNoCRC = raw + '6304';
    }

    // insert amount
    const withAmount630 = insertAmountTag(payloadNoCRC, amountStr);

    // compute CRC
    const crc = crc16ccitt(withAmount630);
    const finalPayload = withAmount630 + crc;

    // show results & generate QR
    document.getElementById('out').style.display = 'block';
    document.getElementById('nominalLabel').innerText = `Rp ${nominal.toLocaleString('id-ID')}`;
    document.getElementById('feePercent').innerText = `Rp ${Math.round(feePercent).toLocaleString('id-ID')} (${(0.8)}%)`;
    document.getElementById('totalLabel').innerText = `Rp ${total.toLocaleString('id-ID')}`;
    document.getElementById('finalPayload').innerText = finalPayload;

    // generate QR (replace previous)
    document.getElementById('qrcode').innerHTML = '';
    new QRCode(document.getElementById('qrcode'), {
      text: finalPayload,
      width: 300,
      height: 300,
      correctLevel: QRCode.CorrectLevel.H
    });
  });

  document.getElementById('copyBtn').addEventListener('click', () => {
    const t = document.getElementById('finalPayload').innerText;
    if (!t) return;
    navigator.clipboard?.writeText(t).then(()=> alert('Payload disalin ke clipboard.'));
  });
  </script>
</body>
</html>
