<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ubah Foto QRIS Statis → Dinamis (demo)</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
  body{background:#0b1020;color:#e6eef8;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;}
  .card{background:#0f1a2b;border:1px solid rgba(255,255,255,0.04)}
  .qr-canvas{background:#fff;padding:12px;border-radius:8px;display:inline-block;}
  .small-muted{color:#9fb0d6;font-size:0.9rem}
  img#originalPreview{max-width:280px;border-radius:8px;border:1px solid rgba(255,255,255,0.06)}
  #resultQR{max-width:280px}
</style>
</head>
<body class="p-4">
  <div class="container">
    <h3>Ubah Foto QRIS Statis → Dinamis (demo)</h3>
    <p class="small-muted">Upload foto QR, decode payload, masukkan nominal, lalu generate QR baru (coba dulu di sandbox/uang kecil).</p>

    <div class="row g-3">
      <div class="col-md-5">
        <div class="card p-3 mb-3">
          <label class="form-label">Upload foto QR (PNG/JPG)</label>
          <input id="fileInput" type="file" accept="image/*" class="form-control mb-2"/>
          <div class="d-flex gap-2 align-items-center">
            <img id="originalPreview" alt="preview" src="" />
            <div>
              <div><strong>Payload decoded:</strong></div>
              <textarea id="payloadText" class="form-control" rows="6" readonly style="background:#071029;color:#dff0ff"></textarea>
            </div>
          </div>
          <div class="form-text small-muted mt-2">
            Kalau decode gagal, bisa jadi foto blur / QR rusak.
          </div>
        </div>

        <div class="card p-3">
          <label class="form-label">Masukkan nominal (Rp)</label>
          <div class="input-group mb-2">
            <span class="input-group-text">Rp</span>
            <input id="amountInput" type="number" min="0" step="1" class="form-control" placeholder="contoh: 12500" />
          </div>

          <div class="form-check form-switch mb-2">
            <input class="form-check-input" type="checkbox" id="visualOnly" />
            <label class="form-check-label" for="visualOnly">Hanya overlay teks di gambar (⚠ tidak mengubah payload)</label>
          </div>

          <button id="makeBtn" class="btn btn-primary">Buat QR DINAMIS</button>
          <button id="overlayBtn" class="btn btn-outline-secondary">Overlay Nominal di Foto</button>

          <div class="mt-2 small-muted">
            Catatan: Skrip ini <em>mencoba</em> memasukkan tag EMV '54' (amount). Tidak ada jaminan semua merchant/e-wallet akan menerima hasilnya. Uji terlebih dahulu.
          </div>
        </div>
      </div>

      <div class="col-md-7">
        <div class="card p-3 mb-3">
          <h5>Hasil</h5>
          <div class="d-flex gap-3 align-items-start">
            <div>
              <div class="small-muted">QR baru / regenerasi</div>
              <canvas id="resultQR" class="qr-canvas"></canvas>
            </div>
            <div>
              <div class="small-muted">Payload baru (EMV TLV)</div>
              <textarea id="newPayload" class="form-control" rows="8" readonly style="background:#071029;color:#dff0ff"></textarea>
              <div class="mt-2">
                <button id="downloadBtn" class="btn btn-sm btn-success">Download QR (png)</button>
              </div>
            </div>
          </div>
        </div>

        <div class="card p-3">
          <h6>Log</h6>
          <pre id="log" style="background:#071029;color:#bfe0ff;padding:12px;height:160px;overflow:auto"></pre>
        </div>
      </div>
    </div>
  </div>

  <!-- Libraries: qr-scanner (decode) & qrcode (generate) -->
  <script src="https://cdn.jsdelivr.net/npm/qr-scanner@1.4.2/qr-scanner.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>

<script>
/*
  Flow:
  - decode uploaded image with QRScanner -> payload string
  - parse EMV TLV simple parser (BER-TLV style)
  - set tag "54" with formatted amount (xxxx.yy as string without decimal point? we keep two decimals with dot)
  - rebuild TLV into string
  - generate QR from rebuilt string
  - overlay option simply draws text above original image
*/

/* util: log */
const logEl = document.getElementById('log');
function log(s){ logEl.textContent += s + "\\n"; logEl.scrollTop = logEl.scrollHeight; }

/* File input */
const fileInput = document.getElementById('fileInput');
const originalPreview = document.getElementById('originalPreview');
const payloadText = document.getElementById('payloadText');
const amountInput = document.getElementById('amountInput');
const makeBtn = document.getElementById('makeBtn');
const overlayBtn = document.getElementById('overlayBtn');
const resultQR = document.getElementById('resultQR');
const newPayload = document.getElementById('newPayload');
const downloadBtn = document.getElementById('downloadBtn');
const visualOnly = document.getElementById('visualOnly');

let lastPayload = null;
let lastImage = null;

fileInput.addEventListener('change', async (e)=>{
  const f = e.target.files[0];
  if(!f) return;
  const url = URL.createObjectURL(f);
  originalPreview.src = url;
  lastImage = url;
  payloadText.value = "Decoding…";
  log("File uploaded, mencoba decode QR...");
  try{
    const result = await QrScanner.scanImage(f, {returnDetailedScanResult: false});
    lastPayload = result;
    payloadText.value = result;
    log("Decode sukses.");
  }catch(err){
    lastPayload = null;
    payloadText.value = "Gagal decode: " + (err && err.message ? err.message : String(err));
    log("Decode gagal: " + String(err));
  }
});

/* Simple BER-TLV parser for QR payload (strings) */
function hexToBytes(hex){
  const bytes = [];
  for(let i=0;i<hex.length;i+=2) bytes.push(parseInt(hex.substr(i,2),16));
  return bytes;
}
function bytesToHex(bytes){
  return bytes.map(b => b.toString(16).padStart(2,'0')).join('').toUpperCase();
}
// But QRIS EMV payload is ASCII TLV, not hex. So we will parse ASCII TLV where tag is 2 chars, length 2 chars, then value length as integer.
function parseEMVTLV(payload){
  // payload is ASCII like "000201010212...5405...6304...."
  const out = {};
  let i = 0;
  while(i+4 <= payload.length){
    const tag = payload.substr(i,2); // assume 2-char tag
    const len = parseInt(payload.substr(i+2,2),10);
    if(isNaN(len)) break;
    const value = payload.substr(i+4,len);
    out[tag] = value;
    i += 4 + len;
  }
  return out;
}
function buildEMVTLV(map){
  // map: tag->value (tags 2-char)
  let s = "";
  // Keep tags sorted by tag numeric for deterministic result
  const tags = Object.keys(map).sort();
  for(const t of tags){
    const v = String(map[t]||"");
    const l = v.length.toString().padStart(2,'0');
    s += t + l + v;
  }
  return s;
}

/* Format amount: QRIS typically uses decimal with 2 decimals, but EMV tag 54 often stores numeric with decimal point allowed.
   We'll format as: "1234.56" for Rp 1234.56. For rupiah amounts (no cents), use "12500.00" or "12500". Many implementations expect "12500" or "12500.00".
   We'll put without decimals if input is integer >0, else with .00
*/
function formatAmountIDR(v){
  v = Number(v);
  if(!isFinite(v) || v < 0) return null;
  // treat input as whole rupiah
  return Math.round(v).toString(); // e.g. "12500"
}

/* Main: make dynamic QR */
makeBtn.addEventListener('click', async ()=>{
  if(!lastPayload){
    alert('Belum ada payload yang ter-decode. Upload foto QR dulu.');
    return;
  }
  if(visualOnly.checked){
    alert('Mode visual-only tercentang. Gunakan tombol Overlay jika mau hanya overlay teks di gambar.');
    return;
  }
  const amount = amountInput.value;
  if(!amount){
    alert('Masukkan nominal (angka) dulu.');
    return;
  }
  const amtStr = formatAmountIDR(amount);
  if(!amtStr){
    alert('Nominal tidak valid.');
    return;
  }

  log("Payload asli: " + lastPayload);
  // Parse into simple TLV (2-char tags)
  const parsed = parseEMVTLV(lastPayload);
  log("Parsed tags: " + Object.keys(parsed).join(', '));

  // Insert/replace tag '54' with amount
  // NOTE: This parser assumes tags are 2 chars and lengths encoded as 2-digit decimal.
  parsed['54'] = amtStr; 
  const rebuilt = buildEMVTLV(parsed);
  newPayload.value = rebuilt;
  log("Mencoba generate QR baru dengan tag 54=" + amtStr);

  // Generate QR
  try{
    await QRCode.toCanvas(resultQR, rebuilt, {errorCorrectionLevel:'M', margin:2, width:280});
    log("QR baru berhasil digenerate.");
  }catch(e){
    log("Error generate QR: " + e);
    alert('Gagal generate QR: ' + e);
  }
});

/* Overlay nominal text on original preview (visual only) */
overlayBtn.addEventListener('click', ()=>{
  if(!originalPreview.src){
    alert('Upload dulu foto QR.');
    return;
  }
  const amount = amountInput.value;
  if(!amount){ alert('Masukkan nominal.'); return;}
  // draw image to canvas and overlay text
  const img = new Image();
  img.crossOrigin = "anonymous";
  img.src = originalPreview.src;
  img.onload = ()=>{
    const cvs = document.createElement('canvas');
    const ctx = cvs.getContext('2d');
    const W = Math.min(560, img.width);
    const scale = W / img.width;
    cvs.width = W;
    cvs.height = img.height * scale + 60;
    ctx.fillStyle = '#071029';
    ctx.fillRect(0,0,cvs.width,cvs.height);
    ctx.drawImage(img, 0, 0, img.width*scale, img.height*scale);
    // overlay box
    ctx.fillStyle = 'rgba(0,0,0,0.6)';
    ctx.fillRect(10, img.height*scale + 8, cvs.width - 20, 44);
    ctx.font = '24px Inter, Arial';
    ctx.fillStyle = '#fff';
    ctx.fillText('Rp ' + Number(amount).toLocaleString('id-ID'), 18, img.height*scale + 38);
    // show in result canvas
    const outC = resultQR;
    outC.width = cvs.width;
    outC.height = cvs.height;
    const outCtx = outC.getContext('2d');
    outCtx.drawImage(cvs, 0, 0);
    newPayload.value = '(visual overlay only)';
    log('Overlay dibuat (visual only). Tidak mengubah payload QR asli.');
  };
});

/* Download result canvas as PNG */
downloadBtn.addEventListener('click', ()=>{
  const c = resultQR;
  if(!c || !c.toDataURL) { alert('Belum ada QR untuk didownload'); return; }
  const url = c.toDataURL('image/png');
  const a = document.createElement('a');
  a.href = url;
  a.download = 'qris_dynamic.png';
  a.click();
});

/* Notes in UI about limitations */
log("Tool siap. Upload foto QR untuk memulai.");
</script>
</body>
</html>
