<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Checkout â€” NUBIASTORE</title>
<style>
  body{font-family:Inter,Segoe UI,system-ui; background:#f6f7f9; color:#111; padding:16px;}
  .card{max-width:720px;margin:24px auto;background:#fff;border-radius:8px;padding:18px;box-shadow:0 6px 18px rgba(0,0,0,0.06);}
  h1{color:#16a34a;margin-bottom:6px}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .col{flex:1;min-width:220px}
  .field{margin:.6rem 0}
  .muted{color:#666;font-size:.95rem}
  .amount{font-weight:700;font-size:1.2rem;color:#0f172a}
  .qr{max-width:320px;width:100%;display:block;margin:12px auto}
  .btn{display:inline-block;padding:.6rem 1rem;background:#16a34a;color:#fff;border-radius:6px;text-decoration:none}
  .copy{margin-left:8px;padding:.3rem .6rem;background:#111;color:#fff;border-radius:6px;cursor:pointer}
  .status{display:inline-block;padding:.25rem .6rem;border-radius:6px;font-weight:600}
  .status.initiated{background:#fef3c7;color:#92400e}
  .status.pending{background:#e0f2fe;color:#0369a1}
  .status.completed{background:#dcfce7;color:#166534}
  .status.cancelled{background:#fee2e2;color:#7f1d1d}
  .note{background:#fff7ed;padding:8px;border-left:4px solid #f59e0b;color:#92400e;margin-top:12px}
</style>
</head>
<body>
  <div class="card">
    <h1>Checkout</h1>
    <div id="loading" class="muted">Mencari invoice...</div>

    <div id="notfound" style="display:none;">
      <p>Invoice tidak ditemukan. Pastikan URL berformat <code>?invoice=INVC-... </code></p>
    </div>

    <div id="orderBox" style="display:none;">
      <div class="row">
        <div class="col">
          <div class="field"><span class="muted">Invoice</span><div id="invoiceTxt" style="font-weight:700"></div></div>
          <div class="field"><span class="muted">Game</span><div id="gameTxt">â€”</div></div>
          <div class="field"><span class="muted">ID Akun</span><div id="idTxt">â€”</div></div>
          <div class="field"><span class="muted">Server</span><div id="srvTxt">â€”</div></div>
          <div class="field"><span class="muted">No. WA</span><div id="waTxt">â€”</div></div>
        </div>

        <div class="col">
          <div class="field"><span class="muted">Nominal</span><div id="nominalTxt">â€”</div></div>
          <div class="field"><span class="muted">Harga</span><div id="priceTxt">â€”</div></div>
          <div class="field"><span class="muted">Admin fee</span><div id="adminTxt">â€”</div></div>
          <div class="field"><span class="muted">Total bayar</span><div class="amount" id="totalTxt">â€”</div></div>
          <div class="field"><span class="muted">Metode</span><div id="methodTxt">â€”</div></div>
          <div class="field">Status: <span id="statusBadge" class="status initiated">â€”</span></div>
        </div>
      </div>

      <hr style="margin:14px 0">

      <div id="paymentUI">
        <!-- will be rendered here: QR or VA -->
      </div>

      <div id="actions" style="margin-top:16px;">
        <button id="btnCopyInvoice" class="copy">Salin Invoice</button>
        <a id="btnShareWA" class="btn" href="#" target="_blank">Laporkan/Share via WA</a>
      </div>

      <div id="adminNote" class="note" style="display:none;">
        Admin belum memproses pembayaran. Jika sudah bayar, tunggu update status "completed".
      </div>
    </div>
  </div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, doc, onSnapshot, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyA3KhNSK0AaKYvXuZE9hi0ZRN9Ysmh9aXc",
  authDomain: "zestoreid-f9e85.firebaseapp.com",
  projectId: "zestoreid-f9e85",
  storageBucket: "zestoreid-f9e85.firebasestorage.app",
  messagingSenderId: "426093692154",
  appId: "1:426093692154:web:38c6e9c143af626a623543",
  measurementId: "G-TS0YB9NYW8"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// simple mapping fallback (jika server belum mengisi payment_data)
const FALLBACK_QR = {
  "DANA": "https://example.com/fallback-qris-dana.png",
  "GOPAY": "https://example.com/fallback-qris-gopay.png",
  "QRIS": "https://example.com/fallback-qris-generic.png"
};
const FALLBACK_VA = {
  VA_BRI: { bank: "BRI", number: "5790-8569-7747-768" },
  VA_BNI: { bank: "BNI", number: "9888-3081-0216-1147" },
  VA_MANDIRI: { bank: "Mandiri", number: "8889-8285-6977-4776-8" }
};

function el(id){ return document.getElementById(id); }
function fmtRp(n){ return typeof n === 'number' ? n.toLocaleString('id') : n; }

const params = new URLSearchParams(location.search);
const invoice = params.get('invoice');

if(!invoice){
  el('loading').textContent = 'Invoice kosong. Contoh: /checkout?invoice=INVC-ML-...';
  el('notfound').style.display = 'block';
  throw new Error('no-invoice');
}

el('loading').textContent = `Menunggu data order ${invoice}...`;

const orderRef = doc(db, 'orders', invoice);

// realtime listener
const unsub = onSnapshot(orderRef, (snap) => {
  if(!snap.exists()){
    el('loading').style.display = 'none';
    el('notfound').style.display = 'block';
    return;
  }
  el('loading').style.display = 'none';
  el('notfound').style.display = 'none';
  el('orderBox').style.display = 'block';

  const d = snap.data();
  renderOrder(d);
}, (err) => {
  console.error('snapshot error', err);
  el('loading').textContent = 'Gagal mengambil data order.';
});

// render function
function renderOrder(d){
  el('invoiceTxt').textContent = d.invoice || invoice;
  el('gameTxt').textContent = d.game || '-';
  el('idTxt').textContent = d.game_id || '-';
  el('srvTxt').textContent = d.server || '-';
  el('waTxt').textContent = d.noWA || '-';
  el('nominalTxt').textContent = (d.nominalValue ?? '-') + (d.nominalValue && typeof d.nominalValue !== 'string' ? ' ðŸ’Ž' : '');
  el('priceTxt').textContent = 'Rp ' + fmtRp(d.price || '-');
  el('adminTxt').textContent = 'Rp ' + fmtRp(d.adminFee || 0);
  el('totalTxt').textContent = 'Rp ' + fmtRp(d.amount_total || '-');
  el('methodTxt').textContent = (d.payment_method || '-').replace('_',' ');
  setStatusBadge(d.status || 'initiated');

  // payment UI
  const paymentUI = el('paymentUI');
  paymentUI.innerHTML = ''; // reset

  const pm = d.payment_method || '';
  const pd = d.payment_data || {};

  if(pm.startsWith('VA_') || pm.startsWith('VA')) {
    // show VA
    const bankKey = pm; // e.g. VA_BRI
    const vaNumber = pd.va_number || (FALLBACK_VA[bankKey] && FALLBACK_VA[bankKey].number) || 'N/A';
    const bankName = pd.bank || (FALLBACK_VA[bankKey] && FALLBACK_VA[bankKey].bank) || bankKey;
    paymentUI.innerHTML = `
      <h3>Pembayaran via Virtual Account</h3>
      <p class="muted">Bank: <strong>${bankName}</strong></p>
      <p class="muted">No. VA: <strong id="vaNumber">${vaNumber}</strong>
        <button id="copyVa" class="copy">Salin</button></p>
      <p class="muted">Jumlah yang harus dibayar: <strong>Rp ${fmtRp(d.amount_total)}</strong></p>
    `;
    document.getElementById('copyVa').onclick = ()=> {
      navigator.clipboard.writeText(vaNumber).then(()=> alert('No. VA disalin'));
    };
  } else {
    // QR / manual transfer / link
    const qrUrl = pd.qr_image_url || FALLBACK_QR[pm] || pd.qr || null;
    if(qrUrl){
      paymentUI.innerHTML = `
        <h3>Instruksi Pembayaran (${(pm||'QR')})</h3>
        <p class="muted">Scan QR berikut lalu bayar sejumlah: <strong>Rp ${fmtRp(d.amount_total)}</strong></p>
        <img src="${qrUrl}" alt="QRIS" class="qr" />
        <p class="muted">Atau gunakan aplikasi pembayaran sesuai metode.</p>
      `;
    } else {
      paymentUI.innerHTML = `
        <h3>Instruksi Pembayaran</h3>
        <p class="muted">Instruksi pembayaran belum tersedia. Tunggu beberapa saat atau hubungi admin via WA.</p>
      `;
    }
  }

  // actions
  const share = encodeURIComponent(
    `Order #${d.invoice}\nGame:${d.game}\nID:${d.game_id}\nTotal: Rp ${fmtRp(d.amount_total)}\nStatus: ${d.status}\n\nCek: ${location.href}`
  );
  el('btnShareWA').href = `https://wa.me/6285697747768?text=${share}`;

  // admin note visibility
  el('adminNote').style.display = (d.status === 'initiated' || d.status === 'pending') ? 'block' : 'none';
}

function setStatusBadge(status){
  const b = el('statusBadge');
  b.className = 'status ' + (status || 'initiated');
  b.textContent = (status || 'initiated').toUpperCase();
}

// copy invoice quick
el('btnCopyInvoice').onclick = ()=> {
  navigator.clipboard.writeText(invoice).then(()=> alert('Invoice disalin'));
};

</script>
</body>
</html>
