<!-- funded-minimal.html -->
<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Funded Dashboard — Minimal</title>
  <style>
    /* Minimal black / yellow / white theme */
    :root{
      --bg:#000;
      --card:#0a0a0a;
      --muted:#e6e6e6;
      --accent:#ffd400; /* yellow */
      --white:#ffffff;
      --danger:#ff4d4f;
    }
    *{box-sizing:border-box;font-family:Inter,system-ui,Roboto,Arial;}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--white);}
    .wrap{max-width:980px;margin:28px auto;padding:18px;}
    header{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;}
    .brand{font-weight:800;font-size:18px;}
    .profile-btn{background:transparent;border:1px solid rgba(255,255,255,0.08);color:var(--white);padding:8px 12px;border-radius:8px;}
    .card{background:var(--card);border:1px solid rgba(255,255,255,0.04);padding:16px;border-radius:10px;margin-bottom:12px;}
    .muted{color:#cfcfcf;font-size:13px;}
    .row{display:flex;gap:8px;align-items:center;}
    button.btn{background:var(--accent);border:none;color:#000;padding:8px 12px;border-radius:8px;font-weight:700;cursor:pointer;}
    button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--white);}
    .grid{display:grid;grid-template-columns:1fr 360px;gap:16px;}
    .minimal-table{width:100%;border-collapse:collapse;margin-top:12px;}
    .minimal-table th{text-align:left;font-size:13px;color:#ccc;padding:8px 6px}
    .minimal-table td{padding:8px 6px;border-top:1px dashed rgba(255,255,255,0.03);font-size:14px}
    .pill{padding:6px 10px;border-radius:999px;font-weight:700;font-size:12px;background:transparent;border:1px solid rgba(255,255,255,0.06)}
    .pill.pending{color:var(--accent);border-color:rgba(255,212,0,0.2)}
    .pill.success{color:#00ff9d;border-color:rgba(0,255,157,0.2)}
    .hint{font-size:12px;color:#bbb;margin-top:6px}
    input.input{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:8px;border-radius:8px;color:var(--white);width:100%}
    label.small{font-size:12px;color:#bdbdbd}
    .center{display:flex;justify-content:center;align-items:center;gap:8px}
    .danger{background:var(--danger);color:#000}
    .hide {display:none}
    footer{margin-top:18px;color:#aaa;font-size:12px;text-align:center}
    /* responsive */
    @media(max-width:900px){
      .grid{grid-template-columns:1fr}
      .profile-btn{padding:6px 8px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">Funded — Minimal</div>
      <div class="row">
        <div id="signed-as" class="muted"></div>
        <button id="btn-profile" class="profile-btn hide">Profile</button>
        <button id="btn-signout" class="profile-btn hide">Sign out</button>
      </div>
    </header>

    <!-- AUTH CARD -->
    <div id="auth-card" class="card">
      <div style="display:flex;gap:8px;align-items:center;">
        <input id="email" class="input" placeholder="email" />
        <input id="password" type="password" class="input" placeholder="password" />
        <button id="btn-login" class="btn">Sign in</button>
        <button id="btn-register" class="ghost">Register</button>
      </div>
      <div class="hint">Use any email/password. Admin account must use UID: <strong class="muted">viCOsJo4wHVFmhtpmMx1Wd4sDF52</strong></div>
    </div>

    <!-- MAIN -->
    <div id="main" class="hide">
      <div class="grid">
        <!-- LEFT: User view or Admin main area -->
        <div>
          <!-- USER DASHBOARD -->
          <div id="user-view" class="card hide">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div>
                <div style="font-weight:700">Dashboard</div>
                <div class="muted">Simple funded challenge store & account list</div>
              </div>
              <div class="row">
                <button id="btn-buy-challenge" class="btn">Buy Challenge</button>
              </div>
            </div>

            <div style="margin-top:14px">
              <div style="font-weight:700;margin-bottom:8px">My Purchased Accounts</div>
              <table class="minimal-table" id="user-accounts-table">
                <thead><tr><th>Type</th><th>Status</th><th>Info</th></tr></thead>
                <tbody id="user-accounts-body"></tbody>
              </table>
              <div class="hint">Click an account row to view details (login / history)</div>
            </div>
          </div>

          <!-- ACCOUNT DETAILS MODAL (inline) -->
          <div id="account-details" class="card hide">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div>
                <div id="acc-type" style="font-weight:700"></div>
                <div id="acc-rules" class="muted" style="font-size:13px;margin-top:4px"></div>
              </div>
              <div id="acc-status-pill" class="pill"></div>
            </div>

            <div style="margin-top:12px" id="acc-login-area">
              <div style="display:flex;gap:8px">
                <div style="flex:1">
                  <label class="small">Login</label>
                  <div id="acc-login" style="font-weight:700"></div>
                </div>
                <div style="flex:1">
                  <label class="small">Password</label>
                  <div id="acc-pass" style="font-weight:700"></div>
                </div>
                <div style="flex:1">
                  <label class="small">Server</label>
                  <div id="acc-server" style="font-weight:700"></div>
                </div>
              </div>
            </div>

            <div id="acc-history" style="margin-top:12px">
              <div style="font-weight:700">Trading History</div>
              <table class="minimal-table" id="acc-history-table">
                <thead><tr><th>Time</th><th>Side</th><th>Size</th><th>PnL</th></tr></thead>
                <tbody id="acc-history-body"></tbody>
              </table>
            </div>

            <div style="margin-top:12px" class="center">
              <button id="btn-back" class="ghost">Back</button>
            </div>
          </div>

          <!-- ADMIN DASHBOARD (MINIMAL) -->
          <div id="admin-view" class="card hide">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div>
                <div style="font-weight:700">Admin Panel</div>
                <div class="muted">Confirm / Cancel purchases — Enter login credentials — Generate history</div>
              </div>
            </div>

            <div style="margin-top:12px">
              <div style="font-weight:700;margin-bottom:8px">Pending Purchases</div>
              <table class="minimal-table" id="admin-tx-table">
                <thead><tr><th>Tx</th><th>User</th><th>Price</th><th>Action</th></tr></thead>
                <tbody id="admin-tx-body"></tbody>
              </table>
            </div>

            <div style="margin-top:12px">
              <div style="font-weight:700;margin-bottom:8px">Manual Tools</div>
              <div class="muted">Select a purchase then:</div>
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px">
                <div>
                  <label class="small">Login</label>
                  <input id="admin-login" class="input" placeholder="login">
                </div>
                <div>
                  <label class="small">Password</label>
                  <input id="admin-pass" class="input" placeholder="password">
                </div>
                <div>
                  <label class="small">Server</label>
                  <input id="admin-server" class="input" placeholder="server">
                </div>
                <div>
                  <label class="small">Result</label>
                  <select id="admin-result" class="input">
                    <option value="pass">Pass (create account)</option>
                    <option value="fail">Fail (reject)</option>
                  </select>
                </div>
              </div>
              <div style="margin-top:8px" class="center">
                <button id="admin-confirm" class="btn">Confirm / Apply</button>
                <button id="admin-cancel" class="ghost">Clear</button>
              </div>
            </div>

            <div style="margin-top:12px">
              <div style="font-weight:700;margin-bottom:8px">Generate Trading History (for an active account)</div>
              <div class="muted">Enter simple trade (lot, side, pnl)</div>
              <div style="display:flex;gap:8px;margin-top:8px">
                <input id="th-lot" class="input" placeholder="lot e.g. 0.10">
                <select id="th-side" class="input">
                  <option value="buy">buy</option><option value="sell">sell</option>
                </select>
                <input id="th-pnl" class="input" placeholder="pnl e.g. 12.34">
                <button id="th-add" class="btn">Add</button>
              </div>
              <div class="hint" style="margin-top:8px">Trades added will appear instantly in user's account history.</div>
            </div>
          </div>
        </div>

        <!-- RIGHT: Catalog / Info -->
        <div>
          <div id="catalog-card" class="card">
            <div style="font-weight:700">Challenges</div>
            <div class="muted" style="margin-top:6px">Choose a challenge and click Buy</div>

            <div style="margin-top:12px">
              <!-- sample challenge items -->
              <div style="display:grid;gap:8px">
                <div class="card" style="display:flex;justify-content:space-between;align-items:center">
                  <div>
                    <div style="font-weight:700">Bronze — $25</div>
                    <div class="muted">Balance: $1,000 · Target 5% · Max DD 10% · Duration 7 days</div>
                  </div>
                  <div>
                    <button class="btn buy-item" data-type="Bronze" data-price="25" data-balance="1000" data-target="5" data-dd="10">Buy</button>
                  </div>
                </div>

                <div class="card" style="display:flex;justify-content:space-between;align-items:center">
                  <div>
                    <div style="font-weight:700">Silver — $50</div>
                    <div class="muted">Balance: $2,500 · Target 5% · Max DD 8% · Duration 10 days</div>
                  </div>
                  <div>
                    <button class="btn buy-item" data-type="Silver" data-price="50" data-balance="2500" data-target="5" data-dd="8">Buy</button>
                  </div>
                </div>

                <div class="card" style="display:flex;justify-content:space-between;align-items:center">
                  <div>
                    <div style="font-weight:700">Gold — $100</div>
                    <div class="muted">Balance: $5,000 · Target 5% · Max DD 6% · Duration 14 days</div>
                  </div>
                  <div>
                    <button class="btn buy-item" data-type="Gold" data-price="100" data-balance="5000" data-target="5" data-dd="6">Buy</button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="card" style="margin-top:12px">
            <div style="font-weight:700">How it works</div>
            <ol class="muted" style="margin-top:8px">
              <li>User buys → opens payment page (simulated)</li>
              <li>Payment writes a transaction with <code>status: pending</code></li>
              <li>Admin confirms & supplies MT5 credentials (or fails)</li>
              <li>User sees account + login info & generated history</li>
            </ol>
          </div>
        </div>
      </div>
    </div>

    <footer>Demo — move sensitive logic server-side before production</footer>
  </div>

  <!-- firebase modules -->
  <script type="module">
    // ---------------------------
    //  CONFIG - replace with your Firebase project config
    // ---------------------------
    const firebaseConfig = {
  apiKey: "AIzaSyDVUEZ3ZVmH4ld7LVnEq_L368wEJpEs-l8",
  authDomain: "zeepaylater-93a94.firebaseapp.com",
  projectId: "zeepaylater-93a94",
  storageBucket: "zeepaylater-93a94.appspot.com",
  messagingSenderId: "358065954807",
  appId: "1:358065954807:web:66619211fea82a4b2518f2"
};
    // ---------------------------
    // ADMIN UID already requested
    const ADMIN_UID = "viCOsJo4wHVFmhtpmMx1Wd4sDF52";
    // ---------------------------

    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import {
      getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import {
      getFirestore, collection, addDoc, doc, updateDoc, setDoc, query, where, onSnapshot, orderBy, serverTimestamp, getDocs, getDoc
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // UI refs
    const authCard = document.getElementById('auth-card');
    const main = document.getElementById('main');
    const userView = document.getElementById('user-view');
    const adminView = document.getElementById('admin-view');
    const btnLogin = document.getElementById('btn-login');
    const btnRegister = document.getElementById('btn-register');
    const btnProfile = document.getElementById('btn-profile');
    const btnSignout = document.getElementById('btn-signout');
    const signedAs = document.getElementById('signed-as');

    const btnBuyChallenge = document.getElementById('btn-buy-challenge');
    const buyButtons = document.querySelectorAll('.buy-item');

    const userAccountsBody = document.getElementById('user-accounts-body');
    const accountDetails = document.getElementById('account-details');
    const accType = document.getElementById('acc-type');
    const accRules = document.getElementById('acc-rules');
    const accStatusPill = document.getElementById('acc-status-pill');
    const accLogin = document.getElementById('acc-login');
    const accPass = document.getElementById('acc-pass');
    const accServer = document.getElementById('acc-server');
    const accHistoryBody = document.getElementById('acc-history-body');
    const btnBack = document.getElementById('btn-back');

    const adminTxBody = document.getElementById('admin-tx-body');
    const adminLogin = document.getElementById('admin-login');
    const adminPass = document.getElementById('admin-pass');
    const adminServer = document.getElementById('admin-server');
    const adminResult = document.getElementById('admin-result');
    const adminConfirm = document.getElementById('admin-confirm');
    const adminCancel = document.getElementById('admin-cancel');

    const thLot = document.getElementById('th-lot');
    const thSide = document.getElementById('th-side');
    const thPnl = document.getElementById('th-pnl');
    const thAdd = document.getElementById('th-add');

    // state
    let currentUser = null;
    let selectedTx = null; // for admin confirm
    let selectedAccountView = null; // account id currently opened in user details

    // AUTH actions
    btnLogin.addEventListener('click', async ()=>{
      const email = document.getElementById('email').value.trim();
      const pass = document.getElementById('password').value;
      if(!email || !pass) return alert('fill email + pass');
      try{ await signInWithEmailAndPassword(auth, email, pass); }
      catch(e){ alert('Login error: '+e.message); }
    });
    btnRegister.addEventListener('click', async ()=>{
      const email = document.getElementById('email').value.trim();
      const pass = document.getElementById('password').value;
      if(!email || !pass) return alert('fill email + pass');
      try{ await createUserWithEmailAndPassword(auth, email, pass); alert('Registered — sign in now'); }
      catch(e){ alert('Register error: '+e.message); }
    });
    btnSignout.addEventListener('click', ()=> signOut(auth));

    // auth state
    onAuthStateChanged(auth, async user=>{
      currentUser = user;
      if(user){
        signedAs.textContent = user.email||user.uid;
        authCard.classList.add('hide');
        main.classList.remove('hide');
        btnProfile.classList.remove('hide');
        btnSignout.classList.remove('hide');

        if(user.uid === ADMIN_UID){
          // admin view
          userView.classList.add('hide');
          adminView.classList.remove('hide');
          accountDetails.classList.add('hide');
          startAdminListeners();
        } else {
          // normal user
          adminView.classList.add('hide');
          userView.classList.remove('hide');
          accountDetails.classList.add('hide');
          startUserListeners();
        }
      } else {
        signedAs.textContent = '';
        authCard.classList.remove('hide');
        main.classList.add('hide');
        btnProfile.classList.add('hide');
        btnSignout.classList.add('hide');
        stopListeners();
      }
    });

    // ---------- LISTENERS ----------
    let unsubUserTx = null, unsubUserAcc = null, unsubAdminTx = null;
    function stopListeners(){
      if(unsubUserTx){unsubUserTx(); unsubUserTx=null;}
      if(unsubUserAcc){unsubUserAcc(); unsubUserAcc=null;}
      if(unsubAdminTx){unsubAdminTx(); unsubAdminTx=null;}
    }

    // user listeners: accounts for this user
    function startUserListeners(){
      stopListeners();
      if(!currentUser) return;
      const qAcc = query(collection(db,'accounts'), where('uid','==', currentUser.uid), orderBy('createdAt','desc'));
      unsubUserAcc = onSnapshot(qAcc, snap=>{
        const arr = [];
        snap.forEach(d => arr.push({ id:d.id, ...d.data() }));
        renderUserAccounts(arr);
      });
    }

    // admin listeners: pending transactions
    function startAdminListeners(){
      stopListeners();
      const q = query(collection(db,'transactions'), orderBy('createdAt','desc'));
      unsubAdminTx = onSnapshot(q, snap=>{
        const arr = [];
        snap.forEach(d => arr.push({ id:d.id, ...d.data() }));
        renderAdminTx(arr);
      });
    }

    // ---------- RENDERS ----------
    function renderUserAccounts(accounts){
      userAccountsBody.innerHTML = '';
      if(accounts.length===0){
        userAccountsBody.innerHTML = '<tr><td colspan="3" class="muted">No purchased accounts</td></tr>';
        return;
      }
      accounts.forEach(a=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${a.type || '—'}</td>
                        <td><span class="pill ${a.status==='active'?'success':'pending'}">${a.status}</span></td>
                        <td>${a.status==='active'? 'Click to view' : (a.status==='failed' ? 'Not passed' : 'Pending')}</td>`;
        tr.style.cursor = 'pointer';
        tr.onclick = ()=> openAccountDetails(a.id);
        userAccountsBody.appendChild(tr);
      });
    }

    function renderAdminTx(txs){
      adminTxBody.innerHTML = '';
      const pending = txs.filter(t=> t.status === 'pending');
      if(pending.length === 0){
        adminTxBody.innerHTML = '<tr><td colspan="4" class="muted">No pending purchases</td></tr>';
        return;
      }
      pending.forEach(t=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td style="font-size:13px">${t.id}</td>
                        <td style="font-size:13px">${t.uid}</td>
                        <td style="font-size:13px">$${t.price || '-'}</td>
                        <td><div style="display:flex;gap:8px">
                          <button class="ghost" data-id="${t.id}" data-uid="${t.uid}" onclick="window._admin_select_tx(event)">Select</button>
                        </div></td>`;
        adminTxBody.appendChild(tr);
      });
      // store events via global function because dynamic inline
    }

    // connect admin select button globally
    window._admin_select_tx = function(e){
      e.stopPropagation();
      const btn = e.currentTarget;
      const txId = btn.dataset.id;
      const uid = btn.dataset.uid;
      selectedTx = { id: txId, uid };
      adminLogin.value = '';
      adminPass.value = '';
      adminServer.value = '';
      adminResult.value = 'pass';
      alert('Selected tx: ' + txId + '\nEnter credentials (or fail) then click Confirm');
    };

    // ---------- ACCOUNT DETAILS (user) ----------
    async function openAccountDetails(accountId){
      selectedAccountView = accountId;
      accountDetails.classList.remove('hide');
      // fetch account and history
      const accSnap = await getDoc(doc(db,'accounts',accountId));
      if(!accSnap.exists()){ alert('Account not found'); return; }
      const a = accSnap.data();
      accType.textContent = a.type || 'Challenge Account';
      accRules.textContent = `Balance $${a.balance || '-'} · Target ${a.target || '-'}% · Max DD ${a.maxDD || '-'}%`;
      accStatusPill.textContent = a.status || 'pending';
      accStatusPill.className = 'pill ' + (a.status === 'active' ? 'success' : 'pending');
      if(a.status === 'active'){
        accLogin.textContent = a.login;
        accPass.textContent = a.password;
        accServer.textContent = a.server;
        document.getElementById('acc-login-area').style.display = '';
      } else {
        // hide login if failed
        document.getElementById('acc-login-area').style.display = a.status === 'active' ? '' : 'none';
      }
      // history
      const thSnap = await getDoc(doc(db,'trading_histories', accountId));
      accHistoryBody.innerHTML = '';
      if(thSnap.exists()){
        const trades = thSnap.data().trades || [];
        if(trades.length === 0){ accHistoryBody.innerHTML = '<tr><td colspan="4" class="muted">No trades yet</td></tr>'; }
        else {
          trades.forEach(tr=>{
            const trEl = document.createElement('tr');
            trEl.innerHTML = `<td style="font-size:13px">${new Date(tr.entryTime).toLocaleString()}</td>
                              <td style="font-size:13px">${tr.side}</td>
                              <td style="font-size:13px">${tr.size}</td>
                              <td style="font-size:13px">${tr.pnl}</td>`;
            accHistoryBody.appendChild(trEl);
          });
        }
      } else {
        accHistoryBody.innerHTML = '<tr><td colspan="4" class="muted">No trading history</td></tr>';
      }
      // hide main user card
      userView.classList.add('hide');
    }
    btnBack.addEventListener('click', ()=>{
      accountDetails.classList.add('hide');
      userView.classList.remove('hide');
      selectedAccountView = null;
    });

    // ---------- BUY FLOW (open custom payment window simulated) ----------
    buyButtons.forEach(btn=>{
      btn.addEventListener('click', (ev)=>{
        const t = ev.currentTarget.dataset;
        openPaymentWindow(t);
      });
    });

    function openPaymentWindow(data){
      // Simulate custom payment page in a popup window that writes tx (status pending)
      const popup = window.open('', 'paywin', 'width=520,height=420');
      if(!popup) return alert('Popup blocked. Allow popups for this site.');
      popup.document.body.style.background = '#000';
      popup.document.body.style.color = '#fff';
      popup.document.title = 'Custom Payment';
      popup.document.body.innerHTML = `
        <div style="font-family:Inter,system-ui,Roboto,Arial;padding:20px">
          <h2 style="color:var(--accent);font-weight:800">Pay ${data.type} — $${data.price}</h2>
          <p style="color:#ccc">Balance: $${data.balance} · Target ${data.target}% · Max DD ${data.dd}%</p>
          <div style="margin-top:20px">
            <button id="doPay" style="background:#ffd400;border:none;padding:12px;border-radius:8px;font-weight:700;cursor:pointer">Pay Now (simulate)</button>
            <button id="close" style="margin-left:8px;background:transparent;border:1px solid #fff;padding:8px;border-radius:8px;color:#fff">Close</button>
          </div>
        </div>
      `;
      // pass info back to opener
      popup.document.getElementById('doPay').onclick = async ()=>{
        // create transaction doc in Firestore with status 'pending'
        try{
          if(!currentUser) {
            alert('You must be signed in in the main window');
            return;
          }
          const tx = {
            uid: currentUser.uid,
            type: data.type,
            price: Number(data.price),
            balance: Number(data.balance),
            target: Number(data.target),
            maxDD: Number(data.dd),
            status: 'pending',
            createdAt: serverTimestamp()
          };
          const ref = await addDoc(collection(db,'transactions'), tx);
          alert('Payment simulated. Transaction created: ' + ref.id + '\\nStatus: pending. Close this window.');
          popup.close();
        }catch(e){
          alert('Payment error: '+e.message);
        }
      };
      popup.document.getElementById('close').onclick = ()=> popup.close();
    }

    // ---------- ADMIN: confirm / fail and create account ----------
    adminConfirm.addEventListener('click', async ()=>{
      if(!selectedTx) return alert('Select a pending transaction first from the table (Select button).');
      const res = adminResult.value;
      try{
        if(res === 'fail'){
          // mark transaction as failed and create a record in accounts with status failed
          await updateDoc(doc(db,'transactions',selectedTx.id), { status: 'failed', adminUid: currentUser.uid, resolvedAt: serverTimestamp() });
          // create an account record with status failed for clarity
          const accRef = await addDoc(collection(db,'accounts'), {
            uid: selectedTx.uid,
            type: 'failed',
            status: 'failed',
            createdAt: serverTimestamp()
          });
          alert('Transaction marked failed. User will see "not passed".');
        } else {
          // pass -> admin must provide login/pass/server
          const login = adminLogin.value.trim();
          const pass = adminPass.value.trim();
          const server = adminServer.value.trim();
          if(!login || !pass || !server) return alert('Fill login/password/server for account creation.');
          // create account document and link to transaction
          const accRef = await addDoc(collection(db,'accounts'), {
            uid: selectedTx.uid,
            type: (await getDoc(doc(db,'transactions',selectedTx.id))).data().type || 'Challenge',
            login, password: pass, server, balance: (await getDoc(doc(db,'transactions',selectedTx.id))).data().balance || 0,
            target: (await getDoc(doc(db,'transactions',selectedTx.id))).data().target || null,
            maxDD: (await getDoc(doc(db,'transactions',selectedTx.id))).data().maxDD || null,
            status: 'active',
            createdAt: serverTimestamp()
          });
          // link account to tx & set tx status to success
          await updateDoc(doc(db,'transactions',selectedTx.id), { status: 'paid', accountId: accRef.id, adminUid: currentUser.uid, resolvedAt: serverTimestamp() });
          // create empty trading_history doc
          await setDoc(doc(db,'trading_histories', accRef.id), { trades: [], generatedAt: serverTimestamp() });
          alert('Account created & transaction confirmed. User will see login info.');
        }
        // clear selection
        selectedTx = null;
      }catch(e){
        alert('Admin confirm error: '+e.message);
      }
    });
    adminCancel.addEventListener('click', ()=>{ selectedTx=null; adminLogin.value=''; adminPass.value=''; adminServer.value=''; adminResult.value='pass'; alert('Cleared selection'); });

    // ---------- ADMIN: add trade to an account's history ----------
    thAdd.addEventListener('click', async ()=>{
      const lot = thLot.value.trim();
      const side = thSide.value;
      const pnl = Number(thPnl.value);
      if(!selectedAccountView) return alert('Open an account details (as user) to know which account to add trades to. Admin can also set selectedAccountView by clicking user account in DB viewer.');
      if(!lot || isNaN(pnl)) return alert('Fill lot and pnl correctly.');
      try{
        // append trade to trading_histories/{accountId}
        const thRef = doc(db,'trading_histories', selectedAccountView);
        const thSnap = await getDoc(thRef);
        let trades = [];
        if(thSnap.exists()) trades = thSnap.data().trades || [];
        trades.push({ entryTime: new Date().toISOString(), side, size: lot, pnl, balance: (trades.length? trades[trades.length-1].balance + pnl : pnl), note: 'admin-added' });
        await setDoc(thRef, { trades, generatedAt: serverTimestamp() });
        alert('Trade added to account history.');
        // refresh account details if currently open
        if(accountDetails.classList.contains('hide') === false){
          openAccountDetails(selectedAccountView);
        }
      }catch(e){ alert('Add trade error: '+e.message); }
    });

    // ---------- helper small: render initial empty tables if no data ----------
    (function initPlaceholders(){
      userAccountsBody.innerHTML = '<tr><td colspan="3" class="muted">No purchased accounts</td></tr>';
      adminTxBody.innerHTML = '<tr><td colspan="4" class="muted">No pending purchases</td></tr>';
    })();

    // ---------- note ----------
    // This demo does client-side auto-creation & history updates for quick testing.
    // Move these procedures to Cloud Functions for security.
  </script>
</body>
</html>
