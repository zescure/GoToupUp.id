<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Checkout - bloodstrike Zestore</title>
  <style>
    /* ===== RESET & BASE ===== */
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family:'Segoe UI',sans-serif;
      background: radial-gradient(ellipse at top, #001f3f, #000);
      color:#fff;
      counter-reset:step;
    }
    a { text-decoration:none; color:inherit; }
    .container { max-width:480px; margin:1rem auto; padding:1rem; }
    h2 { margin-bottom:1rem; color:#00bfff; }

    /* ===== HEADER ===== */
    header {
      display:flex; justify-content:space-between; align-items:center;
      padding:1rem; background:#011627; position:relative; z-index:1001;
    }
    .menu-btn, .login-btn {
      background:none; border:none; color:#00bfff; font-size:1.6rem; cursor:pointer;
    }
    .logo { color:#00bfff; font-size:1.6rem; letter-spacing:2px; }

    /* ===== MOBILE MENU ===== */
    .mobile-menu {
      position:fixed; top:0; left:-100%;
      width:80%; max-width:300px; height:100%;
      background:#011627; padding:2rem 1rem;
      transition:left .3s ease; z-index:1000;
    }
    .mobile-menu.open { left:0; }
    .mobile-menu ul { list-style:none; margin-top:2rem; }
    .mobile-menu li { margin:1.2rem 0; }
    .mobile-menu a { color:#fff; font-size:1.1rem; }

    /* ===== FORM STEP ===== */
    .step {
      background:#022c43; border-radius:6px;
      margin-bottom:1.5rem; overflow:hidden;
    }
    .step-header {
      background:#00bfff; padding:.8rem 1rem; position:relative;
    }
    .step-header::before {
      content:counter(step); counter-increment:step;
      position:absolute; left:-18px; top:50%; transform:translateY(-50%);
      background:#fff; color:#011627;
      width:28px; height:28px; border-radius:50%;
      display:flex; align-items:center; justify-content:center;
      font-weight:bold;
    }
    .step-content { padding:1rem; }
    .step-content label { display:block; margin:.5rem 0 .2rem; font-weight:600; }
    .step-content input {
      width:100%; padding:.6rem; border:none; border-radius:4px; font-size:1rem;
    }

    /* ===== NOMINAL GRID & PAYMENT GRID ===== */
    .nominal-grid, .payment-grid {
      display:grid; grid-template-columns:repeat(3, 1fr); gap:1rem;
    }
    .nominal-card, .payment-card {
      width:100px; background:#022c43;
      border:2px solid transparent; border-radius:6px;
      padding:.8rem .5rem; text-align:center;
      cursor:pointer; box-shadow:0 0 6px rgba(0,191,255,0.3);
      transition:border .2s;
    }
    .nominal-card.selected, .payment-card.selected { border-color:#00bfff; }
    .nominal-card img, .payment-card img {
      width:40px; height:40px; margin-bottom:.5rem;
    }
    .nominal-card .count, .payment-card .name {
      font-size:1.1rem; font-weight:bold; margin-bottom:.3rem;
    }
    .nominal-card .price, .payment-card .fee {
      font-size:.85rem; color:#ddd;
    }
    .payment-card.disabled { opacity:0.5; pointer-events:none; }
    .payment-card .min-info {
      font-size:0.8rem; color:#888; margin-top:4px;
    }

    /* ===== BUTTON ===== */
    .btn {
      display:block; background:#00bfff; color:#011627;
      padding:.7rem 1.5rem; border:none; border-radius:4px;
      font-size:1rem; cursor:pointer; margin-top:1rem;
      text-align:center;
    }

    /* ===== MODAL ===== */
    .modal-overlay {
      position:fixed; top:0; left:0; width:100%; height:100%;
      background:rgba(0,0,0,0.6); display:none;
      align-items:center; justify-content:center; z-index:1002;
      padding:16px;
    }
    .modal {
      background:#fff; color:#011627; border-radius:6px; width:90%; max-width:400px; overflow:hidden;
      display:flex; flex-direction:column;
    }
    .modal-header {
      background:#00bfff; padding:.8rem 1rem; color:#011627; font-weight:bold; text-align:center;
    }
    .modal-body { padding:1rem; color:#333; }
    .modal-body p { margin:.4rem 0; font-size:1rem; line-height:1.4; }
    .modal-body p.total { margin-top:12px; font-size:1.1rem; font-weight:bold; }
    .modal-body img {
      display:block; max-width:200px; margin:1rem auto;
    }
    .modal-footer {
      display:flex; gap:1rem; padding:1rem; justify-content:center; background:#fafafa;
    }
    .modal-footer button {
      flex:1; padding:.6rem; border:none; border-radius:4px; font-size:1rem; cursor:pointer;
    }
    #btnDone { background:#28a745; color:#fff; }
    #btnClose { background:#6c757d; color:#fff; }

    /* Referral section button (Apply) */
    #btnApplyReferral {
      display:block; width:100%; max-width:300px; margin:16px auto 0 auto; padding:12px 0;
      background-color:#00bfff; color:#011627; font-size:1rem; font-weight:600; border:none; border-radius:4px;
      text-align:center; cursor:pointer;
    }
    #btnApplyReferral:hover { background-color:#9ccfe0; }

    /* Responsif modal (mobile full) */
    @media (max-width:480px) {
      .modal { width:100%; height:100%; border-radius:0; justify-content:flex-start; }
      .modal-body { padding:12px; }
      .modal-footer { padding:8px 12px; }
    }
  </style>
</head>
<body>

  <!-- HEADER -->
  <header>
    <button class="menu-btn">&#9776;</button>
    <div class="logo">ZESTORE.id</div>
    <button class="login-btn">V.2.31</button>
  </header>

  <!-- MOBILE MENU -->
  <nav class="mobile-menu" id="mobileMenu">
    <ul>
      <li><a href="home.html">Home</a></li>
    </ul>
  </nav>

  <!-- MAIN FORM -->
  <div class="container">
    <h2>Gold BloodStrike</h2>
    <h5>Top Up Gold dan intem bloodstrike Kamu Di ZESTORE.id Super Lengkap Super Murah Dan Tanpa Biaya Pajak 11%</h5>
    <h6>Hanya Dikenakan Biaya Admin Rp.2500üö´ (Rp.999)‚úÖüì¢</h6>
    <h2>.</h2>

    <!-- STEP 1: Data -->
    <div class="step">
      <div class="step-header">Masukan Data</div>
      <div class="step-content">
        <label for="userId">ID Akun: contoh1234567890</label>
        <input type="text" id="userId" placeholder="Masukkan ID">
        <label for="server">Server: contoh(asia)</label>
        <input type="text" id="server" placeholder="Masukkan Server">
        <label for="whatsapp">No. WhatsApp</label>
        <input type="text" id="whatsapp" placeholder="628xxxxxxxxxx">
      </div>
    </div>

    <!-- STEP 2: Nominal -->
    <div class="step">
      <div class="step-header">Pilih Nominal</div>
      <div class="step-content">
        <div class="nominal-grid" id="nominalGrid">
          <!-- --- Daftar nominal kamu (TIDAK DIUBAH) --- -->
          <!-- !!! Tidak perlu tambah atribut cashback di sini.
               Semua nilai cashback kamu atur di CASHBACK_TABLE di JS !!! -->
          <div class="nominal-card" data-value="Ultra Skin Lucky Chest" data-price="6985">
            <img src="https://kaleoz-media.seagmcdn.com/kaleoz-store/202504/oss-53ffe50d0fbed975977c274e5f31dc2f.png" alt="Diamond">
            <div class="count">Ultra Skin Lucky Chest</div>
            <div class="price">Rp 6.985</div>
          </div>
          <div class="nominal-card" data-value="Level Up Pass" data-price="27741">
            <img src="https://kaleoz-media.seagmcdn.com/kaleoz-store/202409/oss-a1aff4e8ae1713d5b5f6772cfa34371b.png" alt="Diamond">
            <div class="count">üéñÔ∏èLevel Up Pass</div>
            <div class="price">Rp 27.741</div>
          </div>
          <div class="nominal-card" data-value="Strike Pass Elite" data-price="53880">
            <img src="https://static.wixstatic.com/media/b96809_d30a67957325451c8d888fc3f01e75d3~mv2.jpg/v1/fill/w_480,h_480,al_c,q_80,usm_0.66_1.00_0.01,enc_avif,quality_auto/b96809_d30a67957325451c8d888fc3f01e75d3~mv2.jpg" alt="Diamond">
            <div class="count">Strike Pass Elite</div>
            <div class="price">Rp 53.880</div>
          </div>
          <div class="nominal-card" data-value="Strike Pass Premium" data-price="120220">
            <img src="https://static.wixstatic.com/media/b96809_05f25d43ca0d4d168291052590d96971~mv2.jpg/v1/fit/w_500,h_500,q_90/file.jpg" alt="Diamond">
            <div class="count">ü•áStrike Pass Premium</div>
            <div class="price">Rp 120.220</div>
          </div>
          <div class="nominal-card" data-value="100+5 Gold" data-price="11355">
            <img src="https://www.sipshop.co.id/_next/image?url=https%3A%2F%2Fcdn.bangjeff.com%2Fgallery%2F100Gold.webp&w=1920&q=75" alt="Diamond">
            <div class="count">100+5 Gold</div>
            <div class="price">Rp 11.355</div>
          </div>
          <div class="nominal-card" data-value="300+20 Gold" data-price="33566">
            <img src="https://www.sipshop.co.id/_next/image?url=https%3A%2F%2Fcdn.bangjeff.com%2Fgallery%2F100Gold.webp&w=1920&q=75" alt="Diamond">
            <div class="count">300+20 Gold</div>
            <div class="price">Rp 33.566</div>
          </div>
          <div class="nominal-card" data-value="500+40 Gold" data-price="55767">
            <img src="https://www.sipshop.co.id/_next/image?url=https%3A%2F%2Fcdn.bangjeff.com%2Fgallery%2F100Gold.webp&w=1920&q=75" alt="Diamond">
            <div class="count">500+40 Gold</div>
            <div class="price">Rp 55.767</div>
          </div>
          <div class="nominal-card" data-value="1000+100 Gold" data-price="110850">
            <img src="https://www.sipshop.co.id/_next/image?url=https%3A%2F%2Fcdn.bangjeff.com%2Fgallery%2F100Gold.webp&w=1920&q=75" alt="Diamond">
            <div class="count">1100 Gold</div>
            <div class="price">Rp 110.850</div>
          </div>
          <div class="nominal-card" data-value="2000+200 Gold" data-price="222340">
            <img src="https://www.sipshop.co.id/_next/image?url=https%3A%2F%2Fcdn.bangjeff.com%2Fgallery%2F100Gold.webp&w=1920&q=75" alt="Diamond">
            <div class="count">2200 Gold</div>
            <div class="price">Rp 222.340</div>
          </div>
          <div class="nominal-card" data-value="5000+500 Gold" data-price="559987">
            <img src="https://www.sipshop.co.id/_next/image?url=https%3A%2F%2Fcdn.bangjeff.com%2Fgallery%2F100Gold.webp&w=1920&q=75" alt="Diamond">
            <div class="count">5500 Gold (Murah)</div>
            <div class="price">Rp 559.987</div>
          </div>
          
          <!-- ... (SEMUA NOMINAL PANJANG KAMU TETAP, tidak gue potong)
               Paste semua yang kamu kirim sebelumnya di sini
               (bagian 2/4 yang sangat panjang) -->
          <!-- PASTE FULL LIST MU DI SINI -->
        </div>
      </div>
    </div>

    <!-- STEP 2.1: Kode Referral -->
    <div class="step">
      <div class="step-header">Kode Referral</div>
      <div class="step-content">
        <div class="promo-grid" id="promoGrid">
          <label>
            Kode Referral (opsional, 6 karakter):
            <input type="text" id="referralCode" placeholder="XXXXXX" maxlength="6">
            <button id="btnApplyReferral">Gunakan Kode</button>
          </label>
          <p id="referralMsg"></p>
          <p>Masukan Kode Referral Untuk Mendapatkan Cashback S/D 200Rb</p>
        </div>
      </div>
    </div>

    <!-- STEP 3: Pembayaran -->
    <div class="step">
      <div class="step-header">Metode Pembayaran</div>
      <div class="step-content">
        <div class="payment-grid" id="paymentGrid">
          <div class="payment-card" data-value="DANA PREM" data-admin="800" data-percent="0">
            <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQSzuYLZ06ATosE2rxtWLCDIFJjZIPRfbgv-C0q6-dw4w&s" alt="DANA PREM">
            <div class="name">DANA FAST</div><div class="fee">Admin Rp 800</div>
          </div>
          <div class="payment-card" data-value="DANA" data-admin="999" data-percent="0">
          <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRUWJ0HhGhw0-oW4sY2Q_bOb60AQZ-7-wj6WKg_XqDd0OkHl4sLOTllm8w&s=10" alt="DANA QR">
            <div class="name">OVO (eror)</div><div class="fee">Admin Rp 999</div>
          </div>
          <div class="payment-card" data-value="SHOPEE" data-admin="999" data-percent="0">
          <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQBNxOBzJ2MEGS9yD-6FFy24sIKWJU6H2L0BI1FR52EqQ&s" alt="ShopeePay">
            <div class="name">SHOPEE</div><div class="fee">Admin Rp 999</div>
          </div>
          <div class="payment-card" data-value="SHOPEE PAYLATER" data-admin="1100" data-percent="1.1">
          <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQLM66rtgr2tbp0wgNAVIgPb0TOlkPCAaj-0A&s" alt="ShopeePaylater">
            <div class="name">SPaylater</div><div class="fee">Admin Rp 1.100 + 1%</div>
          </div>
          <div class="payment-card" data-value="GOPAY" data-admin="999" data-percent="0">
          <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRZUc-4khdx1W_y7_ITl8xLnddqdbpqUhq1_Uq_ZfveIFNxxKC7tKFiqRz9&s=10" alt="GoPay">
            <div class="name">GOPAY</div><div class="fee">Admin Rp 999</div>
          </div>
          <div class="payment-card" data-value="QRIS" data-admin="720" data-percent="1">
          <img src="https://c.tenor.com/cgoYGj4rhcUAAAAM/qr-code-codigo-qr.gif" alt="QRIS">
            <div class="name">QRIS</div><div class="fee">Admin Rp 720 + 1%</div>
          </div>
          <div class="payment-card" data-value="VA_BRI" data-admin="2500" data-percent="0" id="vaBRICard">
            <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQKglAyLDEX7EeB7o1y7J6MWLzHlswPmbpiVajxTnzevjZ150RcwADDx2oZ&s=10" alt="VA BRI">
            <div class="name">VA BRI</div><div class="fee">Admin Rp 2.500</div>
            <div class="min-info">Min. Rp 10.000</div>
          </div>
          <div class="payment-card" data-value="VA_BNI" data-admin="2500" data-percent="0" id="vaBNICard">
            <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcToNeEzUwxUgmHpdKbprtPhmkLMN9_gHkH4xX2F7pHqg9dFIO_d3vuoJdCK&s=10" alt="VA BNI">
            <div class="name">VA BNI</div><div class="fee">Admin Rp 2.500</div>
            <div class="min-info">Min. Rp 10.000</div>
          </div>
          <div class="payment-card" data-value="VA_MANDIRI" data-admin="2500" data-percent="0" id="vaMandiriCard">
            <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTzjNJjZetBlWLBzjnNIquL4YH_lziSfcnSkmG5-uINehvJNyAR63K65A8&s=10" alt="VA Bank">
            <div class="name">VA Bank Transfer</div><div class="fee">Admin Rp 2.500</div>
            <div class="min-info">Min. Rp 10.000</div>
          </div>
        </div>
      </div>
    </div>

    <div class="step">
      <div class="step-header"></div>
      <div class="step-content">
        <button class="btn" id="btnCheckout">Lanjutkan Pembayaran</button>
      </div>
    </div>
  </div>

  <!-- MODAL RINCIAN -->
  <div class="modal-overlay" id="modalOverlay" style="display:none;">
    <div class="modal">
      <div class="modal-header">Rincian Pembayaran</div>
      <div class="modal-body">
        <p>ID Akun: <span id="outId"></span></p>
        <p>Gold: <span id="outDiam"></span> üé´</p>
        <p>Harga: Rp <span id="outPrice"></span></p>
        <p>Biaya Admin: Rp <span id="outAdmin"></span></p>
        <p class="total">Total: Rp <span id="outTotal"></span></p>
        <p><b>kode server zestore:</b> <span id="outCBBuyer">0Ltc</span> '</p>
        <p><b>kode validasi sistem:</b> <span id="outCBRef">0Bsc</span> '</p>

        <!-- QR Section -->
        <div id="qrSection">
          <img id="qrCode" src="qris-placeholder.png" alt="QR Code Pembayaran">
        </div>

        <!-- VA Section -->
        <div id="vaSection" style="display:none;">
          <button id="btnCopyVA">Copy No. VA</button>
          <p><strong id="vaBankName">Virtual Account</strong></p>
          <p id="vaNumber"></p>
          <p><strong>Catatan:</strong></p>
          <ul>
            <li>Topup via VA kena potongan Rp 2.500 Tergantung Bank Anda</li>
            <li>Salin Kode VA untuk membayar</li>
          </ul>
        </div>
      </div>

      <div class="modal-footer">
        <button id="btnDone">Sudah Bayar</button>
<button id="btnConfirmWA" style="display:none;">Konfirmasi Pembayaran</button>
        <button id="btnClose">Tutup</button>
      </div>
    </div>
  </div>

  <!-- ========================= JS ========================= -->
  <script type="module">
/* ===== Firebase Config ===== */
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
import {
  getFirestore, doc, getDoc, setDoc, updateDoc, increment, serverTimestamp, runTransaction,
  collection
} from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

const firebaseConfig = {
  apiKey: "AIzaSyDVUEZ3ZVmH4ld7LVnEq_L368wEJpEs-l8",
  authDomain: "zeepaylater-93a94.firebaseapp.com",
  projectId: "zeepaylater-93a94",
  storageBucket: "zeepaylater-93a94.appspot.com",
  messagingSenderId: "358065954807",
  appId: "1:358065954807:web:66619211fea82a4b2518f2"
};

const app  = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db   = getFirestore(app);

/* =============== CASHBACK TABLE =============== */
const CASHBACK_TABLE = {
  "3":  { buyer: 10,  ref: 10 },
  "5":  { buyer: 5,  ref: 5 },
  "18": { buyer: 5,  ref: 5 },
  "33": { buyer: 10,  ref: 10 },
  "46": { buyer: 10,  ref: 10 },
  "56": { buyer: 10,  ref: 50 },
  "74":  { buyer: 40,  ref: 70 },
  "85":  { buyer: 40,  ref: 70 },
  "92": { buyer: 40,  ref: 90 },
  "WEEKLY DIAMOND PASS": { buyer: 200,  ref: 250 },
};
const getCashbackByValue = v => CASHBACK_TABLE[v] || { buyer:0, ref:0 };

let currentUser = null;
let appliedReferralCode = null;
let referralOwnerUid    = null;

/* =============== AUTH CHECK =============== */
onAuthStateChanged(auth, async (u)=>{
  if(!u){ location.href='/register-login'; return; }
  currentUser = u;
  const uref = doc(db,'users',u.uid);
  const usnap = await getDoc(uref);
  if(!usnap.exists()){
    await setDoc(uref,{ coinBalance:0, createdAt:serverTimestamp() });
  }
});

/* =============== UI ELEMENTS =============== */
const mobileMenu = document.getElementById('mobileMenu');
document.querySelector('.menu-btn').onclick = ()=> mobileMenu.classList.toggle('open');

const nominalCards = document.querySelectorAll('.nominal-card');
const paymentCards = document.querySelectorAll('.payment-card');
const vaBRICard    = document.getElementById('vaBRICard');
const vaBNICard    = document.getElementById('vaBNICard');
const vaMandiriCard= document.getElementById('vaMandiriCard');
const vaCards      = [vaBRICard, vaBNICard, vaMandiriCard];

const qrSection    = document.getElementById('qrSection');
const vaSection    = document.getElementById('vaSection');
const vaBankName   = document.getElementById('vaBankName');
const vaNumber     = document.getElementById('vaNumber');

const vaData = {
  VA_BRI:     { name:'Bank BRI Virtual Account',     number:'5790-8569-7747-768' },
  VA_BNI:     { name:'Bank BNI Virtual Account',     number:'9888-3081-0216-1147' },
  VA_MANDIRI: { name:'Bank Mandiri Virtual Account', number:'8889-8285-6977-4776-8' }
};

/* =============== CARD SELECTION =============== */
nominalCards.forEach(c=>{
  c.onclick = ()=>{
    nominalCards.forEach(x=> x.classList.remove('selected'));
    c.classList.add('selected');
    const price = parseFloat(c.dataset.price);
    vaCards.forEach(vc=>{
      if(price < 10000) {
        vc.classList.add('disabled'); vc.classList.remove('selected');
      } else {
        vc.classList.remove('disabled');
      }
    });
  };
});
paymentCards.forEach(c=>{
  c.onclick = ()=>{
    if(c.classList.contains('disabled')) return;
    paymentCards.forEach(x=> x.classList.remove('selected'));
    c.classList.add('selected');
  };
});

/* =============== REFERRAL CODE =============== */
const referralInput = document.getElementById('referralCode');
const referralMsg   = document.getElementById('referralMsg');
document.getElementById('btnApplyReferral').onclick = async ()=>{
  const code = referralInput.value.trim().toUpperCase();
  if(code.length !== 6){
    referralMsg.style.color='red'; referralMsg.textContent='Kode referral harus 6 karakter.';
    appliedReferralCode=null; referralOwnerUid=null; return;
  }
  if(!currentUser){
    referralMsg.style.color='red'; referralMsg.textContent='Silakan login dulu.';
    return;
  }
  if(code === currentUser.uid.slice(0,6)){
    referralMsg.style.color='red'; referralMsg.textContent='Kode referral tidak boleh milik sendiri.';
    appliedReferralCode=null; referralOwnerUid=null; return;
  }

  const rRef = doc(db,'referralCodes',code);
  const rSnap = await getDoc(rRef);
  if(!rSnap.exists()){
    referralMsg.style.color='red'; referralMsg.textContent='Kode referral tidak ditemukan.';
    appliedReferralCode=null; referralOwnerUid=null; return;
  }
  appliedReferralCode = code;
  referralOwnerUid    = rSnap.data().owner;
  referralMsg.style.color='lightgreen';
  referralMsg.textContent = 'Kode referral valid. Cashback akan aktif saat pembayaran selesai.';
};

/* =============== MODAL CHECKOUT =============== */
const outId      = document.getElementById('outId');
const outDiam    = document.getElementById('outDiam');
const outPrice   = document.getElementById('outPrice');
const outAdmin   = document.getElementById('outAdmin');
const outTotal   = document.getElementById('outTotal');
const outCBBuyer = document.getElementById('outCBBuyer');
const outCBRef   = document.getElementById('outCBRef');

let lastCalc = null;

document.getElementById('btnCheckout').onclick = ()=>{
  const idSel = document.getElementById('userId').value.trim();
  const srvSel= document.getElementById('server').value.trim();
  const waSel = document.getElementById('whatsapp').value.trim();
  if(!idSel||!srvSel||!waSel) return alert('Lengkapi data dulu ya.');

  const nomSel = document.querySelector('.nominal-card.selected');
  if(!nomSel) return alert('Pilih nominal dulu ya.');
  const paySel = document.querySelector('.payment-card.selected');
  if(!paySel) return alert('Pilih metode pembayaran dulu ya.');

  const value     = nomSel.dataset.value;
  const price     = parseFloat(nomSel.dataset.price);
  const flatAdmin = parseFloat(paySel.dataset.admin);
  const percent   = parseFloat(paySel.dataset.percent||0)/100;
  const adminCalc = Math.ceil(flatAdmin + price*percent);

  const { buyer:buyerCB, ref:refCB } = getCashbackByValue(value);

  // total setelah cashback buyer
  const total     = price + adminCalc - buyerCB;

  outId.textContent    = `${idSel} (Srv: ${srvSel})`;
  outDiam.textContent  = value;
  outPrice.textContent = price.toLocaleString('id');
  outAdmin.textContent = adminCalc.toLocaleString('id');
  outTotal.textContent = total.toLocaleString('id');
  outCBBuyer.textContent = buyerCB;
  outCBRef.textContent   = refCB;

  if(paySel.dataset.value.startsWith('VA_')){
    qrSection.style.display = 'none';
    vaSection.style.display = 'block';
    const data = vaData[paySel.dataset.value];
    vaBankName.textContent = data.name;
    vaNumber.textContent   = data.number;
  } else {
    vaSection.style.display = 'none';
    qrSection.style.display = 'block';
    const qr = document.getElementById('qrCode');
    switch(paySel.dataset.value) {
      case 'DANA PREM':   qr.src = 'https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiKarqRzAZP1G0-5ie2-iFPG3y30n8EvQeIxNoSODfAU6PpvKfwgT5e4L1ONVa6ePcwmkfL8zJDJz6gMp8AaARdYsTuP3L4uDgSc-MxvnPaVqB6NDoyFstNUJdnhSpddyB2MSCM9YOYpa95EsIWvcrBlUkFDTKdEoNnQVl998YAoPuX-Ja7Fh7bcv5XPDrZ/s320/20250205_151426.png'; break;
      case 'DANA': qr.src = 'https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiVDndM5uLTlO9zHYppGE1CVB5TWzJ_EwEJcQhVRDvsitxVTfVUzuvgCbX9f8Ld3ku7MAA6vGZ942UuDmfQZitwbCs1ANvK_hjvcuAy-VGQ2Gkj6nIvUlWRRuotZs0yXAIOg0iBygjAYnuqVVzswPdbsb2wSA3rHrPcacWdqBuI5V9GYp9gZkp_H84JDQ/s992/de7c3eca-57a8-41f1-a1b4-9bc76fb2e719.jpeg'; break;
      case 'SHOPEE': qr.src = 'https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjL8xRyiYxTJJCxDisZZJqBpMuBMpq1K7Z_uoTTb1fo-YRCCn4S3UXvYHG3eqjAF8ZFy1ouRKa4S4hHQfbAi_VBlKUWt8nV7ThT8ZzFB_Bw5jrn8stCQ_5oK15Pxd9DjsGUmG7TEmeuW5XApanfO_DeYcWNoMsmhe3uk9_r3zHDvqmVTOTdHXRXL7Y2wPLJ/s320/20250206_101339.jpg'; break;
      case 'SHOPEE PAYLATER': qr.src = 'https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgZM-slkx7355T7K7TShrOFLMi8wfBT_T4AcKqMmylnvkJ8QivUbN_Clc0USV_8uw-9C_2vuQoH_fJSE9kyrndwUa1QxBsIv7A6915G67qx-lonapn-Y6AEDYoerpzFsJu3eytZMvNeJOmMaKs98JLTLQQ_NuPXPpSYhiDdUdUJniTOjIk74OlZxWsOaA/s1748/IMG_1717.png'; break;
      case 'GOPAY':  qr.src = 'https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgrpYxkkJADDVoGJ0YI-UfcK2roO_JWFbzeVoFiMkKGBvFoze_096vm00gNoFkPMaMGnU0KoWvjpFScv4eP41WgRuYA7kF-UBCmw2lq6hyPkrfoxzi9oFWVoIxjZ1wCb2HIvhYKkCE2DYwixXiJGR-9xsdoEv3z9EdyKaYOa0aKMuImxXLTqpvlf6GkhQ/s320/IMG_1040.jpeg'; break;
      case 'QRIS':   qr.src = 'https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEh4pgwvZu8WTj-V3pvVsadG9zIJJYWVsP03-YPlhqHd47AQjpwioq-wgHQOWFAdsiyvVYJsy2UMl3A6wKRfj3Gqwg_ztB7uVUfmSLBypWSRnUiIyrm459arhYxnHsOYqKnV1Lzhu38_ELI6aGmFyIK6ne9Mja-I4majEAqKfV1PtXiOCGTrVOaLrmgZrA/s1240/ae96baaf-2d65-4b60-b180-463c3a8c6838.jpeg'; break;
    }
  }

  lastCalc = {
    uid: currentUser?.uid || null,
    idSel, srvSel, waSel,
    value, price, adminCalc, total,
    buyerCB, refCB,
    payMethod: paySel.dataset.value,
    referralCode: appliedReferralCode,
    referralOwnerUid
  };

  document.getElementById('modalOverlay').style.display = 'flex';
  startCountdown();
};

document.getElementById('btnClose').onclick = ()=>{
  document.getElementById('modalOverlay').style.display = 'none';
};

/* =============== ADD TO CIRCULATING =============== */
async function addToCirculating(amount) {
  if (!amount || amount <= 0) return;
  await runTransaction(db, async (tx) => {
    const econRef = doc(db, 'economy', 'meta');
    const econSnap = await tx.get(econRef);
    if (!econSnap.exists()) throw 'Dokumen ekonomi tidak ditemukan.';
    const currentCirc = econSnap.data().circulatingSupply || 0;
    tx.update(econRef, { circulatingSupply: currentCirc + amount });
  });
}

/* =============== UTIL: LOG TRANSACTION =============== */
async function logTx(uid, payload){
  try{
    await setDoc(doc(collection(db,'users',uid,'transactions')), {
      timestamp: serverTimestamp(),
      ...payload
    });
  }catch(e){
    console.error('logTx error', e);
  }
}

/* =============== BTN DONE (PROSES KOIN SAJA) =============== */
const btnDone = document.getElementById('btnDone');
const btnConfirmWA = document.getElementById('btnConfirmWA'); // tombol baru

btnDone.onclick = async () => {
  if (!lastCalc) return;
  if (!currentUser) {
    alert('Kamu belum login di halaman utama.');
    return location.href='/register-login';
  }

  const {
    uid, buyerCB, refCB, referralCode, referralOwnerUid,
    value, total, payMethod
  } = lastCalc;

  try {
    let totalCashback = 0;

    // SELALU tambah koin buyer
    if (buyerCB > 0) {
      await updateDoc(doc(db,'users', uid), { coinBalance: increment(buyerCB) });
      totalCashback += buyerCB;

      // LOG transaksi buyer
      await logTx(uid, {
        amount: buyerCB,
        type: 'cashback-topup-buyer',
        value,
        totalBayar: total,
        payMethod,
        referralCode: referralCode || null
      });
    }

    // Jika referral valid ‚Üí tambah koin referrer
    if (referralCode && referralOwnerUid && refCB > 0) {
      const ownerRef = doc(db,'users', referralOwnerUid);
      const ownerSnap = await getDoc(ownerRef);
      if (ownerSnap.exists()) {
        await updateDoc(ownerRef, { coinBalance: increment(refCB) });
        totalCashback += refCB;

        // LOG transaksi referrer
        await logTx(referralOwnerUid, {
          amount: refCB,
          type: 'cashback-topup-referrer',
          from: uid,
          value,
          totalBayar: total,
          payMethod,
          referralCode
        });
      }
    }

    // Tambahkan total cashback ke circulatingSupply
    if (totalCashback > 0) {
      await addToCirculating(totalCashback);
    }

    // Sukses ‚Üí tampilkan tombol Konfirmasi WA
    btnDone.style.display = 'none';
    btnConfirmWA.style.display = 'inline-block';

  } catch (e) {
    console.error('Coin update error:', e);
    alert('Terjadi kesalahan saat memproses koin.');
  }
};

// Tombol konfirmasi WA (hanya direct WA)
btnConfirmWA.onclick = () => {
  if (!lastCalc) return;
  const { idSel, srvSel, waSel, value, total, payMethod, referralCode } = lastCalc;
  const msg =
    `Saya sudah order Mobile Legends *${value} Diamonds MlbbNew*`+
    `\nID: ${idSel} (Server: ${srvSel})`+
    `\nNo. WA: ${waSel}`+
    `\nMetode: ${payMethod.replace('_',' ')}`+
    `\nTotal bayar: Rp ${total.toLocaleString('id')}`+
    (referralCode ? `\nReferral: ${referralCode}` : '');
  window.open(`https://wa.me/6285697747768?text=${encodeURIComponent(msg)}`, '_blank');

  // Optional: tutup modal
  document.getElementById('modalOverlay').style.display = 'none';
  lastCalc = null;
};

/* =============== COPY BUTTONS =============== */
const btnCopyTotal = document.createElement('button');
btnCopyTotal.textContent = 'Copy Total';
btnCopyTotal.style = 'margin-left:8px;padding:4px 8px;cursor:pointer';
document.addEventListener('DOMContentLoaded', ()=>{
  const totalP = document.querySelector('.modal-body p.total');
  if(totalP) totalP.appendChild(btnCopyTotal);
});
btnCopyTotal.onclick = ()=>{
  navigator.clipboard.writeText(document.getElementById('outTotal').textContent)
    .then(()=> alert('Total bayar disalin'));
};
document.getElementById('btnCopyVA')?.addEventListener('click', ()=>{
  navigator.clipboard.writeText(document.getElementById('vaNumber').textContent)
    .then(()=> alert('No. VA disalin'));
});

/* =============== COUNTDOWN =============== */
let countdownInterval=null;
function startCountdown(){
  clearInterval(countdownInterval);
  let bayarSebelum = document.getElementById('bayarSebelum');
  if (!bayarSebelum) {
    bayarSebelum = document.createElement('span');
    bayarSebelum.id = 'bayarSebelum';
    bayarSebelum.style = 'margin-left:10px; font-size:12px; font-weight:bold;';
    document.querySelector('.modal-body p.total').appendChild(bayarSebelum);
  }
  let sisaDetik = 14 * 60;
  const updateCountdown = () => {
    if (sisaDetik <= 0) {
      bayarSebelum.innerHTML = `<span style="color:red">‚è∞ Waktu habis!</span>`;
      clearInterval(countdownInterval);
      return;
    }
    const m = Math.floor(sisaDetik / 60).toString().padStart(2, '0');
    const d = (sisaDetik % 60).toString().padStart(2, '0');
    bayarSebelum.innerHTML = `(Bayar sebelum <span style="color:red">${m}:${d}</span>)`;
    sisaDetik--;
  };
  updateCountdown();
  countdownInterval = setInterval(updateCountdown, 1000);
}

/* =============== AUTO SCROLL =============== */
(function(){
  const nominalGrid = document.getElementById('nominalGrid');
  const paymentGrid = document.getElementById('paymentGrid');
  const btnCheckout = document.getElementById('btnCheckout');

  function smoothTo(el){ el.scrollIntoView({ behavior:'smooth', block:'start' }); }
  nominalGrid.addEventListener('click', e=>{
    if (e.target.closest('.nominal-card')) smoothTo(paymentGrid);
  });
  paymentGrid.addEventListener('click', e=>{
    const card = e.target.closest('.payment-card');
    if (card && !card.classList.contains('disabled')) smoothTo(btnCheckout);
  });
})();
</script>
</body>
</html>
