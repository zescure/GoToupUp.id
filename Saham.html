<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>PaperStocks — Rev (Home / Market / Portfolio)</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#071026; --card:#0f1724; --muted:#98aac6; --text:#e6f0ff;
    --accent:#5de3a6; --danger:#ff7373; --glass: rgba(255,255,255,0.03);
  }
  *{box-sizing:border-box;font-family:Inter,system-ui,Arial}
  html,body{height:100%;margin:0;background:linear-gradient(180deg,#071026,#071827);color:var(--text)}
  .app{max-width:980px;margin:8px auto;padding:12px;display:flex;flex-direction:column;gap:12px}
  header{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:12px;background:rgba(255,255,255,0.02)}
  .logo h1{margin:0;font-size:18px}
  .top-actions{display:flex;gap:8px;align-items:center}
  .btn{padding:8px 12px;border-radius:10px;border:0;background:transparent;color:var(--text);font-weight:700;cursor:pointer}
  .btn-ghost{background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03)}
  .btn-primary{background:linear-gradient(180deg,var(--accent),#26c880);color:#04220f}
  .btn-danger{background:linear-gradient(180deg,#ff8b8b,var(--danger));color:#2b0606}
  .main{display:flex;gap:12px}
  .left{flex:1;display:flex;flex-direction:column;gap:12px}
  .right{width:340px;min-width:260px}
  .card{background:var(--card);padding:12px;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,0.5)}
  .small{font-size:13px;color:var(--muted)}
  .list{display:flex;flex-direction:column;gap:8px}
  .list-item{padding:10px;border-radius:10px;background:rgba(255,255,255,0.015);display:flex;justify-content:space-between;align-items:center}
  footer.bottom-nav{position:fixed;left:12px;right:12px;bottom:12px;background:rgba(7,10,14,0.95);padding:8px;border-radius:14px;display:flex;justify-content:space-around;align-items:center;z-index:999}
  .nav-btn{background:transparent;border:0;color:var(--muted);font-weight:700;padding:6px 8px;border-radius:8px;cursor:pointer}
  .nav-btn.active{background:rgba(255,255,255,0.02);color:var(--text)}
  /* chart */
  .chart-card{height:420px;display:flex;flex-direction:column;gap:8px;overflow:hidden}
  canvas{width:100%;height:100%;border-radius:8px;display:block;touch-action:none}
  /* admin-only (hidden for non-admin) */
  .admin-only{display:none}
  @media(max-width:900px){ .main{flex-direction:column} .right{width:100%} footer.bottom-nav{left:8px;right:8px;bottom:8px} }
</style>
</head>
<body>
<div class="app">
  <header>
    <div class="logo">
      <h1>PaperStocks</h1>
      <div class="small">Simulasi Bursa — Demo</div>
    </div>
    <div class="top-actions">
      <div id="userInfo" class="small">not signed</div>
      <button id="btnSignIn" class="btn btn-ghost">Sign in</button>
      <button id="btnSignOut" class="btn btn-ghost" style="display:none">Sign out</button>
    </div>
  </header>

  <div class="main">
    <div class="left">
      <!-- HOME PAGE -->
      <div id="page-home" class="card">
        <div style="display:flex;justify-content:space-between">
          <div><div style="font-weight:800">Home</div><div class="small">Pilih market untuk melihat chart</div></div>
          <div style="text-align:right"><div class="small">Balance (device)</div><div id="bal" style="font-weight:800">—</div></div>
        </div>

        <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
          <button id="btnDeposit" class="btn btn-ghost">Deposit</button>
          <button id="btnWithdraw" class="btn btn-ghost">Withdraw</button>
          <button id="btnPortfolio" class="btn btn-ghost">Portfolio</button>
        </div>

        <div style="margin-top:12px">
          <div class="small">Daftar Market</div>
          <div id="marketList" class="list" style="margin-top:8px;max-height:420px;overflow:auto"></div>
        </div>
      </div>

      <!-- MARKET PAGE (ONLY CHART + BUY/SELL) -->
      <div id="page-market" class="card" style="display:none">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div id="marketName" style="font-weight:800;font-size:18px">—</div>
            <div id="marketSymbol" class="small">—</div>
          </div>
          <div style="text-align:right">
            <div class="small">Harga / lembar</div>
            <div id="marketPrice" style="font-weight:800;font-size:18px">—</div>
            <div id="marketVolDisplay" class="small">Vol x—</div>
          </div>
        </div>

        <div class="chart-card" style="margin-top:10px">
          <canvas id="chartCanvas"></canvas>
        </div>

        <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
          <div style="flex:1">
            <label>Jumlah lembar (min 100)</label>
            <input id="buyShares" type="number" value="100" min="100"/>
          </div>
          <div style="display:flex;flex-direction:column;gap:8px">
            <button id="btnBuy" class="btn btn-primary" disabled>Beli</button>
            <button id="btnSell" class="btn btn-danger" disabled>Jual</button>
          </div>
        </div>

        <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
          <div style="flex:1">
            <label class="small">Timeframe</label>
            <select id="tfSelect">
              <option value="1000">1s</option>
              <option value="60000">1m</option>
              <option value="300000">5m</option>
              <option value="900000">15m</option>
              <option value="3600000">1h</option>
              <option value="86400000">1d</option>
            </select>
          </div>
          <div style="width:160px;text-align:right">
            <div class="small">Visible</div>
            <div id="visibleCount">—</div>
          </div>
        </div>
        <div id="marketNotice" class="small" style="margin-top:8px;color:var(--muted)">Jika tombol dinonaktifkan, pilih market dari halaman Home terlebih dulu.</div>
      </div>

      <!-- PORTFOLIO (PnL only here) -->
      <div id="page-portfolio" class="card" style="display:none">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><div style="font-weight:800">Portfolio</div><div class="small">Posisi & PnL realtime</div></div>
          <div style="text-align:right"><div class="small">Total Unrealized PnL</div><div id="totalPnl" style="font-weight:900">—</div></div>
        </div>

        <div style="margin-top:12px">
          <div class="small">Open Positions</div>
          <div id="positionsList" class="list" style="margin-top:8px;max-height:240px;overflow:auto"></div>
        </div>

        <div style="margin-top:12px">
          <div class="small">Trade History</div>
          <div id="tradesList" class="list" style="margin-top:8px;max-height:240px;overflow:auto"></div>
        </div>
      </div>

      <!-- EVENTS (read-only for non-admin) -->
      <div id="page-events" class="card" style="display:none">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><div style="font-weight:800">Kalender & Berita</div><div class="small">Lihat event yang mempengaruhi volatilitas market</div></div>
          <div id="adminAddEvent" class="admin-only"><button id="btnOpenAddEvent" class="btn btn-ghost">Tambah Event (Admin)</button></div>
        </div>
        <div style="margin-top:10px">
          <div class="small">Upcoming Events</div>
          <div id="eventsList" class="list" style="margin-top:8px;max-height:360px;overflow:auto"></div>
        </div>
      </div>
    </div>

    <aside class="right">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><div class="small">Selected</div><div id="selectedSymbol" style="font-weight:800">—</div></div>
          <div style="text-align:right"><div class="small">Price</div><div id="selectedPrice">—</div></div>
        </div>

        <div style="margin-top:10px">
          <div class="small">Actions</div>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button id="btnGotoMarket" class="btn btn-ghost">View Market</button>
            <button id="btnGotoPortfolio" class="btn btn-ghost">Portfolio</button>
          </div>
        </div>
      </div>

      <!-- ADMIN panel (hidden for non-admin) -->
      <div id="adminPanel" class="card admin-only" style="margin-top:12px">
        <div><div class="small">Admin</div></div>
        <div style="margin-top:8px">
          <div style="display:flex;gap:8px">
            <button id="btnCreateMarket" class="btn btn-ghost">Create Market</button>
            <button id="btnEditMarket" class="btn btn-ghost">Edit Market</button>
          </div>
          <div style="margin-top:8px">
            <div class="small">Edit Volatility per Market</div>
            <div id="adminVolList" style="margin-top:8px;max-height:180px;overflow:auto"></div>
          </div>
          <div style="margin-top:8px">
            <button id="btnEngineAll" class="btn btn-ghost">Start Engine (All)</button>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <div><div class="small">Recent Trades (device)</div></div>
        <div id="rightHistory" style="margin-top:8px;max-height:220px;overflow:auto"></div>
      </div>
    </aside>
  </div>

  <footer class="bottom-nav">
    <button class="nav-btn active" data-page="home">Home</button>
    <button class="nav-btn" data-page="markets">Markets</button>
    <button class="nav-btn" data-page="portfolio">Portfolio</button>
    <button class="nav-btn" data-page="events">Kalender</button>
    <button class="nav-btn" data-page="settings">Settings</button>
    <button id="navAdmin" class="nav-btn admin-only" data-page="admin">Admin</button>
  </footer>
</div>

<!-- modal root -->
<div id="modalRoot" style="display:none"></div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

<script>
/* ========== CONFIG ========== */
const firebaseConfig = {
  apiKey: "AIzaSyDVUEZ3ZVmH4ld7LVnEq_L368wEJpEs-l8",
  authDomain: "zeepaylater-93a94.firebaseapp.com",
  projectId: "zeepaylater-93a94",
  storageBucket: "zeepaylater-93a94.appspot.com",
  messagingSenderId: "358065954807",
  appId: "1:358065954807:web:66619211fea82a4b2518f2"
};
const ADMIN_UID = 'viCOsJo4wHVFmhtpmMx1Wd4sDF52';
/* ================================= */

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

/* -------------- device & balance -------------- */
let deviceId = localStorage.getItem('device_id');
if(!deviceId){ deviceId = 'dev-' + Math.floor(Math.random()*10000000); localStorage.setItem('device_id', deviceId); }
let balanceKey = 'balance_' + deviceId;
let balance = parseFloat(localStorage.getItem(balanceKey)) || 10000.0;
document.getElementById('bal').innerText = balance.toFixed(2);

/* -------------- app state -------------- */
let currentUser = null;
let selectedMarketId = null;      // only changed from Home -> View
let currentMarket = null;
let unsubscribeMarket = null;
let marketsCache = {};
let priceHistory = [];
let candles = [];
let timeframeMs = 1000;
let lastTickTime = 0;
let userTfOverride = false;

/* chart */
const canvas = document.getElementById('chartCanvas');
const ctx = canvas.getContext('2d');
let DPR = window.devicePixelRatio || 1;
function resizeCanvas(){ const r = canvas.getBoundingClientRect(); canvas.width = Math.floor(r.width*DPR); canvas.height = Math.floor(r.height*DPR); ctx.setTransform(DPR,0,0,DPR,0,0); }
window.addEventListener('resize', ()=>{ resizeCanvas(); draw(); });
resizeCanvas();

/* -------------- helpers -------------- */
function formatPrice(p){ return Number(p).toFixed(2); }
function clamp(v,a,b){ return Math.max(a,Math.min(b,v)); }
function tsToDate(ts){ if(!ts) return null; if(ts.toMillis) return new Date(ts.toMillis()); return new Date(ts); }

/* -------------- auth -------------- */
const provider = new firebase.auth.GoogleAuthProvider();
document.getElementById('btnSignIn').addEventListener('click', ()=> auth.signInWithPopup(provider).catch(e=>alert(e.message)));
document.getElementById('btnSignOut').addEventListener('click', ()=> auth.signOut());

auth.onAuthStateChanged(user=>{
  currentUser = user;
  if(user){
    document.getElementById('userInfo').innerText = user.email || user.uid;
    document.getElementById('btnSignIn').style.display = 'none';
    document.getElementById('btnSignOut').style.display = 'inline-block';
    // show admin-only UI
    if(user.uid === ADMIN_UID) {
      document.querySelectorAll('.admin-only').forEach(el=>el.style.display='block');
    } else {
      document.querySelectorAll('.admin-only').forEach(el=>el.style.display='none');
    }
  } else {
    document.getElementById('userInfo').innerText = 'not signed';
    document.getElementById('btnSignIn').style.display = 'inline-block';
    document.getElementById('btnSignOut').style.display = 'none';
    document.querySelectorAll('.admin-only').forEach(el=>el.style.display='none');
  }
});

/* -------------- SPA nav -------------- */
document.querySelectorAll('.nav-btn').forEach(b=>{
  b.addEventListener('click', ()=> {
    document.querySelectorAll('.nav-btn').forEach(x=>x.classList.remove('active'));
    b.classList.add('active');
    const page = b.dataset.page;
    showPage(page);
  });
});
function showPage(name){
  document.getElementById('page-home').style.display='none';
  document.getElementById('page-market').style.display='none';
  document.getElementById('page-portfolio').style.display='none';
  document.getElementById('page-events').style.display='none';
  if(name==='home') { document.getElementById('page-home').style.display='block'; }
  if(name==='markets') { document.getElementById('page-home').style.display='block'; }
  if(name==='portfolio') { document.getElementById('page-portfolio').style.display='block'; renderPositionsAndPnL(); }
  if(name==='events') { document.getElementById('page-events').style.display='block'; renderEventsAll(); }
}

/* bottom quick nav buttons */
document.getElementById('btnGotoMarket').addEventListener('click', ()=> {
  if(!selectedMarketId) return alert('Pilih market dari Home terlebih dulu.');
  // navigate to market page using already selectedMarketId
  openMarketView();
});
document.getElementById('btnGotoPortfolio').addEventListener('click', ()=> showPage('portfolio'));

/* -------------- Markets listing (Home) -------------- */
let unsubscribeMarketsList = null;
function subscribeMarketsListRealtime(){
  if(unsubscribeMarketsList) unsubscribeMarketsList();
  unsubscribeMarketsList = db.collection('markets').orderBy('createdAt','desc').onSnapshot(snap=>{
    const list = document.getElementById('marketList'); list.innerHTML='';
    marketsCache = {};
    snap.forEach(doc=>{
      const m = doc.data(); m.id = doc.id; marketsCache[m.id] = m;
      const el = document.createElement('div'); el.className='list-item';
      el.innerHTML = `<div><div style="font-weight:700">${m.name}</div><div class="small">${m.symbol||m.id} • ${m.description?m.description.slice(0,80):''}</div></div>
        <div style="text-align:right"><div style="font-weight:800">${formatPrice(m.price)}</div><div style="margin-top:8px"><button class="btn btn-ghost" data-id="${m.id}">View</button></div></div>`;
      el.querySelector('button').addEventListener('click', ()=> {
        // set selection and open market page
        selectedMarketId = m.id;
        document.getElementById('selectedSymbol').innerText = `${m.name}`;
        document.getElementById('selectedPrice').innerText = formatPrice(m.price);
        openMarketView();
      });
      list.appendChild(el);
    });
    renderAdminVolList();
    computeAndRenderPnL();
  });
}

/* -------------- Open Market View (only from Home selection) -------------- */
async function openMarketView(){
  if(!selectedMarketId) return alert('Pilih market dari Home terlebih dulu.');
  // ensure we load market and ticks, then show market page
  await selectMarket(selectedMarketId);
  showPage('markets'); // ensure nav active highlight handled externally if needed
  // show market page content
  document.getElementById('page-market').style.display = 'block';
}

/* -------------- select market (subscribe, load ticks) -------------- */
async function selectMarket(marketId){
  if(unsubscribeMarket) unsubscribeMarket();
  currentMarket = null;
  priceHistory = []; candles = []; lastTickTime = 0;
  selectedMarketId = marketId;
  // load persisted ticks first
  await loadTicksForMarket(marketId);
  // subscribe market doc realtime
  unsubscribeMarket = db.collection('markets').doc(marketId).onSnapshot(doc=>{
    if(!doc.exists) {
      // market removed
      document.getElementById('marketName').innerText = 'Market tidak ditemukan';
      document.getElementById('marketPrice').innerText = '—';
      document.getElementById('marketVolDisplay').innerText = 'Vol x—';
      // disable buy/sell
      setBuySellEnabled(false);
      return;
    }
    const m = doc.data(); currentMarket = {...m, id:doc.id};
    document.getElementById('marketName').innerText = m.name;
    document.getElementById('marketSymbol').innerText = m.symbol || doc.id;
    document.getElementById('marketPrice').innerText = formatPrice(m.price);
    document.getElementById('marketVolDisplay').innerText = 'Vol x' + (m.volatility||1);
    document.getElementById('selectedSymbol').innerText = m.name;
    document.getElementById('selectedPrice').innerText = formatPrice(m.price);
    // timeframe default override only if admin set it in market doc (but user can change)
    if(!userTfOverride){
      timeframeMs = m.timeframeMs || timeframeMs;
      document.getElementById('tfSelect').value = String(timeframeMs);
    }
    // if there's a newer market lastUpdate, push tick to history (persisted tick also exists)
    const stamp = (m.lastUpdate && m.lastUpdate.toMillis) ? m.lastUpdate.toMillis() : Date.now();
    if(stamp > lastTickTime - 1){
      priceHistory.push({t: stamp, price: m.price});
      lastTickTime = Math.max(lastTickTime, stamp);
      rebuildCandlesFromHistory();
    }
    // enable buy/sell now that market is loaded
    setBuySellEnabled(true);
    draw();
    computeAndRenderPnL(); // update unrealized values
  });
}

/* load persisted ticks */
async function loadTicksForMarket(mid){
  priceHistory = []; lastTickTime = 0;
  try {
    const snap = await db.collection('markets').doc(mid).collection('ticks').orderBy('ts','asc').limit(5000).get();
    snap.forEach(d=>{
      const data = d.data(); const t = (data.ts && data.ts.toMillis) ? data.ts.toMillis() : (data.t || Date.now());
      priceHistory.push({t, price: data.price}); lastTickTime = Math.max(lastTickTime, t);
    });
    rebuildCandlesFromHistory();
  } catch(e){ console.warn('loadTicks err', e); }
}

/* -------------- buy/sell handlers (operate only on currentMarket) -------------- */
function setBuySellEnabled(v){
  document.getElementById('btnBuy').disabled = !v;
  document.getElementById('btnSell').disabled = !v;
}

document.getElementById('btnBuy').addEventListener('click', async ()=>{
  if(!currentMarket) return alert('Market belum ter-load. Pilih market dari Home terlebih dulu.');
  const shares = Math.max(0, Math.floor(Number(document.getElementById('buyShares').value) || 0));
  if(isNaN(shares) || shares < 100) return alert('Minimal pembelian 100 lembar');
  const cost = shares * currentMarket.price;
  if(cost > balance) return alert('Saldo tidak cukup');
  // debit
  balance -= cost; localStorage.setItem(balanceKey, balance); document.getElementById('bal').innerText = balance.toFixed(2);
  // create position doc
  await db.collection('markets').doc(currentMarket.id).collection('positions').add({
    userUID: currentUser?currentUser.uid:'anon', deviceId, marketId: currentMarket.id, marketName: currentMarket.name,
    shares, avgPrice: currentMarket.price, status:'open', createdAt: firebase.firestore.FieldValue.serverTimestamp()
  });
  await db.collection('markets').doc(currentMarket.id).collection('trades').add({ type:'BUY', userUID: currentUser?currentUser.uid:'anon', deviceId, shares, price: currentMarket.price, ts: firebase.firestore.FieldValue.serverTimestamp() });
  alert(`Beli ${shares} lembar @ ${formatPrice(currentMarket.price)} berhasil`);
});

document.getElementById('btnSell').addEventListener('click', async ()=>{
  if(!currentMarket) return alert('Market belum ter-load. Pilih market dari Home terlebih dulu.');
  const sellShares = Math.max(0, Math.floor(Number(document.getElementById('buyShares').value) || 0));
  if(isNaN(sellShares) || sellShares < 100) return alert('Minimal jual 100 lembar');
  // collect positions for this device/user in this market
  const coll = db.collection('markets').doc(currentMarket.id).collection('positions');
  const snap = await coll.where('status','==','open').where('deviceId','==',deviceId).get();
  let available = 0; const docs = [];
  snap.forEach(d=>{ const p = d.data(); p._id = d.id; docs.push({ref:d.ref, data:p}); available += p.shares; });
  if(available < sellShares) return alert('Tidak cukup lembar untuk dijual (perangkat ini)');
  let remaining = sellShares; const batch = db.batch();
  for(const item of docs){
    if(remaining <= 0) break;
    const p = item.data; const take = Math.min(p.shares, remaining);
    const newShares = p.shares - take;
    const sellPrice = currentMarket.price;
    const pl = take * (sellPrice - p.avgPrice);
    if(newShares <= 0){
      batch.update(item.ref, { shares: 0, status: 'closed', closedAt: firebase.firestore.FieldValue.serverTimestamp(), closePrice: sellPrice, reason:'sell', pl: (p.pl||0)+pl });
    } else {
      batch.update(item.ref, { shares: newShares, pl: (p.pl||0)+pl });
    }
    remaining -= take;
    balance += take * sellPrice;
  }
  await batch.commit();
  localStorage.setItem(balanceKey, balance); document.getElementById('bal').innerText = balance.toFixed(2);
  await db.collection('markets').doc(currentMarket.id).collection('trades').add({ type:'SELL', userUID: currentUser?currentUser.uid:'anon', deviceId, shares: sellShares, price: currentMarket.price, ts: firebase.firestore.FieldValue.serverTimestamp() });
  alert(`Jual ${sellShares} lembar berhasil`);
});

/* -------------- Portfolio: subscribe positions (collectionGroup) & compute PnL -------------- */
let unsubPositionsGroup = null;
let positionsSnapshotCache = [];
function subscribePositionsGroup(){
  if(unsubPositionsGroup) unsubPositionsGroup();
  unsubPositionsGroup = db.collectionGroup('positions').onSnapshot(snap=>{
    positionsSnapshotCache = [];
    snap.forEach(d=>{
      const p = d.data(); p._path = d.ref.path; p._id = d.id;
      // keep only positions that belong to current user or device
      if(p.userUID === (currentUser?currentUser.uid:'anon') || p.deviceId === deviceId) positionsSnapshotCache.push(p);
    });
    renderPositionsAndPnL();
  });
}

/* render positions & trades in portfolio */
function renderPositionsAndPnL(){
  const open = positionsSnapshotCache.filter(p=>p.status === 'open');
  const closed = positionsSnapshotCache.filter(p=>p.status !== 'open');
  const posEl = document.getElementById('positionsList'); posEl.innerHTML = '';
  const tradesEl = document.getElementById('tradesList'); tradesEl.innerHTML = '';
  let totalUnreal = 0;
  open.forEach(p=>{
    const marketPrice = (marketsCache[p.marketId] && marketsCache[p.marketId].price) ? marketsCache[p.marketId].price : p.avgPrice;
    const unreal = p.shares * (marketPrice - p.avgPrice);
    totalUnreal += unreal;
    const item = document.createElement('div'); item.className='list-item';
    item.innerHTML = `<div><div style="font-weight:700">${p.shares} lembar • ${p.marketName || p.marketId}</div><div class="small muted">Avg ${formatPrice(p.avgPrice)} • Now ${formatPrice(marketPrice)} • ${unreal>=0?'<span style="color:var(--accent)">+'+unreal.toFixed(2)+'</span>':'<span style="color:var(--danger)">'+unreal.toFixed(2)+'</span>'}</div></div>
      <div style="text-align:right"><button class="btn btn-ghost" onclick="closePositionPath('${p._path}')">Jual</button></div>`;
    posEl.appendChild(item);
  });
  closed.slice(0,60).forEach(p=>{
    const item = document.createElement('div'); item.className='list-item';
    item.innerHTML = `<div><div style="font-weight:700">${p.shares} lembar • ${p.marketName||p.marketId}</div><div class="small muted">${p.reason||p.status} • P/L ${p.pl? p.pl.toFixed(2) : '0.00'}</div></div><div style="text-align:right">${p.closedAt?(new Date(p.closedAt.seconds*1000).toLocaleString()):''}</div>`;
    tradesEl.appendChild(item);
  });
  document.getElementById('totalPnl').innerText = (totalUnreal>=0?'+':'') + totalUnreal.toFixed(2);
}

/* close position by path */
window.closePositionPath = async (path)=> {
  const ref = db.doc(path); const doc = await ref.get(); if(!doc.exists) return alert('Position not found');
  const p = doc.data();
  if(p.deviceId !== deviceId && (!currentUser || p.userUID !== currentUser.uid)) return alert('Hanya pemilik posisi yang bisa menjual');
  const sellPrice = (marketsCache[p.marketId] && marketsCache[p.marketId].price) ? marketsCache[p.marketId].price : p.avgPrice;
  const pl = p.shares * (sellPrice - p.avgPrice);
  await ref.update({ status:'closed', closedAt: firebase.firestore.FieldValue.serverTimestamp(), closePrice: sellPrice, reason:'sell-manual', pl });
  if(p.deviceId === deviceId){ balance += p.shares * sellPrice; localStorage.setItem(balanceKey, balance); document.getElementById('bal').innerText = balance.toFixed(2); }
  alert('Position closed');
};

/* -------------- Events (read-only for normal users) -------------- */
let eventsCache = {};
async function loadEventsForMarket(mid){
  eventsCache[mid] = [];
  try{
    const snap = await db.collection('markets').doc(mid).collection('events').orderBy('startTs','asc').get();
    snap.forEach(d=>{ const ev = d.data(); ev.id = d.id; eventsCache[mid].push(ev); });
  }catch(e){ console.warn('load events err', e); }
}
function renderEventsAll(){
  const el = document.getElementById('eventsList'); el.innerHTML = '';
  let all = [];
  for(const mid in eventsCache) all = all.concat(eventsCache[mid].map(e=>({marketId:mid, ...e})));
  all.sort((a,b)=> ((a.startTs && a.startTs.toMillis? a.startTs.toMillis():a.startTs||0) - (b.startTs && b.startTs.toMillis? b.startTs.toMillis():b.startTs||0)));
  all.forEach(ev=>{
    const start = tsToDate(ev.startTs); const end = tsToDate(ev.endTs);
    const item = document.createElement('div'); item.className='list-item';
    item.innerHTML = `<div><div style="font-weight:700">${ev.title||'Event'}</div><div class="small muted">${ev.description||''}</div><div class="small muted">${ev.marketId} • ${start?start.toLocaleString():''} → ${end?end.toLocaleString():''}</div></div><div style="text-align:right"><div class="small">Vol x${ev.volMultiplier||1}</div></div>`;
    el.appendChild(item);
  });
}

/* -------------- Admin: volatility editor (immediate) -------------- */
function renderAdminVolList(){
  const container = document.getElementById('adminVolList'); if(!container) return; container.innerHTML='';
  for(const id in marketsCache){
    const m = marketsCache[id];
    const row = document.createElement('div');
    row.style.display='flex'; row.style.justifyContent='space-between'; row.style.alignItems='center'; row.style.padding='6px'; row.style.borderRadius='8px'; row.style.background='rgba(255,255,255,0.01)';
    row.innerHTML = `<div><div style="font-weight:700">${m.name}</div><div class="small">${m.symbol||m.id}</div></div>
      <div style="text-align:right"><input data-id="${id}" type="number" step="0.1" value="${m.volatility||1.0}" style="width:90px"/><div style="margin-top:6px"><button class="btn btn-ghost" data-save="${id}">Simpan</button></div></div>`;
    container.appendChild(row);
    row.querySelector('button[data-save]').addEventListener('click', async ()=>{
      const id = row.querySelector('input[data-id]').dataset.id;
      const v = parseFloat(row.querySelector('input[data-id]').value) || 1.0;
      await db.collection('markets').doc(id).update({ volatility: v, lastUpdate: firebase.firestore.FieldValue.serverTimestamp() });
      alert('Volatility disimpan dan langsung berlaku untuk market ' + id);
    });
  }
}

/* -------------- Chart candles aggregation & draw -------------- */
let userTfOverride = false;
document.getElementById('tfSelect').addEventListener('change', ()=>{
  userTfOverride = true;
  timeframeMs = parseInt(document.getElementById('tfSelect').value);
  rebuildCandlesFromHistory(); draw();
});

function rebuildCandlesFromHistory(){
  candles = [];
  if(!priceHistory.length) return;
  const tf = timeframeMs || 1000;
  let bucket = null;
  for(let i=0;i<priceHistory.length;i++){
    const pt = priceHistory[i];
    const bucketStart = Math.floor(pt.t / tf) * tf;
    if(!bucket || bucket.t !== bucketStart){
      if(bucket) candles.push(bucket);
      bucket = { t: bucketStart, o: pt.price, h: pt.price, l: pt.price, c: pt.price };
    } else {
      bucket.c = pt.price;
      if(pt.price > bucket.h) bucket.h = pt.price;
      if(pt.price < bucket.l) bucket.l = pt.price;
    }
  }
  if(bucket) candles.push(bucket);
  if(candles.length > 5000) candles = candles.slice(-5000);
}

function getVisibleSlice(slotCount){
  const len = candles.length;
  if(len === 0) return [];
  const end = len;
  const start = Math.max(0, end - slotCount);
  return candles.slice(start, end);
}

function draw(){
  const W = canvas.width / DPR; const H = canvas.height / DPR;
  ctx.clearRect(0,0,W,H); if(!currentMarket){ ctx.fillStyle='#9fb0d6'; ctx.font='14px Arial'; ctx.fillText('Pilih market dari Home untuk melihat chart',20,30); return; }
  let desired = Math.max(30, Math.floor((W - 40 - 90) / 8));
  const usableW = Math.max(60, W - 40 - 90);
  let cw = usableW / desired * 0.72; cw = Math.max(3, Math.min(18, cw));
  const totalWidth = cw * desired; let gap = (usableW - totalWidth) / Math.max(1, desired - 1); if(gap < 1) gap = 1;
  const arr = getVisibleSlice(desired); const arrLen = arr.length;
  const slotsTotal = (cw*desired) + ((desired - 1)*gap); const slotsLeft = 40 + Math.max(0, usableW - slotsTotal);
  const empty = desired - arrLen; const startX = slotsLeft + empty * (cw + gap);
  let maxP=-Infinity, minP=Infinity;
  if(arrLen === 0){ maxP = minP = currentMarket.price || 1; } else { for(let i=0;i<arrLen;i++){ const c=arr[i]; if(c.h>maxP) maxP=c.h; if(c.l<minP) minP=c.l; } }
  const pad = (maxP-minP)*0.12 || 0.5; maxP+=pad; minP-=pad;
  function py(p){ if(maxP===minP) return H/2; return ((maxP-p)/(maxP-minP))*(H-40)+20; }
  // grid
  ctx.strokeStyle='rgba(255,255,255,0.03)'; ctx.lineWidth=1; ctx.beginPath();
  for(let i=0;i<5;i++){ const y=20 + i*(H-40)/4; ctx.moveTo(40,y); ctx.lineTo(W-10,y); } ctx.stroke();
  // candles
  let x = startX;
  for(let i=0;i<arrLen;i++){
    const c = arr[i]; const up = c.c >= c.o;
    const colorUp = '#5de3a6', colorDn = '#ff7373';
    const yO = py(c.o), yC = py(c.c), yH = py(c.h), yL = py(c.l);
    ctx.strokeStyle = up ? colorUp : colorDn; ctx.lineWidth=1; ctx.beginPath(); ctx.moveTo(x + cw/2, yH); ctx.lineTo(x + cw/2, yL); ctx.stroke();
    const top = Math.min(yO,yC), h = Math.max(1, Math.abs(yC-yO));
    ctx.fillStyle = up ? colorUp : colorDn; ctx.fillRect(x, top, cw, h);
    x += cw + gap;
  }
  // axis
  ctx.fillStyle='rgba(255,255,255,0.06)'; ctx.fillRect(W-90+10,10,90-20,H-20);
  ctx.fillStyle='#bcd7ff'; ctx.font='12px Arial'; ctx.textAlign='right';
  for(let i=0;i<5;i++){ const v = minP + ((5-i-1)/4)*(maxP-minP); const y = 20 + i*(H-40)/4; ctx.fillText(Number(v).toFixed(2), W-14, y+4); }
  // last price line
  ctx.strokeStyle='rgba(255,255,255,0.12)'; ctx.beginPath(); const yNow = py(currentMarket.price); ctx.moveTo(40,yNow); ctx.lineTo(W-10,yNow); ctx.stroke();
  ctx.fillStyle='#fff'; ctx.font='12px Arial'; ctx.textAlign='right'; ctx.fillText(formatPrice(currentMarket.price), W-14, yNow-6);
  document.getElementById('visibleCount').innerText = `${arrLen}/${desired}`;
}

/* -------------- Engine (admin) - all markets -------------- */
let engineAllInterval = null;
let engineAllRunning = false;
document.getElementById('btnEngineAll').addEventListener('click', ()=>{
  if(!currentUser || currentUser.uid !== ADMIN_UID) return alert('Only admin');
  engineAllRunning = !engineAllRunning;
  document.getElementById('btnEngineAll').innerText = engineAllRunning ? 'Stop Engine (All)' : 'Start Engine (All)';
  if(engineAllRunning) startEngineAllMarkets(); else stopEngineAllMarkets();
});
function stopEngineAllMarkets(){ if(engineAllInterval) clearInterval(engineAllInterval); engineAllInterval=null; engineAllRunning=false; }
function startEngineAllMarkets(){
  if(engineAllInterval) return;
  const TICK_MS = 800;
  engineAllInterval = setInterval(async ()=>{
    try{
      const snap = await db.collection('markets').get();
      const now = firebase.firestore.Timestamp.now();
      for(const doc of snap.docs){
        const mid = doc.id; const m = doc.data();
        try{
          let baseVol = (m.volatility !== undefined) ? m.volatility : 1.0;
          // check events active for this market
          let effMultiplier = 1.0;
          try{
            const evSnap = await db.collection('markets').doc(mid).collection('events').where('startTs','<=',now).where('endTs','>=',now).get();
            evSnap.forEach(ed=>{ const e = ed.data(); if(e.volMultiplier && e.volMultiplier > effMultiplier) effMultiplier = e.volMultiplier; });
          }catch(e){}
          const vol = baseVol * effMultiplier;
          const last = m.price || 1.0;
          const rnd = (Math.random()-0.5)*2;
          const spike = (Math.random()<0.02)? (Math.random()-0.5)*0.05*vol : 0;
          const step = rnd * 0.0005 * vol + spike + (1.0 - last) * 0.0001;
          const newP = Math.max(0.01, parseFloat((last + step).toFixed(2)));
          await doc.ref.update({ price: newP, lastUpdate: firebase.firestore.FieldValue.serverTimestamp() });
          // persist tick
          await doc.ref.collection('ticks').add({ price: newP, ts: firebase.firestore.FieldValue.serverTimestamp() }).catch(()=>{});
        }catch(e){ console.warn('engine per-market err', e); }
      }
    }catch(e){ console.warn('engine all err', e); }
  }, TICK_MS);
}

/* -------------- Admin: create/edit market -------------- */
document.getElementById('btnCreateMarket').addEventListener('click', async ()=>{
  if(!currentUser || currentUser.uid !== ADMIN_UID) return alert('Only admin');
  const name = prompt('Nama perusahaan (contoh: Holez)');
  if(!name) return;
  const symbol = prompt('Symbol (contoh: HOLEZ/IDR)','HOLEZ/IDR');
  const price = parseFloat(prompt('Harga awal per lembar','1000')) || 1000;
  const vol = parseFloat(prompt('Volatility (1.0 default)','1.0')) || 1.0;
  const desc = prompt('Deskripsi singkat','Perusahaan contoh');
  await db.collection('markets').add({ name, symbol, price: parseFloat(price.toFixed(2)), volatility: vol, description: desc || '', createdAt: firebase.firestore.FieldValue.serverTimestamp(), lastUpdate: firebase.firestore.FieldValue.serverTimestamp() });
  alert('Market dibuat');
});
document.getElementById('btnEditMarket').addEventListener('click', async ()=>{
  if(!currentUser || currentUser.uid !== ADMIN_UID) return alert('Only admin');
  if(!selectedMarketId) return alert('Pilih market dari Home terlebih dulu');
  const ref = db.collection('markets').doc(selectedMarketId);
  const doc = await ref.get(); if(!doc.exists) return alert('Market tidak ditemukan');
  const m = doc.data();
  const name = prompt('Nama', m.name) || m.name;
  const symbol = prompt('Symbol', m.symbol) || m.symbol;
  const price = parseFloat(prompt('Price', String(m.price))) || m.price;
  const vol = parseFloat(prompt('Volatility', String(m.volatility || 1))) || m.volatility;
  const desc = prompt('Deskripsi', m.description || '') || m.description;
  await ref.update({ name, symbol, price: parseFloat(price.toFixed(2)), volatility: vol, description: desc, lastUpdate: firebase.firestore.FieldValue.serverTimestamp() });
  alert('Market updated — volatility langsung berlaku');
});

/* -------------- utility & boot -------------- */
async function ensureDefaultMarket(){
  const id='holez-idr'; const ref=db.collection('markets').doc(id); const doc=await ref.get();
  if(!doc.exists){
    await ref.set({ name:'HOLEZ (Demo)', symbol:'HOLEZ/IDR', price:1000.00, volatility:1.0, description:'Perusahaan demo HOLEZ', createdAt: firebase.firestore.FieldValue.serverTimestamp(), lastUpdate: firebase.firestore.FieldValue.serverTimestamp() });
  }
}
async function boot(){
  await ensureDefaultMarket();
  subscribeMarketsListRealtime();
  subscribePositionsGroup();
  // load events for all markets once
  const ms = await db.collection('markets').get();
  for(const d of ms.docs){ await loadEventsForMarket(d.id); }
  // pick first market as selected by default (not auto-open)
  if(ms.docs[0]) {
    selectedMarketId = ms.docs[0].id;
    document.getElementById('selectedSymbol').innerText = ms.docs[0].data().name;
    document.getElementById('selectedPrice').innerText = formatPrice(ms.docs[0].data().price);
  }
  // periodic refresh of events/markets
  setInterval(async ()=> {
    try { for(const id in marketsCache) await loadEventsForMarket(id); } catch(e) {}
  }, 60000);
  setInterval(()=>{ draw(); updateRightHistoryUI(); renderAdminVolList(); }, 800);
}
boot();

/* right history quick */
function updateRightHistoryUI(){
  db.collectionGroup('trades').where('deviceId','==',deviceId).orderBy('ts','desc').limit(10).get().then(snap=>{
    const el = document.getElementById('rightHistory'); el.innerHTML='';
    snap.forEach(d=>{
      const t = d.data(); const time = t.ts && t.ts.toDate ? t.ts.toDate().toLocaleString() : '';
      const item = document.createElement('div'); item.className='list-item'; item.innerHTML = `<div><div style="font-weight:700">${t.type} ${t.shares}</div><div class="small muted">${formatPrice(t.price)} • ${time}</div></div>`; el.appendChild(item);
    });
  }).catch(()=>{});
}

/* when marketsCache updated compute PnL */
function computeAndRenderPnL(){ renderPositionsAndPnL(); }

/* redraw on resize / ticks */
window.addEventListener('visibilitychange', ()=>{ draw(); });

</script>
</body>
</html>
