<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Zestore Rewards & Referral</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    *{box-sizing:border-box;margin:0;padding:0;}
    body{
      font-family:Arial,sans-serif;
      background:#0f0f2d;color:#fff;
      display:flex;justify-content:center;
      padding:20px;
    }
    .container{
      width:100%;max-width:400px;
      background:#1e1e40;border-radius:12px;
      padding:20px;box-shadow:0 4px 12px rgba(0,0,0,0.5);
      position:relative;
    }
    h2,h3,h4{text-align:center;margin-bottom:12px;}
    .box-card{text-align:center;margin-bottom:20px;}
    #dailyBox{width:120px;cursor:pointer;}
    @keyframes shake{
      0%,100%{transform:translateX(0);}
      20%,60%{transform:translateX(-6px);}
      40%,80%{transform:translateX(6px);}
    }
    .shake{animation:shake 0.8s infinite;}
    #dailyStatus{margin-top:8px;font-size:0.95rem;}
    .ref-card{text-align:center;margin-bottom:20px;}
    .ref-card input{
      width:100%;padding:8px;margin-bottom:8px;
      border:none;border-radius:6px;font-size:0.95rem;
    }
    .ref-card button{
      width:100%;padding:10px;
      border:none;border-radius:6px;
      background:#4c8bf5;font-size:1rem;cursor:pointer;
      transition:background .3s;
    }
    .ref-card button:hover{background:#3a6ed1;}
    #referralStatus{margin-top:6px;font-size:0.9rem;}
    .history{
      background:#2d2d50;padding:12px;
      border-radius:8px;margin-bottom:20px;
      font-size:0.9rem;
    }
    .history ul{list-style:none;}
    .history li{padding:4px 0;border-bottom:1px solid #444;}
    .redeem{
      background:#2d2d50;padding:12px;
      border-radius:8px;margin-bottom:20px;
      text-align:center;
    }
    .coin-balance{
      text-align:center;font-size:1.1rem;
      color:#ffd700;margin-bottom:8px;
      display:flex;align-items:center;justify-content:center;
      gap:5px;
    }
    .coin-balance button{
      background:#4c8bf5;border:none;border-radius:50%;
      width:24px;height:24px;color:#fff;font-weight:bold;
      cursor:pointer;transition:background .3s;
    }
    .coin-balance button:hover{background:#3a6ed1;}
    .redeem-grid{
      display:flex;flex-wrap:wrap;gap:10px;
      justify-content:center;
    }
    .redeem-item{
      width:45%;text-align:center;cursor:pointer;
      transition:opacity .3s;
    }
    .redeem-item.disabled{opacity:0.5;cursor:not-allowed;}
    .redeem-item img{width:100%;border-radius:6px;}
    .redeem-item p{margin-top:4px;font-size:0.9rem;}
    .user-info{
      background:#2d2d50;padding:12px;
      border-radius:8px;font-size:0.9rem;
      word-break:break-all;display:none;
    }
    .user-info b{color:#4c8bf5;}

    /* Pop-up Tugas */
    .popup{
      position:fixed;top:0;left:0;width:100%;height:100%;
      background:rgba(0,0,0,0.7);
      display:none;align-items:center;justify-content:center;
      z-index:1000;
    }
    .popup-content{
      background:#1e1e40;padding:20px;border-radius:12px;
      max-width:350px;width:90%;
      text-align:center;
    }
    .popup-content h3{margin-bottom:10px;}
    .task{
      background:#2d2d50;padding:8px;margin:8px 0;
      border-radius:8px;font-size:0.9rem;
      text-align:left;
    }
    .task button{
      margin-top:6px;width:100%;
      background:#4c8bf5;border:none;border-radius:6px;
      padding:6px;color:#fff;cursor:pointer;
    }
    .task input{
      width:100%;padding:5px;margin-top:4px;
      border-radius:6px;border:none;
    }
    .close-popup{
      margin-top:10px;
      background:#f54242;border:none;border-radius:6px;
      padding:6px 12px;color:#fff;cursor:pointer;
    }
  </style>
</head>
<body>
  <div class="container">

    <!-- Reward Harian -->
    <div class="box-card">
      <h2>Reward Harian</h2>
      <img id="dailyBox" class="shake"
           src="https://cdn-icons-png.flaticon.com/512/862/862856.png"
           alt="Kotak Reward">
      <p id="dailyStatus">Klik kotak untuk klaim!</p>
    </div>

    <!-- Referral Teman -->
    <div class="ref-card">
      <h3>Referral Teman</h3>
      <input type="text" id="referralCode" placeholder="Masukkan kode referral">
      <button id="submitReferral">Gunakan Kode</button>
      <p id="referralStatus"></p>
    </div>

    <!-- Histori Klaim -->
    <div class="history">
      <h4>7 Hari Terakhir</h4>
      <ul id="claimHistory"></ul>
    </div>

    <!-- Redeem Koin dengan gambar -->
    <div class="redeem">
      <div class="coin-balance">
        Saldo Koin: <span id="coinBalance">0</span>
        <button id="showTasks">+</button>
      </div>
      <div class="redeem-grid" id="redeemGrid"></div>
      <p id="redeemStatus" style="text-align:center;margin-top:8px;"></p>
    </div>

    <!-- Info Akun User -->
    <div class="user-info" id="user-info">
      <p><b>UID:</b> <span id="user-uid"></span></p>
      <p><b>Email:</b> <span id="user-email"></span></p>
      <p><b>Kode Referral:</b> <span id="user-ref-code"></span></p>
    </div>

  </div>

  <!-- POPUP -->
  <div class="popup" id="taskPopup">
    <div class="popup-content">
      <h3>Tugas Tambahan</h3>
      <div class="task">
        <b>1. Bagikan ke Sosial Media (5x)</b>
        <button id="shareTaskBtn">Bagikan</button>
        <p id="shareStatus"></p>
      </div>
      <div class="task">
        <b>2. Undang 3 Teman & Redeem</b>
        <button id="inviteTaskBtn">Cek Progres</button>
        <p id="inviteStatus"></p>
      </div>
      <div class="task">
        <b>3. Masukkan Kode Rahasia</b>
        <input type="text" id="secretCodeInput" placeholder="Kode rahasia">
        <button id="secretCodeBtn">Klaim Bonus</button>
        <p id="secretStatus"></p>
      </div>
      <button class="close-popup" id="closePopup">Tutup</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
    import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
    import {
      getFirestore, doc, collection, getDoc, getDocs,
      setDoc, updateDoc, serverTimestamp,
      query, orderBy, limit
    } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

    // Firebase config
    const cfg = {
      apiKey: "AIzaSyDVUEZ3ZVmH4ld7LVnEq_L368wEJpEs-l8",
      authDomain: "zeepaylater-93a94.firebaseapp.com",
      projectId: "zeepaylater-93a94",
      storageBucket: "zeepaylater-93a94.appspot.com",
      messagingSenderId: "358065954807",
      appId: "1:358065954807:web:66619211fea82a4b2518f2"
    };
    const app  = initializeApp(cfg);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    // Rewards
    const DAILY_REWARDS = [10,15,20,25,30,35,50];
    const REDEEM_ITEMS = [
      { cost:50,label:'Voucher Rp5.000',img:'https://i.ibb.co/0jqHpnp/voucher5k.png' },
      { cost:100,label:'Voucher Rp12.000',img:'https://i.ibb.co/XC4yvPf/voucher12k.png' }
    ];

    // Elemen
    const boxImg = document.getElementById("dailyBox");
    const dailyStatus = document.getElementById("dailyStatus");
    const referralBtn = document.getElementById("submitReferral");
    const referralInput = document.getElementById("referralCode");
    const referralStatus = document.getElementById("referralStatus");
    const historyList = document.getElementById("claimHistory");
    const coinBalanceEl = document.getElementById("coinBalance");
    const redeemGrid = document.getElementById("redeemGrid");
    const redeemStatus = document.getElementById("redeemStatus");
    const userInfoDiv = document.getElementById("user-info");
    const userUidEl = document.getElementById("user-uid");
    const userEmailEl = document.getElementById("user-email");
    const userRefCodeEl = document.getElementById("user-ref-code");
    const showTasksBtn = document.getElementById("showTasks");
    const popup = document.getElementById("taskPopup");
    const closePopup = document.getElementById("closePopup");
    const shareBtn = document.getElementById("shareTaskBtn");
    const shareStatus = document.getElementById("shareStatus");
    const inviteBtn = document.getElementById("inviteTaskBtn");
    const inviteStatus = document.getElementById("inviteStatus");
    const secretBtn = document.getElementById("secretCodeBtn");
    const secretInput = document.getElementById("secretCodeInput");
    const secretStatus = document.getElementById("secretStatus");

    let currentUserRef, myCode, userData;

    onAuthStateChanged(auth, async user => {
      if(!user) return window.location.href='/register-login';
      const uid = user.uid;
      currentUserRef = doc(db,"users",uid);
      myCode = uid.substring(0,6);

      // Referral doc
      const refDoc = doc(db,"referralCodes",myCode);
      if(!(await getDoc(refDoc)).exists()){
        await setDoc(refDoc,{owner:uid,count:0});
      }

      // User doc init
      let snap = await getDoc(currentUserRef);
      if(!snap.exists()){
        await setDoc(currentUserRef,{
          createdAt:serverTimestamp(),
          lastLogin:null,
          streak:0,
          coinBalance:0,
          referralUsed:false,
          referrer:"",
          shareCount:0,
          lastSecretDate:null
        });
        snap = await getDoc(currentUserRef);
      }
      userData = snap.data();
      renderUI(user, userData);
    });

    function renderUI(user, data){
      const {coinBalance,streak,lastLogin} = data;
      // Info akun
      userUidEl.textContent = user.uid;
      userEmailEl.textContent = user.email||'-';
      userRefCodeEl.textContent = myCode;
      userInfoDiv.style.display='block';

      // Reward
      const today = new Date().toISOString().split('T')[0];
      const lastDate = data.lastLogin?.toDate?.().toISOString().split('T')[0];
      const claimedToday = lastDate===today;
      if(claimedToday){
        boxImg.src='https://cdn-icons-png.flaticon.com/512/4315/4315609.png';
        boxImg.classList.remove('shake');
        dailyStatus.textContent=`+${DAILY_REWARDS[streak-1]||DAILY_REWARDS[0]} koin (hari ke-${streak})`;
      }else{
        boxImg.src='https://cdn-icons-png.flaticon.com/512/862/862856.png';
        boxImg.classList.add('shake');
        dailyStatus.textContent='Klik kotak untuk klaim!';
      }

      // History
      historyList.innerHTML='';
      getDocs(query(collection(db,"users",user.uid,"claims"),orderBy("timestamp","desc"),limit(7))).then(snaps=>{
        snaps.forEach(d=>{
          const dt = d.data().timestamp.toDate().toLocaleDateString('id');
          historyList.innerHTML+=`<li>${dt} → +${d.data().coins} koin</li>`;
        });
      });

      // Coin
      coinBalanceEl.textContent = coinBalance||0;
      redeemGrid.innerHTML='';
      REDEEM_ITEMS.forEach(item=>{
        const ok=(coinBalance||0)>=item.cost;
        const div=document.createElement('div');
        div.className='redeem-item'+(ok?'':' disabled');
        div.innerHTML=`<img src="${item.img}" alt=""><p>${item.label} (${item.cost} koin)</p>`;
        if(ok){
          div.onclick=async()=>{
            await updateDoc(currentUserRef,{coinBalance:(coinBalance||0)-item.cost});
            redeemStatus.textContent=`Berhasil tukar ${item.label}!`;
            location.reload();
          };
        }
        redeemGrid.appendChild(div);
      });
    }

    // Kotak reward
    boxImg.onclick=async()=>{
      const snap = await getDoc(currentUserRef);
      const d = snap.data();
      const today = new Date().toISOString().split('T')[0];
      const lastDate = d.lastLogin?.toDate?.().toISOString().split('T')[0];
      if(lastDate===today) return;
      const y=new Date();y.setDate(y.getDate()-1);
      const isY = lastDate===y.toISOString().split('T')[0];
      const newSt = isY?d.streak+1:1;
      const rew=DAILY_REWARDS[newSt-1]||DAILY_REWARDS[0];
      await updateDoc(currentUserRef,{
        lastLogin:serverTimestamp(),
        streak:newSt,
        coinBalance:(d.coinBalance||0)+rew
      });
      await setDoc(doc(collection(db,"users",auth.currentUser.uid,"claims")),{timestamp:serverTimestamp(),coins:rew});
      location.reload();
    };

    // Referral
    referralBtn.onclick=async()=>{
      const code=referralInput.value.trim();
      if(!code||code===myCode){referralStatus.textContent='Kode tidak valid.';return;}
      const snap=await getDoc(currentUserRef);
      if(snap.data().referralUsed){referralStatus.textContent='Sudah pakai referral.';return;}
      const rd=doc(db,"referralCodes",code);
      const rSnap=await getDoc(rd);
      if(!rSnap.exists()){referralStatus.textContent='Kode tdk ditemukan.';return;}
      await updateDoc(currentUserRef,{referralUsed:true,referrer:code,coinBalance:(snap.data().coinBalance||0)+5});
      await updateDoc(rd,{count:(rSnap.data().count||0)+1});
      referralStatus.textContent='Referral berhasil! (+5 koin)';
    };

    // Pop-up Tasks
    showTasksBtn.onclick=()=>popup.style.display='flex';
    closePopup.onclick=()=>popup.style.display='none';

    // Bagikan
    shareBtn.onclick=async()=>{
      const snap=await getDoc(currentUserRef);
      const count=snap.data().shareCount||0;
      const newCount=count+1;
      await updateDoc(currentUserRef,{shareCount:newCount});
      if(newCount>=5){
        await updateDoc(currentUserRef,{coinBalance:(snap.data().coinBalance||0)+10,shareCount:0});
        shareStatus.textContent='Kamu dapat +10 koin!';
      } else {
        shareStatus.textContent=`Berhasil dibagikan (${newCount}/5)`;
      }
      window.open('https://zestore.netlify.app/home','_blank');
    };

    // Invite Check
    inviteBtn.onclick=async()=>{
      const refDoc = await getDoc(doc(db,"referralCodes",myCode));
      const count = refDoc.data().count||0;
      if(count>=3){
        await updateDoc(currentUserRef,{coinBalance:(userData.coinBalance||0)+30});
        inviteStatus.textContent='Selamat! +30 koin';
      } else {
        inviteStatus.textContent=`Progres undangan: ${count}/3`;
      }
    };

    // Secret Code
    secretBtn.onclick=async()=>{
      const code=secretInput.value.trim();
      if(!code){secretStatus.textContent='Masukkan kode';return;}
      const snap=await getDoc(currentUserRef);
      const d=snap.data();
      const today=new Date().toISOString().split('T')[0];
      const lastSecret=d.lastSecretDate?.toDate?.().toISOString().split('T')[0];
      if(lastSecret===today){secretStatus.textContent='Sudah klaim hari ini';return;}
      // validasi kode rahasia (contoh: "ZESPECIAL")
      if(code.toUpperCase()==="ZESPECIAL"){
        await updateDoc(currentUserRef,{
          coinBalance:(d.coinBalance||0)+50,
          lastSecretDate:serverTimestamp()
        });
        secretStatus.textContent='Kode berhasil! +50 koin';
      }else{
        secretStatus.textContent='Kode salah';
      }
    };
  </script>
</body>
</html>
