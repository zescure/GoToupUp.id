<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Deposit & Withdraw — razorbil trade</title>
<style>
  :root{
    --bg:#07121a; --card:#0b1722; --muted:#98a0ad; --accent:#2dd4bf;
  }
  html,body{height:100%;margin:0;background:linear-gradient(180deg,#07101a,#081627);color:#e6eef6;font-family:Inter,system-ui,Roboto,Arial}
  .wrap{max-width:1200px;margin:12px auto;padding:12px;box-sizing:border-box}
  header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;gap:12px;flex-wrap:wrap}
  h1{margin:0;font-size:18px}
  .container{display:grid;grid-template-columns:1fr 380px;gap:14px}
  .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:12px;padding:12px;box-shadow:0 10px 30px rgba(0,0,0,0.6)}
  .actions{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:10px}
  .btn{background:var(--accent);border:none;color:#012;padding:10px 14px;border-radius:10px;font-weight:800;cursor:pointer}
  .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.05);color:var(--muted);font-weight:700}
  label{display:block;color:var(--muted);font-size:13px;margin-top:8px}
  input,select,textarea{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit;margin-top:6px;box-sizing:border-box}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .small{font-size:13px;color:var(--muted)}
  .q-area{display:flex;gap:12px;align-items:flex-start;flex-wrap:wrap;margin-top:12px}
  .qr-box{background:#fff;padding:12px;border-radius:8px;display:flex;align-items:center;justify-content:center}
  .payload{background:#07121a;border:1px solid rgba(255,255,255,0.03);padding:8px;border-radius:8px;color:var(--muted);font-size:12px;word-break:break-all}
  .history{max-height:420px;overflow:auto;margin-top:10px}
  .hist-item{display:flex;justify-content:space-between;padding:8px;border-bottom:1px solid rgba(255,255,255,0.02);font-size:13px;gap:10px}
  .hist-left{flex:1}
  .hist-right{min-width:160px;text-align:right}
  .badge{padding:6px 8px;border-radius:8px;font-weight:700;font-size:12px}
  .badge.pending{background:rgba(255,193,7,0.08);color:#ffb020}
  .badge.confirmed{background:rgba(34,197,94,0.08);color:#22c55e}
  .badge.rejected{background:rgba(239,68,68,0.06);color:#fb7185}
  .muted-label{font-size:13px;color:var(--muted)}
  .admin-panel{margin-top:12px}
  .admin-list{max-height:340px;overflow:auto;margin-top:8px;border-top:1px solid rgba(255,255,255,0.03)}
  .admin-item{padding:8px;border-bottom:1px solid rgba(255,255,255,0.02);display:flex;justify-content:space-between;gap:10px}
  @media (max-width:1000px){
    .container{grid-template-columns:1fr; padding:0}
    aside{order:2}
    main{order:1}
  }
  @media (max-width:420px){
    .hist-right{min-width:120px;font-size:12px}
    .card{padding:10px}
    .btn{padding:8px 10px}
  }
</style>
</head>
<body>
  <div class="wrap">
  <header>
    <div>
      <h1>Deposit & Penarikan — RAZORBIL TRADE</h1>
      <div class="small">Semua Penarikan diproses <code>Kilat</code> 3 menit selesai</div>
    </div>
    <div class="small" id="uidInfo">ID Akun: —</div>
  </header>

  <div class="container">
    <main>
      <div class="card">
        <div class="actions">
          <button id="btnShowDeposit" class="btn">Deposit</button>
          <button id="btnShowWithdraw" class="btn ghost">Penarikan</button>
          <div style="flex:1"></div>
          <div class="small" id="accountBalance">Saldo: Rp 0</div>
        </div>

        <!-- Deposit -->
        <div id="depositPanel">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><strong>Deposit (QRIS)</strong></div>
            <div class="small">Minimal Rp 10.000 •</div>
          </div>
          <label for="nominal">Nominal (Rp)</label>
          <input id="nominal" type="number" min="10000" step="100" value="0" />
          <div class="row" style="margin-top:10px">
            <button id="generateBtn" class="btn">Top Up Saldo</button>
            <button id="saveRequestBtn" class="btn ghost">Selesaikan Pembayaran</button>
          </div>
          <div id="breakdown" class="small" style="margin-top:10px"></div>

          <div id="qArea" class="q-area" style="display:none">
            <div id="qWrap" class="qr-box" style="width:260px;height:260px"></div>
            <div style="flex:1">
              <div class="small">Payload QRIS Anda</div>
              <pre id="finalPayload" class="payload">—</pre>
              <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap">
                <button id="copyPayload" class="btn ghost">Copy Payload</button>
                <button id="downloadQR" class="btn ghost">Download QR</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Withdraw -->
        <div id="withdrawPanel" style="display:none">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><strong>Permintaan Penarikan</strong></div>
            <div class="small">Minimal Rp 350.000</div>
          </div>
          <label for="withdrawAmount">Nominal (Rp)</label>
          <input id="withdrawAmount" type="number" min="350000" step="1000" value="0">
          <label for="bankName">Nama Bank</label>
          <input id="bankName" type="text" placeholder="BCA / BNI / Mandiri / Dana / Gopay / Dll">
          <label for="bankAccount">No. Rekening</label>
          <input id="bankAccount" type="text" placeholder="1234567890">
          <label for="bankHolder">Atas Nama</label>
          <input id="bankHolder" type="text" placeholder="Nama pemilik rekening">
          <div style="display:flex;gap:8px;margin-top:10px">
            <button id="submitWithdraw" class="btn">Ajukan Penarikan</button>
            <button id="cancelWithdraw" class="btn ghost">Batal</button>
          </div>
        </div>

        <!-- Unified History -->
        <div style="margin-top:14px;display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:800">Riwayat Transaksi</div>
          <div class="small">Semua deposit & penarikan akun ini</div>
        </div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="tabAll" class="btn">Semua</button>
          <button id="tabDeposit" class="btn ghost">Deposit</button>
          <button id="tabWithdraw" class="btn ghost">Penarikan</button>
        </div>

        <div id="historyAll" class="history" style="margin-top:10px"></div>
        <div id="historyOnlyDeposit" class="history" style="display:none;margin-top:10px"></div>
        <div id="historyOnlyWithdraw" class="history" style="display:none;margin-top:10px"></div>

      </div>
    </main>

    <aside>
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:800">Informasi Akun</div>
          <div class="small" id="createdAt">—</div>
        </div>

        <div style="margin-top:10px">
          <div class="info-row"><div class="muted-label">UID</div><div id="uid" class="muted-label">—</div></div>
          <div class="info-row"><div class="muted-label">Email</div><div id="email" class="muted-label">—</div></div>
          <div class="info-row"><div class="muted-label">Nama</div><div id="fullname" class="muted-label">—</div></div>
          <div class="info-row"><div class="muted-label">Telepon</div><div id="phone" class="muted-label">—</div></div>
          <div class="info-row" style="margin-top:8px"><div class="muted-label">Saldo</div><div id="bal" style="font-weight:800">Rp 0</div></div>
        </div>

        <div style="display:flex;gap:8px;margin-top:12px">
          <button id="refreshBtn" class="btn ghost">Refresh</button>
          <button id="signoutBtn" class="btn ghost">Sign out</button>
        </div>

        <!-- Admin panel -->
        <div id="adminPanel" class="admin-panel" style="display:none">
          <div style="font-weight:800;margin-top:12px">Admin — Semua Request</div>
          <div class="small" style="margin-top:6px">Lihat semua request (deposit & withdraw). Proses Approve/Reject langsung.</div>
          <label style="margin-top:8px">Filter UID (opsional)</label>
          <input id="adminUidFilter" placeholder="Masukkan UID user untuk filter (opsional)" />
          <div style="display:flex;gap:8px;margin-top:8px">
            <button id="adminRefresh" class="btn ghost">Refresh</button>
            <button id="exportCsv" class="btn ghost">Export CSV</button>
          </div>
          <div id="adminList" class="admin-list"></div>
        </div>

      </div>

      <div class="card" style="margin-top:12px">
        <div style="font-weight:800">Catatan</div>
        <div class="small" style="margin-top:8px">
          - Semua transaksi diproses cepat <code>dan</code> Jika Mengalami Pending Silahkan Chat CS<br>
          - jika sudah deposit segera selesaikan pembayaran dan melakukan refresh halaman
        </div>
      </div>
    </aside>
  </div>
  </div>

  <!-- libs -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

<script>
/* ========== CONFIG ========== */
const firebaseConfig = {
  apiKey: "AIzaSyDVUEZ3ZVmH4ld7LVnEq_L368wEJpEs-l8",
  authDomain: "zeepaylater-93a94.firebaseapp.com",
  projectId: "zeepaylater-93a94",
  storageBucket: "zeepaylater-93a94.appspot.com",
  messagingSenderId: "358065954807",
  appId: "1:358065954807:web:66619211fea82a4b2518f2"
};
// ganti ADMIN_UID kalau perlu
const ADMIN_UID = 'viCOsJo4wHVFmhtpmMx1Wd4sDF52';
/* ================================= */
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

/* ====== DOM refs ====== */
const btnShowDeposit = document.getElementById('btnShowDeposit');
const btnShowWithdraw = document.getElementById('btnShowWithdraw');
const depositPanel = document.getElementById('depositPanel');
const withdrawPanel = document.getElementById('withdrawPanel');

const nominalEl = document.getElementById('nominal');
const generateBtn = document.getElementById('generateBtn');
const saveRequestBtn = document.getElementById('saveRequestBtn');
const breakdownEl = document.getElementById('breakdown');
const qArea = document.getElementById('qArea');
const qWrap = document.getElementById('qWrap');
const finalPayloadEl = document.getElementById('finalPayload');
const copyPayloadBtn = document.getElementById('copyPayload');
const downloadQRBtn = document.getElementById('downloadQR');

const withdrawAmount = document.getElementById('withdrawAmount');
const bankName = document.getElementById('bankName');
const bankAccount = document.getElementById('bankAccount');
const bankHolder = document.getElementById('bankHolder');
const submitWithdraw = document.getElementById('submitWithdraw');
const cancelWithdraw = document.getElementById('cancelWithdraw');

const uidField = document.getElementById('uid');
const uidInfo = document.getElementById('uidInfo');
const emailField = document.getElementById('email');
const nameField = document.getElementById('fullname');
const phoneField = document.getElementById('phone');
const balField = document.getElementById('bal');
const createdAt = document.getElementById('createdAt');
const accountBalance = document.getElementById('accountBalance');

const historyAll = document.getElementById('historyAll');
const historyDeposit = document.getElementById('historyOnlyDeposit');
const historyWithdraw = document.getElementById('historyOnlyWithdraw');
const tabAll = document.getElementById('tabAll');
const tabDep = document.getElementById('tabDeposit');
const tabWdr = document.getElementById('tabWithdraw');

const refreshBtn = document.getElementById('refreshBtn');
const signoutBtn = document.getElementById('signoutBtn');

const adminPanel = document.getElementById('adminPanel');
const adminUidFilter = document.getElementById('adminUidFilter');
const adminRefresh = document.getElementById('adminRefresh');
const adminList = document.getElementById('adminList');
const exportCsvBtn = document.getElementById('exportCsv');

/* ====== helpers ====== */
function formatRp(n){ return Number(n).toLocaleString('id-ID'); }

/* QR helpers (same as sebelumnya) */
function parseTLV(s){
  let i=0, out=[];
  while(i<s.length){
    const tag = s.substr(i,2); i+=2;
    const len = parseInt(s.substr(i,2),10); i+=2;
    const value = s.substr(i, len);
    i += len;
    out.push({tag, len, value});
  }
  return out;
}
function buildTLV(arr){
  return arr.map(o=>{
    const v = o.value;
    const l = String(v.length).padStart(2,'0');
    return o.tag + l + v;
  }).join('');
}
function crc16ccitt(str){
  let crc = 0xFFFF;
  for(let i=0;i<str.length;i++){
    crc ^= (str.charCodeAt(i) & 0xFF) << 8;
    for(let j=0;j<8;j++){
      if((crc & 0x8000) !== 0) crc = ((crc << 1) ^ 0x1021) & 0xFFFF;
      else crc = (crc << 1) & 0xFFFF;
    }
  }
  return crc & 0xFFFF;
}
function setAmountInPayloadCore(corePayload, amountStr){
  try{
    const parsed = parseTLV(corePayload);
    const filtered = parsed.filter(o=>o.tag !== '54');
    const idx58 = filtered.findIndex(o=>o.tag === '58');
    if(idx58 >= 0) filtered.splice(idx58,0,{tag:'54', value:amountStr});
    else filtered.push({tag:'54', value:amountStr});
    return buildTLV(filtered);
  }catch(e){
    return corePayload + ('54' + String(amountStr.length).padStart(2,'0') + amountStr);
  }
}

/* ====== app state ====== */
let currentUser = null;
let lastGenerated = null;
let lastQRElement = null;
let requestsUnsub = null;
let userDocUnsub = null;
let adminRequestsUnsub = null;
const defaultCorePayload = "00020101021126610014COM.GO-JEK.WWW01189360091433055874630210G3055874630303UMI51440014ID.CO.QRIS.WWW0215ID10254231099470303UMI5204481453033605802ID5925ZkgamingstoreGoTo, Toko H6007TANGSEL61051522062070703A016304";

/* ====== UI behaviors ====== */
function showDeposit(){ depositPanel.style.display=''; withdrawPanel.style.display='none'; btnShowDeposit.classList.add('btn'); btnShowDeposit.classList.remove('ghost'); btnShowWithdraw.classList.add('ghost'); btnShowWithdraw.classList.remove('btn'); }
function showWithdraw(){ withdrawPanel.style.display=''; depositPanel.style.display='none'; btnShowWithdraw.classList.add('btn'); btnShowWithdraw.classList.remove('ghost'); btnShowDeposit.classList.add('ghost'); btnShowDeposit.classList.remove('btn'); }
btnShowDeposit.addEventListener('click', showDeposit);
btnShowWithdraw.addEventListener('click', showWithdraw);

/* QR responsive */
function getQRSize(){ const cw = qWrap.clientWidth || 260; return Math.max(140, Math.min(420, Math.floor(cw - 24))); }
function calcFees(nominal){ const feeQris = Math.round(nominal * 0.008); const qrisTotal = nominal + feeQris + 8500; return { feeQris, qrisTotal }; }

function generateAndShow(){
  const nominal = Number(nominalEl.value || 0);
  if(!nominal || nominal < 1000) return alert('Minimal Rp 1.000');
  const { feeQris, qrisTotal } = calcFees(nominal);
  const amountStr = (Number(qrisTotal).toFixed(2)).toString();
  let base = defaultCorePayload;
  if(base.slice(-8,-4) === '6304') base = base.slice(0,-8);
  const core = setAmountInPayloadCore(base, amountStr);
  const with6304 = core + '6304';
  const crc = crc16ccitt(with6304);
  const crcHex = crc.toString(16).toUpperCase().padStart(4,'0');
  const finalPayload = with6304 + crcHex;
  lastGenerated = { finalPayload, amountShown: amountStr, total: qrisTotal };

  breakdownEl.innerHTML = `<strong>QRIS</strong><br>
    Nominal: Rp ${formatRp(nominal)}<br>
    Fee 0.8%: Rp ${formatRp(feeQris)} + biaya tetap Rp 8500<br>
    Total ditagihkan: Rp ${formatRp(qrisTotal)} (QR: ${amountStr})`;

  qArea.style.display = '';
  qWrap.innerHTML = '';
  const size = getQRSize();
  new QRCode(qWrap, { text: finalPayload, width: size, height: size, correctLevel: QRCode.CorrectLevel.H });
  lastQRElement = qWrap.querySelector('canvas') || qWrap.querySelector('img');
  finalPayloadEl.textContent = finalPayload;
}
generateBtn.addEventListener('click', generateAndShow);
window.addEventListener('resize', ()=>{ if(lastGenerated) generateAndShow(); });

copyPayloadBtn.addEventListener('click', ()=>{ if(!lastGenerated) return alert('Belum ada payload'); navigator.clipboard.writeText(lastGenerated.finalPayload).then(()=> alert('Payload disalin ke clipboard')); });
downloadQRBtn.addEventListener('click', ()=>{ if(!lastQRElement) return alert('QR belum siap'); if(lastQRElement.tagName === 'IMG'){ const a=document.createElement('a'); a.href=lastQRElement.src; a.download='qris.png'; a.click(); return;} try{ const url=lastQRElement.toDataURL('image/png'); const a=document.createElement('a'); a.href=url; a.download='qris.png'; a.click(); }catch(e){ alert('Gagal download: '+e); } });

/* ====== Save deposit request (lengkap) ====== */
saveRequestBtn.addEventListener('click', async ()=>{
  if(!currentUser) return alert('Belum login');
  if(!lastGenerated) return alert('Klik Top Up Terlebih Dahulu Untuk Memunculkan QRIS');
  const nominal = Number(nominalEl.value || 0);
  if(!nominal || nominal < 1000) return alert('Minimal Rp 1.000');
  const doc = {
    uid: currentUser.uid,
    email: currentUser.email || null,
    name: currentUser.displayName || null,
    type: 'deposit',
    nominal: nominal,
    totalPay: lastGenerated.total || nominal,
    method: 'qris',
    payload: lastGenerated.finalPayload,
    status: 'pending',
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  };
  try{
    const ref = await db.collection('requests').add(doc);
    console.log('DEBUG: deposit request Diproses id=', ref.id);
    alert('Request deposit menunggu Validasi (id: ' + ref.id + '). Tunggu Sampai Saldo Bertambah.');
  }catch(e){
    console.error('ERROR save deposit request', e);
    alert('Gagal menyimpan request: ' + e);
  }
});

/* ====== Withdraw handling (lengkap) ====== */
submitWithdraw.addEventListener('click', async ()=>{
  if(!currentUser) return alert('Belum login');
  const amt = Number(withdrawAmount.value || 0);
  if(!amt || amt < 350000) return alert('Minimal penarikan Rp 350.000');
  if(!bankName.value || !bankAccount.value || !bankHolder.value) return alert('Lengkapi info bank');
  const req = {
    uid: currentUser.uid,
    email: currentUser.email || null,
    name: currentUser.displayName || null,
    type: 'withdraw',
    nominal: amt,
    bankName: bankName.value,
    bankAccount: bankAccount.value,
    bankHolder: bankHolder.value,
    status: 'pending',
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  };
  try{
    const ref = await db.collection('requests').add(req);
    console.log('DEBUG: withdraw request Disimpan id=', ref.id);
    alert('Request penarikan dibuat. Tunggu Sampai Saldo Diproses.');
    withdrawAmount.value = 50000; bankName.value=''; bankAccount.value=''; bankHolder.value='';
    showDeposit();
  }catch(e){ console.error('ERROR save withdraw', e); alert('Gagal membuat request: ' + e); }
});
cancelWithdraw.addEventListener('click', showDeposit);

/* ====== Tabs ====== */
tabAll.addEventListener('click', ()=>{ historyAll.style.display='block'; historyDeposit.style.display='none'; historyWithdraw.style.display='none'; tabAll.classList.add('btn'); tabDep.classList.add('ghost'); tabWdr.classList.add('ghost'); });
tabDep.addEventListener('click', ()=>{ historyAll.style.display='none'; historyDeposit.style.display='block'; historyWithdraw.style.display='none'; tabDep.classList.add('btn'); tabAll.classList.add('ghost'); tabWdr.classList.add('ghost'); });
tabWdr.addEventListener('click', ()=>{ historyAll.style.display='none'; historyDeposit.style.display='none'; historyWithdraw.style.display='block'; tabWdr.classList.add('btn'); tabDep.classList.add('ghost'); tabAll.classList.add('ghost'); });

/* ====== Render helpers ====== */
function renderRequestItem(r, id){
  const status = r.status || 'pending';
  const cls = status === 'confirmed' ? 'confirmed' : status === 'rejected' ? 'rejected' : 'pending';
  const div = document.createElement('div'); div.className = 'hist-item';
  const left = document.createElement('div'); left.className = 'hist-left';
  const right = document.createElement('div'); right.className = 'hist-right';
  const when = r.createdAt && r.createdAt.toDate ? r.createdAt.toDate().toLocaleString() : (r.createdAt || '-');

  if(r.type === 'deposit'){
    left.innerHTML = `<div style="font-weight:700">DEPOSIT • Rp ${Number(r.totalPay || r.nominal || 0).toLocaleString()}</div>
      <div class="small">${r.method || 'qris'} • ${when}</div>
      <div class="small">UID: ${r.uid || '-'} • ${r.email || '-'}</div>
      <div class="small">id: ${id}</div>`;
  } else if(r.type === 'withdraw'){
    left.innerHTML = `<div style="font-weight:700">PENARIKAN • Rp ${Number(r.nominal||0).toLocaleString()}</div>
      <div class="small">${r.bankName || '-'} • ${r.bankAccount || '-'}</div>
      <div class="small">Atas nama: ${r.bankHolder || '-'}</div>
      <div class="small">${when}</div>
      <div class="small">UID: ${r.uid || '-'} • ${r.email || '-'}</div>
      <div class="small">id: ${id}</div>`;
  } else {
    left.innerHTML = `<div style="font-weight:700">${(r.type||'').toUpperCase()} • Rp ${Number(r.nominal||r.totalPay||0).toLocaleString()}</div>
      <div class="small">${when}</div><div class="small">id: ${id}</div>`;
  }

  right.innerHTML = `<div><span class="badge ${cls}">${status}</span></div>`;
  div.appendChild(left); div.appendChild(right);
  return div;
}

/* ====== Robust subscriptions + fallbacks ====== */
function clearHistories(){ historyAll.innerHTML=''; historyDeposit.innerHTML=''; historyWithdraw.innerHTML=''; }
function simpleRenderRequests(docs){
  clearHistories();
  docs.forEach(item=>{
    const node = renderRequestItem(item.data, item.id);
    historyAll.appendChild(node.cloneNode(true));
    if(item.data.type === 'deposit') historyDeposit.appendChild(node.cloneNode(true));
    if(item.data.type === 'withdraw') historyWithdraw.appendChild(node.cloneNode(true));
  });
}

function subscribeUserRequests(uid){
  console.log('DEBUG: subscribeUserRequests', uid);
  if(requestsUnsub){ try{ requestsUnsub(); }catch(e){console.warn('unsubscribe err',e);} requestsUnsub = null; }
  try{
    const q = db.collection('requests').where('uid','==',uid).orderBy('createdAt','desc');
    requestsUnsub = q.onSnapshot(snap=>{
      console.log('DEBUG user onSnapshot size=', snap.size);
      const docs=[];
      snap.forEach(doc=>docs.push({id: doc.id, data: doc.data()}));
      if(docs.length===0) historyAll.innerHTML='<div class="small" style="padding:8px">Belum ada request untuk akun ini.</div>';
      simpleRenderRequests(docs);
    }, err=>{
      console.error('DEBUG user onSnapshot err', err);
      fallbackFetchRequestsForUid(uid);
    });
  }catch(e){
    console.error('DEBUG subscribeUserRequests exception', e);
    fallbackFetchRequestsForUid(uid);
  }
}

function fallbackFetchRequestsForUid(uid){
  console.log('DEBUG: fallbackFetchRequestsForUid', uid);
  clearHistories();
  db.collection('requests').where('uid','==',uid).orderBy('createdAt','desc').limit(500).get()
    .then(snap=>{
      console.log('DEBUG fallback get size=', snap.size);
      const docs=[];
      snap.forEach(doc=>docs.push({id: doc.id, data: doc.data()}));
      if(docs.length===0){
        // try global
        fallbackFetchAllRequests();
      } else simpleRenderRequests(docs);
    })
    .catch(err=>{
      console.error('DEBUG fallback get err', err);
      fallbackFetchAllRequests();
    });
}

function fallbackFetchAllRequests(){
  console.log('DEBUG: fallbackFetchAllRequests');
  db.collection('requests').orderBy('createdAt','desc').limit(500).get()
    .then(snap=>{
      console.log('DEBUG fallback all size=', snap.size);
      const docs=[];
      snap.forEach(doc=>docs.push({id: doc.id, data: doc.data()}));
      if(docs.length===0) historyAll.innerHTML='<div class="small" style="padding:8px">Tidak ada data transaksi atau tidak bisa diakses (cek rules).</div>';
      else simpleRenderRequests(docs);
    })
    .catch(err=>{
      console.error('DEBUG fallback all err', err);
      db.collection('requests').limit(500).get().then(snap2=>{
        const docs=[];
        snap2.forEach(doc=>docs.push({id: doc.id, data: doc.data()}));
        if(docs.length===0) historyAll.innerHTML='<div class="small" style="padding:8px">Tidak ada data transaksi (final fallback).</div>';
        else simpleRenderRequests(docs);
      }).catch(e2=>{
        console.error('DEBUG final fallback err', e2);
        historyAll.innerHTML='<div class="small" style="padding:8px">Gagal fetch requests: lihat console.</div>';
      });
    });
}

/* ====== Admin subscription (lihat semua, proses) ====== */
function subscribeAdminAll(uidFilter){
  console.log('DEBUG: subscribeAdminAll filter=', uidFilter);
  if(adminRequestsUnsub){ try{ adminRequestsUnsub(); }catch(e){console.warn('admin unsubscribe err',e);} adminRequestsUnsub=null; }
  try{
    let q = db.collection('requests').orderBy('createdAt','desc').limit(500);
    if(uidFilter && uidFilter.trim()) q = db.collection('requests').where('uid','==',uidFilter.trim()).orderBy('createdAt','desc').limit(500);
    adminRequestsUnsub = q.onSnapshot(snap=>{
      console.log('DEBUG admin onSnapshot size=', snap.size);
      adminList.innerHTML = '';
      if(snap.empty){ adminList.innerHTML = '<div class="small" style="padding:8px">Tidak ada request.</div>'; return; }
      snap.forEach(doc=>{
        const r = doc.data(); const id = doc.id;
        const el = document.createElement('div'); el.className = 'admin-item';
        const left = document.createElement('div'); left.style.flex='1';
        const right = document.createElement('div'); right.style.minWidth='180px'; right.style.textAlign='right';
        const when = r.createdAt && r.createdAt.toDate ? r.createdAt.toDate().toLocaleString() : '-';
        left.innerHTML = `<div style="font-weight:700">${r.type==='withdraw'?'PENARIKAN':'DEPOSIT'} • Rp ${Number(r.type==='withdraw'?r.nominal:r.totalPay||r.nominal||0).toLocaleString()}</div>
          <div class="small">${r.type==='withdraw'? (r.bankName+' • '+r.bankAccount) : (r.method||'')}</div>
          <div class="small">UID: ${r.uid || '-'} • ${r.email || '-'}</div>
          <div class="small">id: ${id}</div>
          <div class="small">${when}</div>`;
        right.innerHTML = `<div class="small">Status: <strong>${r.status||'pending'}</strong></div>
          <div style="display:flex;gap:6px;justify-content:flex-end;margin-top:6px">
            <button class="btn ghost" data-id="${id}" onclick="copyAdminItem(event)">Copy</button>
            <button class="btn" data-id="${id}" onclick="adminApprove(event)">Approve</button>
            <button class="btn ghost" data-id="${id}" onclick="adminReject(event)">Reject</button>
          </div>`;
        el.appendChild(left); el.appendChild(right);
        adminList.appendChild(el);
      });
    }, err=>{
      console.error('DEBUG admin onSnapshot err', err);
      adminList.innerHTML = '<div class="small" style="padding:8px">Gagal subscribe admin: lihat console</div>';
    });
  }catch(e){
    console.error('DEBUG subscribeAdminAll exception', e);
    adminList.innerHTML = '<div class="small" style="padding:8px">Gagal subscribe admin: lihat console</div>';
  }
}

/* admin helpers: copy & process */
window.copyAdminItem = function(e){
  const id = e.currentTarget.getAttribute('data-id');
  const el = e.currentTarget.closest('.admin-item');
  if(!el) return;
  navigator.clipboard.writeText(el.innerText.replace(/\n+/g,'\n')).then(()=> alert('Info disalin'));
};

window.adminApprove = async function(e){
  const id = e.currentTarget.getAttribute('data-id');
  if(!confirm('Yakin approve request id: ' + id + ' ?')) return;
  try{
    await db.collection('requests').doc(id).update({ status: 'confirmed', processedBy: currentUser.uid, processedAt: firebase.firestore.FieldValue.serverTimestamp(), note: 'approved by admin' });
    alert('Request approved.');
  }catch(err){ console.error('approve err', err); alert('Gagal approve: '+err); }
};

window.adminReject = async function(e){
  const id = e.currentTarget.getAttribute('data-id');
  const reason = prompt('Alasan reject (opsional):','');
  if(!confirm('Yakin reject request id: ' + id + ' ?')) return;
  try{
    await db.collection('requests').doc(id).update({ status: 'rejected', processedBy: currentUser.uid, processedAt: firebase.firestore.FieldValue.serverTimestamp(), note: reason || 'rejected by admin' });
    alert('Request rejected.');
  }catch(err){ console.error('reject err', err); alert('Gagal reject: '+err); }
};

/* export CSV (admin) */
exportCsvBtn.addEventListener('click', async ()=>{
  const uidFilter = adminUidFilter.value && adminUidFilter.value.trim();
  try{
    let q = db.collection('requests').orderBy('createdAt','desc').limit(1000);
    if(uidFilter) q = db.collection('requests').where('uid','==', uidFilter).orderBy('createdAt','desc').limit(1000);
    const snap = await q.get();
    if(snap.empty) return alert('Tidak ada data untuk diexport.');
    const rows = [];
    snap.forEach(doc=>{
      const d = doc.data();
      rows.push({
        id: doc.id,
        uid: d.uid || '',
        email: d.email || '',
        name: d.name || '',
        type: d.type || '',
        nominal: d.nominal || '',
        totalPay: d.totalPay || '',
        method: d.method || '',
        bankName: d.bankName || '',
        bankAccount: d.bankAccount || '',
        bankHolder: d.bankHolder || '',
        status: d.status || '',
        note: d.note || '',
        createdAt: d.createdAt && d.createdAt.toDate ? d.createdAt.toDate().toISOString() : ''
      });
    });
    // build CSV
    const headers = Object.keys(rows[0]);
    const csv = [headers.join(',')].concat(rows.map(r=>headers.map(h=>`"${String(r[h]||'').replace(/"/g,'""')}"`).join(','))).join('\n');
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'requests_export.csv'; a.click();
    URL.revokeObjectURL(url);
  }catch(e){ console.error('export csv err', e); alert('Gagal export: '+e); }
});

/* ====== Auth & subscriptions ====== */
auth.onAuthStateChanged(async user=>{
  if(user){
    currentUser = user;
    uidField.textContent = user.uid;
    uidInfo.textContent = 'UID: ' + user.uid;
    emailField.textContent = user.email || '-';
    // ensure user doc exists
    const uref = db.collection('users').doc(user.uid);
    const udoc = await uref.get();
    if(!udoc.exists) await uref.set({ createdAt: firebase.firestore.FieldValue.serverTimestamp(), balance: 0 });
    subscribeUserRequests(user.uid);
    subscribeUserDoc(user.uid);
    showDeposit();

    // admin view
    if(user.uid === ADMIN_UID){
      adminPanel.style.display = '';
      subscribeAdminAll('');
    } else {
      adminPanel.style.display = 'none';
      if(adminRequestsUnsub){ try{ adminRequestsUnsub(); }catch(e){} adminRequestsUnsub = null; }
    }
  } else {
    // sign in anonymously
    auth.signInAnonymously().catch(e=>console.error('auth anon err', e));
  }
});

function subscribeUserDoc(uid){
  if(userDocUnsub) try{ userDocUnsub(); }catch(e){ }
  userDocUnsub = db.collection('users').doc(uid).onSnapshot(doc=>{
    if(!doc.exists) return;
    const d = doc.data();
    nameField.textContent = d.name || '-';
    phoneField.textContent = d.phone || '-';
    balField.textContent = 'Rp ' + (d.balance ? Number(d.balance).toLocaleString() : '0');
    createdAt.textContent = d.createdAt && d.createdAt.toDate ? d.createdAt.toDate().toLocaleDateString() : '-';
    accountBalance.textContent = 'Saldo: ' + (d.balance ? 'Rp ' + Number(d.balance).toLocaleString() : 'Rp 0');
  }, err=>console.error('userDoc sub err', err));
}

/* refresh & signout */
refreshBtn.addEventListener('click', ()=>{ if(currentUser) subscribeUserRequests(currentUser.uid); });
signoutBtn.addEventListener('click', ()=>{ auth.signOut().then(()=>alert('Signed out')).catch(e=>alert('Sign out error: '+e)); });

/* admin refresh */
adminRefresh.addEventListener('click', ()=>{ const uid = adminUidFilter.value || ''; subscribeAdminAll(uid); });

/* UX start */
showDeposit();

</script>
</body>
</html>
